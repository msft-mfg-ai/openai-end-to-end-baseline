{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.34.44.8038",
      "templateHash": "17581199008541380183"
    }
  },
  "parameters": {
    "applicationName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Full Application Name (supply this or use default of prefix+token)"
      }
    },
    "applicationPrefix": {
      "type": "string",
      "defaultValue": "ai_doc",
      "metadata": {
        "description": "If you do not supply Application Name, this prefix will be combined with a token to create a unique applicationName"
      }
    },
    "environmentName": {
      "type": "string",
      "defaultValue": "dev",
      "metadata": {
        "description": "The environment code (i.e. dev, qa, prod)"
      }
    },
    "azdEnvName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Environment name used by the azd command (optional)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Primary location for all resources"
      }
    },
    "openAI_deploy_location": {
      "type": "string",
      "defaultValue": "[parameters('location')]",
      "metadata": {
        "description": "OAI Region availability: East US, East US2, North Central US, South Central US, Sweden Central, West US, and West US3"
      }
    },
    "myIpAddress": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "My IP address for network access"
      }
    },
    "principalId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Id of the user executing the deployment"
      }
    },
    "existingVnetName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "If you provide this is will be used instead of creating a new VNET"
      }
    },
    "existingVnetResourceGroupName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "If you provide an existing VNET what resource group is it in?"
      }
    },
    "vnetPrefix": {
      "type": "string",
      "defaultValue": "10.183.4.0/22",
      "metadata": {
        "description": "If you provide this is will be used instead of creating a new VNET"
      }
    },
    "subnetAppGwName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "If new VNET, this is the Subnet name for the private endpoints"
      }
    },
    "subnetAppGwPrefix": {
      "type": "string",
      "defaultValue": "10.183.5.0/24"
    },
    "subnetAppSeName": {
      "type": "string",
      "defaultValue": ""
    },
    "subnetAppSePrefix": {
      "type": "string",
      "defaultValue": "10.183.4.0/24"
    },
    "subnetPeName": {
      "type": "string",
      "defaultValue": ""
    },
    "subnetPePrefix": {
      "type": "string",
      "defaultValue": "10.183.6.0/27"
    },
    "subnetAgentName": {
      "type": "string",
      "defaultValue": ""
    },
    "subnetAgentPrefix": {
      "type": "string",
      "defaultValue": "10.183.6.32/27"
    },
    "subnetBastionName": {
      "type": "string",
      "defaultValue": ""
    },
    "subnetBastionPrefix": {
      "type": "string",
      "defaultValue": "10.183.6.64/26"
    },
    "subnetJumpboxName": {
      "type": "string",
      "defaultValue": ""
    },
    "subnetJumpboxPrefix": {
      "type": "string",
      "defaultValue": "10.183.6.128/28"
    },
    "subnetTrainingName": {
      "type": "string",
      "defaultValue": ""
    },
    "subnetTrainingPrefix": {
      "type": "string",
      "defaultValue": "10.183.7.0/25"
    },
    "subnetScoringName": {
      "type": "string",
      "defaultValue": ""
    },
    "subnetScoringPrefix": {
      "type": "string",
      "defaultValue": "10.183.7.128/25"
    },
    "admin_username": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Admin username for the VM (optional - only deploy VM if provided)"
      }
    },
    "admin_password": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Admin password for the VM (optional - only deploy VM if provided)"
      }
    },
    "vm_name": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "VM name (optional - only deploy VM if provided)"
      }
    },
    "existing_ACR_Name": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "If you provide this is will be used instead of creating a new Registry"
      }
    },
    "existing_ACR_ResourceGroupName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "If you provide this is will be used instead of creating a new Registry"
      }
    },
    "existing_LogAnalytics_Name": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "If you provide this is will be used instead of creating a new Workspace"
      }
    },
    "existing_AppInsights_Name": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "If you provide this is will be used instead of creating a new App Insights"
      }
    },
    "existing_managedAppEnv_Name": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "If you provide this is will be used instead of creating a new Container App Environment"
      }
    },
    "appContainerAppEnvironmentWorkloadProfileName": {
      "type": "string",
      "defaultValue": "app",
      "metadata": {
        "description": "Name of the Container Apps Environment workload profile to use for the app"
      }
    },
    "containerAppEnvironmentWorkloadProfiles": {
      "type": "array",
      "defaultValue": [
        {
          "name": "app",
          "workloadProfileType": "D4",
          "minimumCount": 1,
          "maximumCount": 10
        }
      ],
      "metadata": {
        "description": "Workload profiles for the Container Apps environment"
      }
    },
    "existing_CogServices_Name": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name of an existing Cognitive Services account to use"
      }
    },
    "existing_SearchService_Name": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name of an existing Search Services account to use"
      }
    },
    "existing_SearchService_ResourceGroupName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Resource Group where existing Search Services account Lives"
      }
    },
    "aiProjectFriendlyName": {
      "type": "string",
      "defaultValue": "Agents Project resource",
      "metadata": {
        "description": "Friendly name for your Azure AI resource"
      }
    },
    "aiProjectDescription": {
      "type": "string",
      "defaultValue": "This is an example AI Project resource for use in Azure AI Studio.",
      "metadata": {
        "description": "Description of your Azure AI resource displayed in AI studio"
      }
    },
    "existing_Cosmos_Name": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name of an existing Cosmos account to use"
      }
    },
    "existing_Cosmos_ResourceGroupName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Resource Group where existing Cosmos account Lives"
      }
    },
    "deployAIHub": {
      "type": "bool",
      "metadata": {
        "description": "Should we deploy an AI Foundry Hub?"
      }
    },
    "apiImageName": {
      "type": "string",
      "defaultValue": ""
    },
    "batchImageName": {
      "type": "string",
      "defaultValue": ""
    },
    "publicAccessEnabled": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Should resources be created with public access?"
      }
    },
    "createDnsZones": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Create DNS Zones?"
      }
    },
    "addRoleAssignments": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Add Role Assignments for the user assigned identity?"
      }
    },
    "deduplicateKeyVaultSecrets": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Should we run a script to dedupe the KeyVault secrets? (this fails on private networks right now)"
      }
    },
    "appendResourceTokens": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Set this if you want to append all the resource names with a unique token"
      }
    },
    "deployAPIApp": {
      "type": "bool",
      "metadata": {
        "description": "Should API container app be deployed?"
      }
    },
    "deployBatchApp": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Should Batch container app be deployed?"
      }
    },
    "regionCode": {
      "type": "string",
      "metadata": {
        "description": "Global Region where the resources will be deployed, e.g. AM (America), EM (EMEA), AP (APAC), CH (China)"
      }
    },
    "instanceNumber": {
      "type": "string",
      "defaultValue": "001",
      "metadata": {
        "description": "Instance number for the application, e.g. 001, 002, etc. This is used to differentiate multiple instances of the same application in the same environment."
      }
    },
    "costCenterTag": {
      "type": "string",
      "defaultValue": ""
    },
    "ownerEmailTag": {
      "type": "string",
      "defaultValue": ""
    },
    "requestorName": {
      "type": "string",
      "defaultValue": "UNKNOWN"
    },
    "applicationId": {
      "type": "string",
      "defaultValue": ""
    },
    "primarySupportProviderTag": {
      "type": "string",
      "defaultValue": ""
    },
    "runDateTime": {
      "type": "string",
      "defaultValue": "[utcNow()]"
    }
  },
  "variables": {
    "resourceToken": "[toLower(uniqueString(resourceGroup().id, parameters('location')))]",
    "resourceGroupName": "[resourceGroup().name]",
    "appName": "[if(not(equals(parameters('applicationName'), '')), parameters('applicationName'), format('{0}_{1}', parameters('applicationPrefix'), variables('resourceToken')))]",
    "deploymentSuffix": "[format('-{0}', parameters('runDateTime'))]",
    "azdTag": "[if(not(equals(parameters('azdEnvName'), '')), createObject('azd-env-name', parameters('azdEnvName')), createObject())]",
    "commonTags": {
      "creation-date": "[take(parameters('runDateTime'), 8)]",
      "application-name": "[variables('appName')]",
      "application-id": "[parameters('applicationId')]",
      "environment-name": "[parameters('environmentName')]",
      "global-region": "[parameters('regionCode')]",
      "requestor-name": "[parameters('requestorName')]",
      "primary-support-provider": "[if(equals(parameters('primarySupportProviderTag'), ''), 'UNKNOWN', parameters('primarySupportProviderTag'))]"
    },
    "costCenterTagObject": "[if(equals(parameters('costCenterTag'), ''), createObject(), createObject('cost-center', parameters('costCenterTag')))]",
    "ownerEmailTagObject": "[if(equals(parameters('ownerEmailTag'), ''), createObject(), createObject('application-owner', parameters('ownerEmailTag'), 'business-owner', parameters('ownerEmailTag'), 'point-of-contact', parameters('ownerEmailTag')))]",
    "tags": "[union(variables('commonTags'), variables('azdTag'), variables('costCenterTagObject'), variables('ownerEmailTagObject'))]",
    "deduplicateKVSecrets": "[if(parameters('publicAccessEnabled'), parameters('deduplicateKeyVaultSecrets'), false())]",
    "vnetAddressPrefix": "[parameters('vnetPrefix')]",
    "apiKeyValue": "[uniqueString(resourceGroup().id, parameters('location'), 'api-key', parameters('runDateTime'))]",
    "uiDatabaseName": "ChatHistory",
    "uiChatContainerName": "ChatTurn",
    "cosmosContainerArray": [
      {
        "name": "AgentLog",
        "partitionKey": "/requestId"
      },
      {
        "name": "UserDocuments",
        "partitionKey": "/userId"
      },
      {
        "name": "[variables('uiChatContainerName')]",
        "partitionKey": "/chatId"
      }
    ],
    "apiTargetPort": 8080,
    "batchTargetPort": 8080
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('resource-names{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "applicationName": {
            "value": "[variables('appName')]"
          },
          "environmentName": {
            "value": "[parameters('environmentName')]"
          },
          "resourceToken": "[if(parameters('appendResourceTokens'), createObject('value', variables('resourceToken')), createObject('value', ''))]",
          "regionCode": {
            "value": "[parameters('regionCode')]"
          },
          "instance": {
            "value": "[parameters('instanceNumber')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "10729915144755246617"
            }
          },
          "parameters": {
            "applicationName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Application name unique to this application, typically 5-8 characters."
              }
            },
            "environmentName": {
              "type": "string",
              "defaultValue": "dev",
              "metadata": {
                "description": "Environment name for the application, e.g. azd, dev, demo, qa, stg, ct, prod. This is used to differentiate resources in different environments."
              }
            },
            "regionCode": {
              "type": "string",
              "defaultValue": "AM",
              "allowedValues": [
                "AM",
                "EM",
                "AP",
                "CH"
              ],
              "metadata": {
                "description": "Global Region where the resources will be deployed, e.g. AM (America), EM (EMEA), AP (APAC), CH (China)"
              }
            },
            "instance": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Instance number for the application, e.g. 001, 002, etc. This is used to differentiate multiple instances of the same application in the same environment."
              }
            },
            "resourceToken": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional resource token to ensure uniqueness - leave blank if desired"
              }
            }
          },
          "variables": {
            "$fxv#0": {
              "analysisServicesServers": "as",
              "apiManagementService": "apim",
              "apiManagementService-prefix": "apim-",
              "appConfigurationConfigurationStores": "appcs",
              "appConfigurationConfigurationStores-prefix": "appcs-",
              "appManagedEnvironments": "cae",
              "appManagedEnvironments-prefix": "cae-",
              "appRegistration": "appreg",
              "appRegistration-prefix": "appreg-",
              "appContainerApps": "ca",
              "appContainerApps-prefix": "ca-",
              "authorizationPolicyDefinitions": "policy-",
              "automationAutomationAccounts": "aa-",
              "blueprintBlueprints": "bp-",
              "blueprintBlueprintsArtifacts": "bpa-",
              "cacheRedis": "redis-",
              "cdnProfiles": "cdnp-",
              "cdnProfilesEndpoints": "cdne-",
              "cognitiveServicesAccounts": "cog",
              "cognitiveServicesAccounts-prefix": "cog-",
              "cognitiveServicesFormRecognizer": "cog-fr-",
              "cognitiveServicesHub": "hub",
              "cognitiveServicesTextAnalytics": "cog-ta-",
              "computeAvailabilitySets": "avail-",
              "computeCloudServices": "cld-",
              "computeDiskEncryptionSets": "des",
              "computeDisks": "disk",
              "computeDisksOs": "osdisk",
              "computeGalleries": "gal",
              "computeSnapshots": "snap-",
              "computeVirtualMachines": "vm",
              "computeVirtualMachineScaleSets": "vmss-",
              "containerInstanceContainerGroups": "ci",
              "containerRegistryRegistries": "cr",
              "containerServiceManagedClusters": "aks-",
              "databricksWorkspaces": "dbw-",
              "dataFactoryFactories": "adf-",
              "dataLakeAnalyticsAccounts": "dla",
              "dataLakeStoreAccounts": "dls",
              "dataMigrationServices": "dms-",
              "dBforMySQLServers": "mysql-",
              "dBforPostgreSQLServers": "psql-",
              "devicesIotHubs": "iot-",
              "devicesProvisioningServices": "provs-",
              "devicesProvisioningServicesCertificates": "pcert-",
              "documentDBDatabaseAccounts": "cosmos",
              "documentDBDatabaseAccounts-prefix": "cosmos-",
              "eventGridDomains": "evgd-",
              "eventGridDomainsTopics": "evgt-",
              "eventGridEventSubscriptions": "evgs-",
              "eventGridSystemTopic": "evgst-",
              "eventHubNamespaces": "evhns-",
              "eventHubNamespacesEventHubs": "evh-",
              "hdInsightClustersHadoop": "hadoop-",
              "hdInsightClustersHbase": "hbase-",
              "hdInsightClustersKafka": "kafka-",
              "hdInsightClustersMl": "mls-",
              "hdInsightClustersSpark": "spark-",
              "hdInsightClustersStorm": "storm-",
              "hybridComputeMachines": "arcs-",
              "insightsActionGroups": "ag-",
              "insightsComponents": "appi",
              "insightsComponents-prefix": "appi-",
              "keyVaultVaults": "kv",
              "keyVaultVaults-prefix": "kv-",
              "kubernetesConnectedClusters": "arck",
              "kustoClusters": "dec",
              "kustoClustersDatabases": "dedb",
              "logicIntegrationAccounts": "ia",
              "logicIntegrationAccounts-prefix": "ia-",
              "logicWorkflows": "logic",
              "logicWorkflows-prefix": "logic-",
              "machineLearningServicesWorkspaces": "mlw-",
              "managedIdentityUserAssignedIdentities": "id",
              "managedIdentityUserAssignedIdentities-prefix": "id-",
              "managementManagementGroups": "mg-",
              "migrateAssessmentProjects": "migr-",
              "networkApplicationGateways": "agw-",
              "networkApplicationSecurityGroups": "asg-",
              "networkAzureFirewalls": "afw-",
              "networkBastionHosts": "bas-",
              "networkConnections": "con-",
              "networkDnsZones": "dnsz-",
              "networkExpressRouteCircuits": "erc-",
              "networkFirewallPolicies": "afwp-",
              "networkFirewallPoliciesWebApplication": "waf",
              "networkFirewallPoliciesRuleGroups": "wafrg",
              "networkFrontDoors": "fd-",
              "networkFrontdoorWebApplicationFirewallPolicies": "fdfp-",
              "networkLoadBalancersExternal": "lbe-",
              "networkLoadBalancersInternal": "lbi-",
              "networkLoadBalancersInboundNatRules": "rule-",
              "networkLocalNetworkGateways": "lgw-",
              "networkNatGateways": "ng-",
              "networkNetworkInterfaces": "nic-",
              "networkNetworkSecurityGroups": "nsg-",
              "networkNetworkSecurityGroupsSecurityRules": "nsgsr-",
              "networkNetworkWatchers": "nw-",
              "networkPrivateDnsZones": "pdnsz-",
              "networkPrivateLinkServices": "pl-",
              "networkPublicIPAddresses": "pip-",
              "networkPublicIPPrefixes": "ippre-",
              "networkRouteFilters": "rf-",
              "networkRouteTables": "rt-",
              "networkRouteTablesRoutes": "udr-",
              "networkTrafficManagerProfiles": "traf-",
              "networkVirtualNetworkGateways": "vgw-",
              "networkVirtualNetworks": "vnet",
              "networkVirtualNetworks-prefix": "vnet-",
              "networkVirtualNetworksSubnets": "snet",
              "networkVirtualNetworksSubnets-prefix": "snet-",
              "networkVirtualNetworksVirtualNetworkPeerings": "peer-",
              "networkVirtualWans": "vwan-",
              "networkVpnGateways": "vpng-",
              "networkVpnGatewaysVpnConnections": "vcn-",
              "networkVpnGatewaysVpnSites": "vst-",
              "notificationHubsNamespaces": "ntfns-",
              "notificationHubsNamespacesNotificationHubs": "ntf-",
              "operationalInsightsWorkspaces": "log",
              "operationalInsightsWorkspaces-prefix": "log-",
              "portalDashboards": "dash-",
              "powerBIDedicatedCapacities": "pbi-",
              "purviewAccounts": "pview-",
              "recoveryServicesVaults": "rsv",
              "recoveryServicesVaults-prefix": "rsv-",
              "resourcesResourceGroups": "rg",
              "resourcesResourceGroups-prefix": "rg_",
              "searchSearchServices": "srch",
              "searchSearchServices-prefix": "srch-",
              "serviceBusNamespaces": "sb",
              "serviceBusNamespaces-prefix": "sb-",
              "serviceBusNamespacesQueues": "sbq",
              "serviceBusNamespacesQueues-prefix": "sbq-",
              "serviceBusNamespacesTopics": "sbt",
              "serviceBusNamespacesTopics-prefix": "sbt-",
              "serviceEndPointPolicies": "se-",
              "serviceFabricClusters": "sf-",
              "signalRServiceSignalR": "sigr",
              "sqlManagedInstances": "sqlmi-",
              "sqlServers": "sql",
              "sqlServers-prefix": "sql-",
              "sqlServersDataWarehouse": "sqldw-",
              "sqlServersDatabases": "sqldb-",
              "sqlServersDatabasesStretch": "sqlstrdb-",
              "storageStorageContainer": "stc",
              "storageStorageAccounts": "st",
              "storageStorageAccountsVm": "stvm",
              "storSimpleManagers": "ssimp",
              "streamAnalyticsCluster": "asa-",
              "synapseWorkspaces": "syn",
              "synapseWorkspacesAnalyticsWorkspaces": "synw",
              "synapseWorkspacesSqlPoolsDedicated": "syndp",
              "synapseWorkspacesSqlPoolsSpark": "synsp",
              "timeSeriesInsightsEnvironments": "tsi-",
              "webServerFarms": "plan",
              "webServerFarms-prefix": "plan-",
              "webSitesAppService": "app",
              "webSitesAppService-prefix": "app-",
              "webSitesAppServiceEnvironment": "ase",
              "webSitesAppServiceEnvironment-prefix": "ase-",
              "webSitesFunctions": "func",
              "webSitesFunctions-prefix": "func-",
              "webStaticSites": "stapp",
              "webStaticSites-prefix": "stapp-"
            },
            "sanitizedEnvironment": "[toLower(parameters('environmentName'))]",
            "sanitizedAppNameWithDashes": "[replace(replace(toLower(parameters('applicationName')), ' ', ''), '_', '')]",
            "sanitizedAppName": "[replace(replace(replace(toLower(parameters('applicationName')), ' ', ''), '-', ''), '_', '')]",
            "resourceTokenWithDash": "[if(equals(parameters('resourceToken'), ''), '', format('-{0}', parameters('resourceToken')))]",
            "resourceTokenWithoutDash": "[if(equals(parameters('resourceToken'), ''), '', format('{0}', parameters('resourceToken')))]",
            "dashRegionDashInstance": "[if(equals(parameters('instance'), ''), '', toLower(format('-{0}-{1}', parameters('regionCode'), parameters('instance'))))]",
            "dashInstance": "[if(equals(parameters('instance'), ''), '', format('-{0}', parameters('instance')))]",
            "regionInstance": "[if(equals(parameters('instance'), ''), '', toLower(format('{0}{1}', parameters('regionCode'), parameters('instance'))))]",
            "resourceAbbreviations": "[variables('$fxv#0')]"
          },
          "resources": [],
          "outputs": {
            "webSiteName": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-{2}{3}', variables('resourceAbbreviations').webSitesAppService, variables('sanitizedAppNameWithDashes'), variables('sanitizedEnvironment'), variables('resourceTokenWithDash')))]"
            },
            "webSiteAppServicePlanName": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-{2}{3}{4}', variables('resourceAbbreviations').webServerFarms, variables('sanitizedAppName'), variables('sanitizedEnvironment'), variables('resourceTokenWithDash'), variables('dashRegionDashInstance')))]"
            },
            "appInsightsName": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-{2}{3}{4}', variables('resourceAbbreviations').insightsComponents, variables('sanitizedAppName'), variables('sanitizedEnvironment'), variables('resourceTokenWithDash'), variables('dashRegionDashInstance')))]"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-{2}{3}{4}', variables('resourceAbbreviations').operationalInsightsWorkspaces, variables('sanitizedAppName'), variables('sanitizedEnvironment'), variables('resourceTokenWithDash'), variables('dashRegionDashInstance')))]"
            },
            "cosmosName": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-{2}{3}{4}', variables('resourceAbbreviations').documentDBDatabaseAccounts, variables('sanitizedAppName'), variables('sanitizedEnvironment'), variables('resourceTokenWithDash'), variables('dashRegionDashInstance')))]"
            },
            "searchServiceName": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-{2}{3}{4}', variables('resourceAbbreviations').searchSearchServices, variables('sanitizedAppName'), variables('sanitizedEnvironment'), variables('resourceTokenWithDash'), variables('dashRegionDashInstance')))]"
            },
            "cogServiceName": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-{2}{3}{4}', variables('resourceAbbreviations').cognitiveServicesAccounts, variables('sanitizedAppName'), variables('sanitizedEnvironment'), variables('resourceTokenWithDash'), variables('dashRegionDashInstance')))]"
            },
            "documentIntelligenceName": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-{2}-{3}{4}', variables('resourceAbbreviations').cognitiveServicesFormRecognizer, variables('sanitizedAppName'), variables('sanitizedEnvironment'), variables('resourceTokenWithDash'), variables('dashRegionDashInstance')))]"
            },
            "aiHubName": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-{2}{3}{4}', variables('resourceAbbreviations').cognitiveServicesHub, variables('sanitizedAppName'), variables('sanitizedEnvironment'), variables('resourceTokenWithDash'), variables('dashRegionDashInstance')))]"
            },
            "aiHubProjectName": {
              "type": "string",
              "value": "[take(toLower(format('{0}-Project-{1}-{2}{3}{4}', variables('resourceAbbreviations').cognitiveServicesHub, variables('sanitizedAppName'), variables('sanitizedEnvironment'), variables('resourceTokenWithDash'), variables('dashInstance'))), 32)]"
            },
            "caManagedEnvName": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-{2}{3}{4}', variables('resourceAbbreviations').appManagedEnvironments, variables('sanitizedAppName'), variables('sanitizedEnvironment'), parameters('resourceToken'), variables('dashRegionDashInstance')))]"
            },
            "containerAppAPIName": {
              "type": "string",
              "value": "[take(toLower(format('{0}-api-{1}-{2}{3}{4}', variables('resourceAbbreviations').appContainerApps, variables('sanitizedAppName'), variables('sanitizedEnvironment'), variables('resourceTokenWithDash'), variables('dashInstance'))), 32)]"
            },
            "containerAppUIName": {
              "type": "string",
              "value": "[take(toLower(format('{0}-ui-{1}-{2}{3}{4}', variables('resourceAbbreviations').appContainerApps, variables('sanitizedAppName'), variables('sanitizedEnvironment'), variables('resourceTokenWithDash'), variables('dashInstance'))), 32)]"
            },
            "containerAppBatchName": {
              "type": "string",
              "value": "[take(toLower(format('{0}-batch-{1}-{2}{3}{4}', variables('resourceAbbreviations').appContainerApps, variables('sanitizedAppName'), variables('sanitizedEnvironment'), variables('resourceTokenWithDash'), variables('dashInstance'))), 32)]"
            },
            "caManagedIdentityName": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-{2}{3}-{4}', variables('sanitizedAppName'), variables('resourceAbbreviations').appManagedEnvironments, variables('resourceAbbreviations').managedIdentityUserAssignedIdentities, variables('dashInstance'), variables('sanitizedEnvironment')))]"
            },
            "kvManagedIdentityName": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-{2}{3}-{4}', variables('sanitizedAppName'), variables('resourceAbbreviations').keyVaultVaults, variables('resourceAbbreviations').managedIdentityUserAssignedIdentities, variables('dashInstance'), variables('sanitizedEnvironment')))]"
            },
            "userAssignedIdentityName": {
              "type": "string",
              "value": "[toLower(format('{0}-app-{1}{2}-{3}', variables('sanitizedAppName'), variables('resourceAbbreviations').managedIdentityUserAssignedIdentities, variables('dashInstance'), variables('sanitizedEnvironment')))]"
            },
            "vnet_Name": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}-{2}{3}{4}', variables('sanitizedAppName'), variables('resourceAbbreviations').networkVirtualNetworks, variables('sanitizedEnvironment'), variables('resourceTokenWithDash'), variables('dashRegionDashInstance')))]"
            },
            "subnetAppGwName": {
              "type": "string",
              "value": "[toLower('snet-app-gateway')]"
            },
            "subnetAppSeName": {
              "type": "string",
              "value": "[toLower('snet-app-services')]"
            },
            "subnetPeName": {
              "type": "string",
              "value": "[toLower('snet-private-endpoint')]"
            },
            "subnetAgentName": {
              "type": "string",
              "value": "[toLower('snet-agent')]"
            },
            "subnetBastionName": {
              "type": "string",
              "value": "AzureBastionSubnet"
            },
            "subnetJumpboxName": {
              "type": "string",
              "value": "[toLower('snet-jumpbox')]"
            },
            "subnetTrainingName": {
              "type": "string",
              "value": "[toLower('snet-training')]"
            },
            "subnetScoringName": {
              "type": "string",
              "value": "[toLower('snet-scoring')]"
            },
            "vm_name": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}{2}-{3}', variables('sanitizedAppName'), variables('resourceAbbreviations').computeVirtualMachines, variables('dashInstance'), variables('sanitizedEnvironment')))]"
            },
            "vm_nic_name": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}{2}-{3}', variables('sanitizedAppName'), variables('resourceAbbreviations').networkNetworkInterfaces, variables('dashInstance'), variables('sanitizedEnvironment')))]"
            },
            "vm_pip_name": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}{2}-{3}', variables('sanitizedAppName'), variables('resourceAbbreviations').networkPublicIPAddresses, variables('dashInstance'), variables('sanitizedEnvironment')))]"
            },
            "vm_os_disk_name": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}{2}-{3}', variables('sanitizedAppName'), variables('resourceAbbreviations').computeDisks, variables('dashInstance'), variables('sanitizedEnvironment')))]"
            },
            "vm_nsg_name": {
              "type": "string",
              "value": "[toLower(format('{0}-{1}{2}-{3}', variables('sanitizedAppName'), variables('resourceAbbreviations').networkNetworkSecurityGroups, variables('dashInstance'), variables('sanitizedEnvironment')))]"
            },
            "ACR_Name": {
              "type": "string",
              "value": "[take(format('{0}{1}{2}{3}{4}', variables('resourceAbbreviations').containerRegistryRegistries, variables('sanitizedAppName'), variables('sanitizedEnvironment'), variables('resourceTokenWithoutDash'), variables('regionInstance')), 50)]"
            },
            "keyVaultName": {
              "type": "string",
              "value": "[take(format('{0}{1}{2}{3}{4}', variables('resourceAbbreviations').keyVaultVaults, variables('sanitizedAppName'), variables('sanitizedEnvironment'), variables('resourceTokenWithoutDash'), variables('regionInstance')), 24)]"
            },
            "storageAccountName": {
              "type": "string",
              "value": "[take(format('{0}{1}{2}{3}{4}', variables('resourceAbbreviations').storageStorageAccounts, variables('sanitizedAppName'), variables('sanitizedEnvironment'), variables('resourceTokenWithoutDash'), variables('regionInstance')), 24)]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('vnet{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "existingVirtualNetworkName": {
            "value": "[parameters('existingVnetName')]"
          },
          "existingVnetResourceGroupName": {
            "value": "[parameters('existingVnetResourceGroupName')]"
          },
          "newVirtualNetworkName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.vnet_Name.value]"
          },
          "vnetAddressPrefix": {
            "value": "[variables('vnetAddressPrefix')]"
          },
          "subnetAppGwName": "[if(not(empty(parameters('subnetAppGwName'))), createObject('value', parameters('subnetAppGwName')), createObject('value', reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.subnetAppGwName.value))]",
          "subnetAppGwPrefix": {
            "value": "[parameters('subnetAppGwPrefix')]"
          },
          "subnetAppSeName": "[if(not(empty(parameters('subnetAppSeName'))), createObject('value', parameters('subnetAppSeName')), createObject('value', reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.subnetAppSeName.value))]",
          "subnetAppSePrefix": {
            "value": "[parameters('subnetAppSePrefix')]"
          },
          "subnetPeName": "[if(not(empty(parameters('subnetPeName'))), createObject('value', parameters('subnetPeName')), createObject('value', reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.subnetPeName.value))]",
          "subnetPePrefix": {
            "value": "[parameters('subnetPePrefix')]"
          },
          "subnetAgentName": "[if(not(empty(parameters('subnetAgentName'))), createObject('value', parameters('subnetAgentName')), createObject('value', reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.subnetAgentName.value))]",
          "subnetAgentPrefix": {
            "value": "[parameters('subnetAgentPrefix')]"
          },
          "subnetBastionName": "[if(not(empty(parameters('subnetBastionName'))), createObject('value', parameters('subnetBastionName')), createObject('value', reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.subnetBastionName.value))]",
          "subnetBastionPrefix": {
            "value": "[parameters('subnetBastionPrefix')]"
          },
          "subnetJumpboxName": "[if(not(empty(parameters('subnetJumpboxName'))), createObject('value', parameters('subnetJumpboxName')), createObject('value', reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.subnetJumpboxName.value))]",
          "subnetJumpboxPrefix": {
            "value": "[parameters('subnetJumpboxPrefix')]"
          },
          "subnetTrainingName": "[if(not(empty(parameters('subnetTrainingName'))), createObject('value', parameters('subnetTrainingName')), createObject('value', reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.subnetTrainingName.value))]",
          "subnetTrainingPrefix": {
            "value": "[parameters('subnetTrainingPrefix')]"
          },
          "subnetScoringName": "[if(not(empty(parameters('subnetScoringName'))), createObject('value', parameters('subnetScoringName')), createObject('value', reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.subnetScoringName.value))]",
          "subnetScoringPrefix": {
            "value": "[parameters('subnetScoringPrefix')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "4436772943040130445"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "existingVirtualNetworkName": {
              "type": "string",
              "defaultValue": ""
            },
            "existingVnetResourceGroupName": {
              "type": "string",
              "defaultValue": "[resourceGroup().name]"
            },
            "newVirtualNetworkName": {
              "type": "string",
              "defaultValue": ""
            },
            "vnetAddressPrefix": {
              "type": "string"
            },
            "subnetAppGwName": {
              "type": "string"
            },
            "subnetAppGwPrefix": {
              "type": "string"
            },
            "subnetAppSeName": {
              "type": "string"
            },
            "subnetAppSePrefix": {
              "type": "string"
            },
            "subnetPeName": {
              "type": "string"
            },
            "subnetPePrefix": {
              "type": "string"
            },
            "subnetAgentName": {
              "type": "string"
            },
            "subnetAgentPrefix": {
              "type": "string"
            },
            "subnetBastionName": {
              "type": "string"
            },
            "subnetBastionPrefix": {
              "type": "string"
            },
            "subnetJumpboxName": {
              "type": "string"
            },
            "subnetJumpboxPrefix": {
              "type": "string"
            },
            "subnetTrainingName": {
              "type": "string"
            },
            "subnetTrainingPrefix": {
              "type": "string"
            },
            "subnetScoringName": {
              "type": "string"
            },
            "subnetScoringPrefix": {
              "type": "string"
            }
          },
          "variables": {
            "useExistingResource": "[not(empty(parameters('existingVirtualNetworkName')))]"
          },
          "resources": [
            {
              "condition": "[not(variables('useExistingResource'))]",
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2024-01-01",
              "name": "[parameters('newVirtualNetworkName')]",
              "location": "[parameters('location')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('vnetAddressPrefix')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "[parameters('subnetAppGwName')]",
                    "properties": {
                      "addressPrefix": "[parameters('subnetAppGwPrefix')]"
                    }
                  },
                  {
                    "name": "[parameters('subnetPeName')]",
                    "properties": {
                      "addressPrefix": "[parameters('subnetPePrefix')]"
                    }
                  },
                  {
                    "name": "[parameters('subnetAgentName')]",
                    "properties": {
                      "addressPrefix": "[parameters('subnetAgentPrefix')]"
                    }
                  },
                  {
                    "name": "[parameters('subnetBastionName')]",
                    "properties": {
                      "addressPrefix": "[parameters('subnetBastionPrefix')]"
                    }
                  },
                  {
                    "name": "[parameters('subnetJumpboxName')]",
                    "properties": {
                      "addressPrefix": "[parameters('subnetJumpboxPrefix')]"
                    }
                  },
                  {
                    "name": "[parameters('subnetTrainingName')]",
                    "properties": {
                      "addressPrefix": "[parameters('subnetTrainingPrefix')]"
                    }
                  },
                  {
                    "name": "[parameters('subnetScoringName')]",
                    "properties": {
                      "addressPrefix": "[parameters('subnetScoringPrefix')]"
                    }
                  },
                  {
                    "name": "[parameters('subnetAppSeName')]",
                    "properties": {
                      "addressPrefix": "[parameters('subnetAppSePrefix')]",
                      "networkSecurityGroup": {
                        "id": "[reference(resourceId('Microsoft.Resources/deployments', 'nsg'), '2022-09-01').outputs.id.value]"
                      },
                      "delegations": [
                        {
                          "name": "environments",
                          "properties": {
                            "serviceName": "Microsoft.App/environments"
                          }
                        }
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'nsg')]"
              ]
            },
            {
              "condition": "[not(variables('useExistingResource'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "nsg",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "nsgName": {
                    "value": "[format('{0}-{1}-nsg-{2}', parameters('newVirtualNetworkName'), parameters('subnetAppSeName'), parameters('location'))]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "11659109383765684697"
                    }
                  },
                  "parameters": {
                    "nsgName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2024-05-01",
                      "name": "[parameters('nsgName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "securityRules": [
                          {
                            "name": "AllowAnyCustom8080Inbound",
                            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                            "properties": {
                              "protocol": "*",
                              "sourcePortRange": "*",
                              "destinationPortRange": "8080",
                              "sourceAddressPrefix": "*",
                              "destinationAddressPrefix": "*",
                              "access": "Allow",
                              "priority": 100,
                              "direction": "Inbound"
                            }
                          },
                          {
                            "name": "AllowAnyCustom8000Inbound",
                            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                            "properties": {
                              "protocol": "*",
                              "sourcePortRange": "*",
                              "destinationPortRange": "8000",
                              "sourceAddressPrefix": "*",
                              "destinationAddressPrefix": "*",
                              "access": "Allow",
                              "priority": 110,
                              "direction": "Inbound"
                            }
                          },
                          {
                            "name": "AllowAnyCustom443Inbound",
                            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                            "properties": {
                              "protocol": "*",
                              "sourcePortRange": "*",
                              "destinationPortRange": "443",
                              "sourceAddressPrefix": "*",
                              "destinationAddressPrefix": "*",
                              "access": "Allow",
                              "priority": 120,
                              "direction": "Inbound"
                            }
                          },
                          {
                            "name": "AllowAnyCustom80Inbound",
                            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                            "properties": {
                              "protocol": "*",
                              "sourcePortRange": "*",
                              "destinationPortRange": "80",
                              "sourceAddressPrefix": "*",
                              "destinationAddressPrefix": "*",
                              "access": "Allow",
                              "priority": 130,
                              "direction": "Inbound"
                            }
                          },
                          {
                            "name": "AllowAllOutbound",
                            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                            "properties": {
                              "protocol": "*",
                              "sourcePortRange": "*",
                              "destinationPortRange": "*",
                              "sourceAddressPrefix": "*",
                              "destinationAddressPrefix": "*",
                              "access": "Allow",
                              "priority": 100,
                              "direction": "Outbound"
                            }
                          }
                        ]
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgName'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('nsgName')]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "vnetResourceId": {
              "type": "string",
              "value": "[if(variables('useExistingResource'), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingVnetResourceGroupName')), 'Microsoft.Network/virtualNetworks', parameters('existingVirtualNetworkName')), resourceId('Microsoft.Network/virtualNetworks', parameters('newVirtualNetworkName')))]"
            },
            "vnetName": {
              "type": "string",
              "value": "[if(variables('useExistingResource'), parameters('existingVirtualNetworkName'), parameters('newVirtualNetworkName'))]"
            },
            "vnetAddressPrefix": {
              "type": "string",
              "value": "[if(variables('useExistingResource'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingVnetResourceGroupName')), 'Microsoft.Network/virtualNetworks', parameters('existingVirtualNetworkName')), '2024-01-01').addressSpace.addressPrefixes[0], reference(resourceId('Microsoft.Network/virtualNetworks', parameters('newVirtualNetworkName')), '2024-01-01').addressSpace.addressPrefixes[0])]"
            },
            "subnetAppGwResourceID": {
              "type": "string",
              "value": "[if(variables('useExistingResource'), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingVnetResourceGroupName')), 'Microsoft.Network/virtualNetworks/subnets', parameters('existingVirtualNetworkName'), parameters('subnetAppGwName')), resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('newVirtualNetworkName'), parameters('subnetAppGwName')))]"
            },
            "subnetAppSeResourceID": {
              "type": "string",
              "value": "[if(variables('useExistingResource'), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingVnetResourceGroupName')), 'Microsoft.Network/virtualNetworks/subnets', parameters('existingVirtualNetworkName'), parameters('subnetAppSeName')), resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('newVirtualNetworkName'), parameters('subnetAppSeName')))]"
            },
            "subnetPeResourceID": {
              "type": "string",
              "value": "[if(variables('useExistingResource'), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingVnetResourceGroupName')), 'Microsoft.Network/virtualNetworks/subnets', parameters('existingVirtualNetworkName'), parameters('subnetPeName')), resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('newVirtualNetworkName'), parameters('subnetPeName')))]"
            },
            "subnetAgentResourceID": {
              "type": "string",
              "value": "[if(variables('useExistingResource'), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingVnetResourceGroupName')), 'Microsoft.Network/virtualNetworks/subnets', parameters('existingVirtualNetworkName'), parameters('subnetAgentName')), resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('newVirtualNetworkName'), parameters('subnetAgentName')))]"
            },
            "subnetBastionResourceID": {
              "type": "string",
              "value": "[if(variables('useExistingResource'), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingVnetResourceGroupName')), 'Microsoft.Network/virtualNetworks/subnets', parameters('existingVirtualNetworkName'), parameters('subnetBastionName')), resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('newVirtualNetworkName'), parameters('subnetBastionName')))]"
            },
            "subnetJumpboxResourceID": {
              "type": "string",
              "value": "[if(variables('useExistingResource'), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingVnetResourceGroupName')), 'Microsoft.Network/virtualNetworks/subnets', parameters('existingVirtualNetworkName'), parameters('subnetJumpboxName')), resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('newVirtualNetworkName'), parameters('subnetJumpboxName')))]"
            },
            "subnetTrainingResourceID": {
              "type": "string",
              "value": "[if(variables('useExistingResource'), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingVnetResourceGroupName')), 'Microsoft.Network/virtualNetworks/subnets', parameters('existingVirtualNetworkName'), parameters('subnetTrainingName')), resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('newVirtualNetworkName'), parameters('subnetTrainingName')))]"
            },
            "subnetScoringResourceID": {
              "type": "string",
              "value": "[if(variables('useExistingResource'), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingVnetResourceGroupName')), 'Microsoft.Network/virtualNetworks/subnets', parameters('existingVirtualNetworkName'), parameters('subnetScoringName')), resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('newVirtualNetworkName'), parameters('subnetScoringName')))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "condition": "[and(and(not(empty(parameters('admin_username'))), not(empty(parameters('admin_password')))), not(empty(parameters('vm_name'))))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "jumpboxVirtualMachineDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "admin_username": {
            "value": "[parameters('admin_username')]"
          },
          "admin_password": {
            "value": "[parameters('admin_password')]"
          },
          "vm_name": {
            "value": "[parameters('vm_name')]"
          },
          "subnet_name": "[if(not(empty(parameters('subnetJumpboxName'))), createObject('value', parameters('subnetJumpboxName')), createObject('value', reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.subnetJumpboxName.value))]",
          "vnet_id": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('vnet{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.vnetResourceId.value]"
          },
          "vm_size": {
            "value": "Standard_B2s_v2"
          },
          "os_disk_size_gb": {
            "value": 128
          },
          "os_type": {
            "value": "Linux"
          },
          "my_ip_address": {
            "value": "[parameters('myIpAddress')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "9398081512679822271"
            }
          },
          "parameters": {
            "vm_name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Virtual Machine"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources."
              }
            },
            "admin_username": {
              "type": "string",
              "metadata": {
                "description": "Admin username for the VM"
              }
            },
            "admin_password": {
              "type": "securestring",
              "metadata": {
                "description": "Admin password for the VM"
              }
            },
            "vnet_id": {
              "type": "string",
              "metadata": {
                "description": "Virtual Network resource ID"
              }
            },
            "subnet_name": {
              "type": "string",
              "metadata": {
                "description": "Subnet name within the Virtual Network"
              }
            },
            "vm_size": {
              "type": "string",
              "defaultValue": "Standard_D4s_v5",
              "metadata": {
                "description": "VM size"
              }
            },
            "os_disk_size_gb": {
              "type": "int",
              "defaultValue": 128,
              "metadata": {
                "description": "OS disk size in GB"
              }
            },
            "os_type": {
              "type": "string",
              "defaultValue": "Windows",
              "allowedValues": [
                "Windows",
                "Linux"
              ],
              "metadata": {
                "description": "Operating system type: Windows or Linux"
              }
            },
            "my_ip_address": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "My IP address for restricted NSG access"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to resources"
              }
            }
          },
          "variables": {
            "nic_name": "[format('{0}-nic', parameters('vm_name'))]",
            "pip_name": "[format('{0}-pip', parameters('vm_name'))]",
            "os_disk_name": "[format('{0}-osdisk', parameters('vm_name'))]",
            "nsg_name": "[format('{0}-nsg', parameters('vm_name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2023-04-01",
              "name": "[variables('pip_name')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "publicIPAllocationMethod": "Static",
                "dnsSettings": {
                  "domainNameLabel": "[toLower(format('{0}-dns', parameters('vm_name')))]"
                }
              },
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-04-01",
              "name": "[variables('nsg_name')]",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": "[concat(if(equals(parameters('os_type'), 'Linux'), createArray(createObject('name', 'SSH', 'properties', createObject('priority', 1000, 'direction', 'Inbound', 'access', 'Allow', 'protocol', 'Tcp', 'sourcePortRange', '*', 'destinationPortRange', '22', 'sourceAddressPrefix', if(not(empty(parameters('my_ip_address'))), parameters('my_ip_address'), '*'), 'destinationAddressPrefix', '*'))), createArray(createObject('name', 'RDP', 'properties', createObject('priority', 1000, 'direction', 'Inbound', 'access', 'Allow', 'protocol', 'Tcp', 'sourcePortRange', '*', 'destinationPortRange', '3389', 'sourceAddressPrefix', if(not(empty(parameters('my_ip_address'))), parameters('my_ip_address'), '*'), 'destinationAddressPrefix', '*')))), createArray(createObject('name', 'AllowHttpsOutbound', 'properties', createObject('priority', 2000, 'direction', 'Outbound', 'access', 'Allow', 'protocol', 'Tcp', 'sourcePortRange', '*', 'destinationPortRange', '443', 'sourceAddressPrefix', '*', 'destinationAddressPrefix', 'Internet')), createObject('name', 'AllowHttpOutbound', 'properties', createObject('priority', 2010, 'direction', 'Outbound', 'access', 'Allow', 'protocol', 'Tcp', 'sourcePortRange', '*', 'destinationPortRange', '80', 'sourceAddressPrefix', '*', 'destinationAddressPrefix', 'Internet'))))]"
              },
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/networkInterfaces",
              "apiVersion": "2023-04-01",
              "name": "[variables('nic_name')]",
              "location": "[parameters('location')]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "ipconfig1",
                    "properties": {
                      "subnet": {
                        "id": "[format('{0}/subnets/{1}', parameters('vnet_id'), parameters('subnet_name'))]"
                      },
                      "privateIPAllocationMethod": "Dynamic",
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('pip_name'))]"
                      }
                    }
                  }
                ],
                "networkSecurityGroup": {
                  "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsg_name'))]"
                }
              },
              "tags": "[parameters('tags')]",
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsg_name'))]",
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('pip_name'))]"
              ]
            },
            {
              "type": "Microsoft.Compute/virtualMachines",
              "apiVersion": "2023-09-01",
              "name": "[parameters('vm_name')]",
              "location": "[parameters('location')]",
              "properties": {
                "hardwareProfile": {
                  "vmSize": "[parameters('vm_size')]"
                },
                "osProfile": {
                  "computerName": "[parameters('vm_name')]",
                  "adminUsername": "[parameters('admin_username')]",
                  "adminPassword": "[parameters('admin_password')]",
                  "windowsConfiguration": "[if(equals(parameters('os_type'), 'Windows'), createObject('enableAutomaticUpdates', true(), 'patchSettings', createObject('patchMode', 'AutomaticByOS')), null())]",
                  "linuxConfiguration": "[if(equals(parameters('os_type'), 'Linux'), createObject('disablePasswordAuthentication', false(), 'patchSettings', createObject('patchMode', 'ImageDefault')), null())]"
                },
                "storageProfile": {
                  "osDisk": {
                    "name": "[variables('os_disk_name')]",
                    "caching": "ReadWrite",
                    "createOption": "FromImage",
                    "diskSizeGB": "[parameters('os_disk_size_gb')]",
                    "managedDisk": {
                      "storageAccountType": "Premium_LRS"
                    }
                  },
                  "imageReference": "[if(equals(parameters('os_type'), 'Windows'), createObject('publisher', 'MicrosoftWindowsDesktop', 'offer', 'windows-11', 'sku', 'win11-22h2-pro', 'version', 'latest'), createObject('publisher', 'Canonical', 'offer', '0001-com-ubuntu-server-focal', 'sku', '20_04-lts-gen2', 'version', 'latest'))]"
                },
                "networkProfile": {
                  "networkInterfaces": [
                    {
                      "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nic_name'))]"
                    }
                  ]
                }
              },
              "tags": "[parameters('tags')]",
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('nic_name'))]"
              ]
            }
          ],
          "outputs": {
            "vm_id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vm_name'))]"
            },
            "vm_private_ip": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/networkInterfaces', variables('nic_name')), '2023-04-01').ipConfigurations[0].properties.privateIPAddress]"
            },
            "vm_public_ip": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('pip_name')), '2023-04-01').ipAddress]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('vnet{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('containerregistry{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "existingRegistryName": {
            "value": "[parameters('existing_ACR_Name')]"
          },
          "existing_ACR_ResourceGroupName": {
            "value": "[parameters('existing_ACR_ResourceGroupName')]"
          },
          "newRegistryName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.ACR_Name.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "acrSku": {
            "value": "Premium"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "publicAccessEnabled": {
            "value": "[parameters('publicAccessEnabled')]"
          },
          "privateEndpointName": {
            "value": "[format('pe-{0}', reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.ACR_Name.value)]"
          },
          "privateEndpointSubnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('vnet{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.subnetAppSeResourceID.value]"
          },
          "myIpAddress": {
            "value": "[parameters('myIpAddress')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "2380231298675157612"
            }
          },
          "parameters": {
            "existingRegistryName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Provide an existing name of an Azure Container Registry if using pre-existing one"
              }
            },
            "existing_ACR_ResourceGroupName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Provide resource group name for an existing Azure Container Registry if using pre-existing one"
              }
            },
            "newRegistryName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Provide a globally unique name of your Azure Container Registry for a new server"
              }
            },
            "acrSku": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Provide a tier of your Azure Container Registry."
              }
            },
            "publicAccessEnabled": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Control public access to resources"
              }
            },
            "myIpAddress": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Provide the IP address to allow access to the Azure Container Registry"
              }
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "privateEndpointName": {
              "type": "string",
              "defaultValue": ""
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "variables": {
            "registrySecretName": "acr-registry-secret",
            "useExistingResource": "[not(empty(parameters('existingRegistryName')))]",
            "resourceGroupName": "[resourceGroup().name]"
          },
          "resources": [
            {
              "condition": "[not(variables('useExistingResource'))]",
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-01-01-preview",
              "name": "[parameters('newRegistryName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('acrSku')]"
              },
              "properties": {
                "adminUserEnabled": true,
                "publicNetworkAccess": "Enabled",
                "networkRuleSet": {
                  "defaultAction": "[if(parameters('publicAccessEnabled'), 'Allow', 'Deny')]",
                  "ipRules": "[if(empty(parameters('myIpAddress')), createArray(), createArray(createObject('action', 'Allow', 'value', parameters('myIpAddress'))))]"
                }
              }
            },
            {
              "condition": "[not(variables('useExistingResource'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-private-endpoint', parameters('newRegistryName'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "privateEndpointName": {
                    "value": "[parameters('privateEndpointName')]"
                  },
                  "groupIds": {
                    "value": [
                      "registry"
                    ]
                  },
                  "targetResourceId": {
                    "value": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('newRegistryName'))]"
                  },
                  "subnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "6191151302122753297"
                    }
                  },
                  "parameters": {
                    "privateEndpointName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the private endpoint to create"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "The region where the private endpoint will be created"
                      }
                    },
                    "subnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "The ID of the subnet where the private endpoint will be created"
                      }
                    },
                    "targetResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The ID of the resource to which the private endpoint will be connected"
                      }
                    },
                    "groupIds": {
                      "type": "array",
                      "metadata": {
                        "description": "An array of group IDs of the service type that they private endpoint will be connect to"
                      }
                    },
                    "dnsZoneId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "The resource ID of the private DNS zone for this resource"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "The tags to associate with the private endpoint"
                      }
                    }
                  },
                  "variables": {
                    "nicName": "[format('{0}-nic', parameters('privateEndpointName'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('privateEndpointName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "customNetworkInterfaceName": "[variables('nicName')]",
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[parameters('privateEndpointName')]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('targetResourceId')]",
                              "groupIds": "[parameters('groupIds')]"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "condition": "[not(equals(parameters('dnsZoneId'), ''))]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2023-06-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointName'), format('{0}-dns-group', parameters('privateEndpointName')))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "default",
                            "properties": {
                              "privateDnsZoneId": "[parameters('dnsZoneId')]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateEndpointId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                    },
                    "privateEndpointName": {
                      "type": "string",
                      "value": "[parameters('privateEndpointName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerRegistry/registries', parameters('newRegistryName'))]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[if(variables('useExistingResource'), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existing_ACR_ResourceGroupName')), 'Microsoft.ContainerRegistry/registries', parameters('existingRegistryName')), resourceId('Microsoft.ContainerRegistry/registries', parameters('newRegistryName')))]"
            },
            "name": {
              "type": "string",
              "value": "[if(variables('useExistingResource'), parameters('existingRegistryName'), parameters('newRegistryName'))]"
            },
            "resourceGroupName": {
              "type": "string",
              "value": "[if(variables('useExistingResource'), parameters('existing_ACR_ResourceGroupName'), variables('resourceGroupName'))]"
            },
            "loginServer": {
              "type": "string",
              "value": "[if(variables('useExistingResource'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existing_ACR_ResourceGroupName')), 'Microsoft.ContainerRegistry/registries', parameters('existingRegistryName')), '2023-01-01-preview').loginServer, reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('newRegistryName')), '2023-01-01-preview').loginServer)]"
            },
            "privateEndpointName": {
              "type": "string",
              "value": "[parameters('privateEndpointName')]"
            },
            "registrySecretName": {
              "type": "string",
              "value": "[variables('registrySecretName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('vnet{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('law{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "existingLogAnalyticsName": {
            "value": "[parameters('existing_LogAnalytics_Name')]"
          },
          "existingLogAnalyticsRgName": {
            "value": "[variables('resourceGroupName')]"
          },
          "newLogAnalyticsName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.logAnalyticsWorkspaceName.value]"
          },
          "existingApplicationInsightsName": {
            "value": "[parameters('existing_AppInsights_Name')]"
          },
          "newApplicationInsightsName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.appInsightsName.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "3959169921314554673"
            }
          },
          "parameters": {
            "newLogAnalyticsName": {
              "type": "string",
              "defaultValue": ""
            },
            "newApplicationInsightsName": {
              "type": "string",
              "defaultValue": ""
            },
            "existingLogAnalyticsName": {
              "type": "string",
              "defaultValue": ""
            },
            "existingLogAnalyticsRgName": {
              "type": "string",
              "defaultValue": ""
            },
            "existingApplicationInsightsName": {
              "type": "string",
              "defaultValue": ""
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "azureMonitorPrivateLinkScopeName": {
              "type": "string",
              "defaultValue": ""
            },
            "azureMonitorPrivateLinkScopeResourceGroupName": {
              "type": "string",
              "defaultValue": ""
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "privateEndpointName": {
              "type": "string",
              "defaultValue": ""
            },
            "publicNetworkAccessForIngestion": {
              "type": "string",
              "defaultValue": "Enabled"
            },
            "publicNetworkAccessForQuery": {
              "type": "string",
              "defaultValue": "Enabled"
            }
          },
          "variables": {
            "useExistingLogAnalytics": "[not(empty(parameters('existingLogAnalyticsName')))]",
            "useExistingAppInsights": "[not(empty(parameters('existingApplicationInsightsName')))]"
          },
          "resources": [
            {
              "condition": "[not(variables('useExistingLogAnalytics'))]",
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[parameters('newLogAnalyticsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "retentionInDays": 30,
                "features": {
                  "searchVersion": 1
                },
                "sku": {
                  "name": "PerGB2018"
                },
                "publicNetworkAccessForIngestion": "[parameters('publicNetworkAccessForIngestion')]",
                "publicNetworkAccessForQuery": "[parameters('publicNetworkAccessForQuery')]"
              }
            },
            {
              "condition": "[not(variables('useExistingAppInsights'))]",
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('newApplicationInsightsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('newLogAnalyticsName'))]",
                "publicNetworkAccessForIngestion": "[parameters('publicNetworkAccessForIngestion')]",
                "publicNetworkAccessForQuery": "[parameters('publicNetworkAccessForQuery')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('newLogAnalyticsName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('privateEndpointSubnetId')))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "azure-monitor-private-link-scope-private-endpoint",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "privateEndpointName": {
                    "value": "[parameters('privateEndpointName')]"
                  },
                  "groupIds": {
                    "value": [
                      "azuremonitor"
                    ]
                  },
                  "targetResourceId": {
                    "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('azureMonitorPrivateLinkScopeResourceGroupName')), 'microsoft.insights/privateLinkScopes', parameters('azureMonitorPrivateLinkScopeName'))]"
                  },
                  "subnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "6191151302122753297"
                    }
                  },
                  "parameters": {
                    "privateEndpointName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the private endpoint to create"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "The region where the private endpoint will be created"
                      }
                    },
                    "subnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "The ID of the subnet where the private endpoint will be created"
                      }
                    },
                    "targetResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The ID of the resource to which the private endpoint will be connected"
                      }
                    },
                    "groupIds": {
                      "type": "array",
                      "metadata": {
                        "description": "An array of group IDs of the service type that they private endpoint will be connect to"
                      }
                    },
                    "dnsZoneId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "The resource ID of the private DNS zone for this resource"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "The tags to associate with the private endpoint"
                      }
                    }
                  },
                  "variables": {
                    "nicName": "[format('{0}-nic', parameters('privateEndpointName'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('privateEndpointName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "customNetworkInterfaceName": "[variables('nicName')]",
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[parameters('privateEndpointName')]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('targetResourceId')]",
                              "groupIds": "[parameters('groupIds')]"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "condition": "[not(equals(parameters('dnsZoneId'), ''))]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2023-06-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointName'), format('{0}-dns-group', parameters('privateEndpointName')))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "default",
                            "properties": {
                              "privateDnsZoneId": "[parameters('dnsZoneId')]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateEndpointId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                    },
                    "privateEndpointName": {
                      "type": "string",
                      "value": "[parameters('privateEndpointName')]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "applicationInsightsId": {
              "type": "string",
              "value": "[if(variables('useExistingAppInsights'), resourceId('Microsoft.Insights/components', parameters('existingApplicationInsightsName')), resourceId('Microsoft.Insights/components', parameters('newApplicationInsightsName')))]"
            },
            "applicationInsightsName": {
              "type": "string",
              "value": "[if(variables('useExistingAppInsights'), parameters('existingApplicationInsightsName'), parameters('newApplicationInsightsName'))]"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "value": "[if(variables('useExistingLogAnalytics'), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingLogAnalyticsRgName')), 'Microsoft.OperationalInsights/workspaces', parameters('existingLogAnalyticsName')), resourceId('Microsoft.OperationalInsights/workspaces', parameters('newLogAnalyticsName')))]"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "value": "[if(variables('useExistingLogAnalytics'), parameters('existingLogAnalyticsName'), parameters('newLogAnalyticsName'))]"
            },
            "appInsightsConnectionString": {
              "type": "string",
              "value": "[if(variables('useExistingAppInsights'), reference(resourceId('Microsoft.Insights/components', parameters('existingApplicationInsightsName')), '2020-02-02').ConnectionString, reference(resourceId('Microsoft.Insights/components', parameters('newApplicationInsightsName')), '2020-02-02').ConnectionString)]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('storage{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.storageAccountName.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "privateEndpointSubnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('vnet{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.subnetAppSeResourceID.value]"
          },
          "privateEndpointBlobName": {
            "value": "[format('pe-blob-{0}', reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.storageAccountName.value)]"
          },
          "privateEndpointQueueName": {
            "value": "[format('pe-queue-{0}', reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.storageAccountName.value)]"
          },
          "privateEndpointTableName": {
            "value": "[format('pe-table-{0}', reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.storageAccountName.value)]"
          },
          "myIpAddress": {
            "value": "[parameters('myIpAddress')]"
          },
          "containers": {
            "value": [
              "data",
              "batch-input",
              "batch-output"
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "5749792947849915439"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "defaultValue": ""
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "existingStorageAccountName": {
              "type": "string",
              "defaultValue": ""
            },
            "publicNetworkAccess": {
              "type": "bool",
              "defaultValue": false
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "privateEndpointBlobName": {
              "type": "string",
              "defaultValue": ""
            },
            "privateEndpointQueueName": {
              "type": "string",
              "defaultValue": ""
            },
            "privateEndpointTableName": {
              "type": "string",
              "defaultValue": ""
            },
            "myIpAddress": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Provide the IP address to allow access to the Azure Container Registry"
              }
            },
            "containers": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "defaultValue": []
            },
            "resourcesWithAccess": {
              "type": "array",
              "items": {
                "type": "object"
              },
              "defaultValue": []
            },
            "kind": {
              "type": "string",
              "defaultValue": "StorageV2"
            },
            "minimumTlsVersion": {
              "type": "string",
              "defaultValue": "TLS1_2"
            },
            "sku": {
              "type": "object",
              "defaultValue": {
                "name": "Standard_LRS"
              }
            }
          },
          "variables": {
            "useExistingStorageAccount": "[not(empty(parameters('existingStorageAccountName')))]",
            "storageAccountConnectionStringSecretName": "storage-account-connection-string"
          },
          "resources": {
            "storage::blobServices::container": {
              "copy": {
                "name": "storage::blobServices::container",
                "count": "[length(parameters('containers'))]"
              },
              "condition": "[and(not(variables('useExistingStorageAccount')), not(empty(parameters('containers'))))]",
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}/{2}', parameters('name'), 'default', parameters('containers')[copyIndex()])]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "storage::blobServices"
              ]
            },
            "storage::blobServices": {
              "condition": "[and(not(variables('useExistingStorageAccount')), not(empty(parameters('containers'))))]",
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('name'), 'default')]",
              "dependsOn": [
                "storage"
              ]
            },
            "existingStorageAccount": {
              "condition": "[variables('useExistingStorageAccount')]",
              "existing": true,
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-05-01",
              "name": "[parameters('existingStorageAccountName')]"
            },
            "existingStorageAccountBlobServices": {
              "condition": "[and(variables('useExistingStorageAccount'), not(empty(parameters('containers'))))]",
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('existingStorageAccountName'), 'default')]"
            },
            "storageAccountBlobContainerResource": {
              "copy": {
                "name": "storageAccountBlobContainerResource",
                "count": "[length(parameters('containers'))]"
              },
              "condition": "[variables('useExistingStorageAccount')]",
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}/{2}', parameters('existingStorageAccountName'), 'default', parameters('containers')[copyIndex()])]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "existingStorageAccountBlobServices"
              ]
            },
            "storage": {
              "condition": "[not(variables('useExistingStorageAccount'))]",
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-05-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "[parameters('kind')]",
              "sku": "[parameters('sku')]",
              "properties": {
                "minimumTlsVersion": "[parameters('minimumTlsVersion')]",
                "allowBlobPublicAccess": false,
                "publicNetworkAccess": "[if(parameters('publicNetworkAccess'), 'Enabled', 'Disabled')]",
                "supportsHttpsTrafficOnly": true,
                "networkAcls": {
                  "bypass": "AzureServices",
                  "resourceAccessRules": "[parameters('resourcesWithAccess')]",
                  "defaultAction": "Deny",
                  "ipRules": "[if(empty(parameters('myIpAddress')), createArray(), createArray(createObject('value', parameters('myIpAddress'))))]"
                }
              }
            },
            "privateEndpointBlob": {
              "condition": "[and(not(variables('useExistingStorageAccount')), not(empty(parameters('privateEndpointSubnetId'))))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-blob-private-endpoint', parameters('name'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "privateEndpointName": {
                    "value": "[parameters('privateEndpointBlobName')]"
                  },
                  "groupIds": {
                    "value": [
                      "blob"
                    ]
                  },
                  "targetResourceId": {
                    "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
                  },
                  "subnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "6191151302122753297"
                    }
                  },
                  "parameters": {
                    "privateEndpointName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the private endpoint to create"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "The region where the private endpoint will be created"
                      }
                    },
                    "subnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "The ID of the subnet where the private endpoint will be created"
                      }
                    },
                    "targetResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The ID of the resource to which the private endpoint will be connected"
                      }
                    },
                    "groupIds": {
                      "type": "array",
                      "metadata": {
                        "description": "An array of group IDs of the service type that they private endpoint will be connect to"
                      }
                    },
                    "dnsZoneId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "The resource ID of the private DNS zone for this resource"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "The tags to associate with the private endpoint"
                      }
                    }
                  },
                  "variables": {
                    "nicName": "[format('{0}-nic', parameters('privateEndpointName'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('privateEndpointName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "customNetworkInterfaceName": "[variables('nicName')]",
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[parameters('privateEndpointName')]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('targetResourceId')]",
                              "groupIds": "[parameters('groupIds')]"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "condition": "[not(equals(parameters('dnsZoneId'), ''))]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2023-06-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointName'), format('{0}-dns-group', parameters('privateEndpointName')))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "default",
                            "properties": {
                              "privateDnsZoneId": "[parameters('dnsZoneId')]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateEndpointId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                    },
                    "privateEndpointName": {
                      "type": "string",
                      "value": "[parameters('privateEndpointName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "storage"
              ]
            },
            "privateEndpointTable": {
              "condition": "[and(not(variables('useExistingStorageAccount')), not(empty(parameters('privateEndpointSubnetId'))))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-table-private-endpoint', parameters('name'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "privateEndpointName": {
                    "value": "[parameters('privateEndpointTableName')]"
                  },
                  "groupIds": {
                    "value": [
                      "table"
                    ]
                  },
                  "targetResourceId": {
                    "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
                  },
                  "subnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "6191151302122753297"
                    }
                  },
                  "parameters": {
                    "privateEndpointName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the private endpoint to create"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "The region where the private endpoint will be created"
                      }
                    },
                    "subnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "The ID of the subnet where the private endpoint will be created"
                      }
                    },
                    "targetResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The ID of the resource to which the private endpoint will be connected"
                      }
                    },
                    "groupIds": {
                      "type": "array",
                      "metadata": {
                        "description": "An array of group IDs of the service type that they private endpoint will be connect to"
                      }
                    },
                    "dnsZoneId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "The resource ID of the private DNS zone for this resource"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "The tags to associate with the private endpoint"
                      }
                    }
                  },
                  "variables": {
                    "nicName": "[format('{0}-nic', parameters('privateEndpointName'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('privateEndpointName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "customNetworkInterfaceName": "[variables('nicName')]",
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[parameters('privateEndpointName')]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('targetResourceId')]",
                              "groupIds": "[parameters('groupIds')]"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "condition": "[not(equals(parameters('dnsZoneId'), ''))]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2023-06-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointName'), format('{0}-dns-group', parameters('privateEndpointName')))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "default",
                            "properties": {
                              "privateDnsZoneId": "[parameters('dnsZoneId')]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateEndpointId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                    },
                    "privateEndpointName": {
                      "type": "string",
                      "value": "[parameters('privateEndpointName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "storage"
              ]
            },
            "privateEndpointQueue": {
              "condition": "[and(not(variables('useExistingStorageAccount')), not(empty(parameters('privateEndpointSubnetId'))))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-queue-private-endpoint', parameters('name'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "privateEndpointName": {
                    "value": "[parameters('privateEndpointQueueName')]"
                  },
                  "groupIds": {
                    "value": [
                      "queue"
                    ]
                  },
                  "targetResourceId": {
                    "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
                  },
                  "subnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "6191151302122753297"
                    }
                  },
                  "parameters": {
                    "privateEndpointName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the private endpoint to create"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "The region where the private endpoint will be created"
                      }
                    },
                    "subnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "The ID of the subnet where the private endpoint will be created"
                      }
                    },
                    "targetResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The ID of the resource to which the private endpoint will be connected"
                      }
                    },
                    "groupIds": {
                      "type": "array",
                      "metadata": {
                        "description": "An array of group IDs of the service type that they private endpoint will be connect to"
                      }
                    },
                    "dnsZoneId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "The resource ID of the private DNS zone for this resource"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "The tags to associate with the private endpoint"
                      }
                    }
                  },
                  "variables": {
                    "nicName": "[format('{0}-nic', parameters('privateEndpointName'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('privateEndpointName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "customNetworkInterfaceName": "[variables('nicName')]",
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[parameters('privateEndpointName')]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('targetResourceId')]",
                              "groupIds": "[parameters('groupIds')]"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "condition": "[not(equals(parameters('dnsZoneId'), ''))]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2023-06-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointName'), format('{0}-dns-group', parameters('privateEndpointName')))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "default",
                            "properties": {
                              "privateDnsZoneId": "[parameters('dnsZoneId')]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateEndpointId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                    },
                    "privateEndpointName": {
                      "type": "string",
                      "value": "[parameters('privateEndpointName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "storage"
              ]
            }
          },
          "outputs": {
            "name": {
              "type": "string",
              "value": "[if(variables('useExistingStorageAccount'), parameters('existingStorageAccountName'), parameters('name'))]"
            },
            "id": {
              "type": "string",
              "value": "[if(variables('useExistingStorageAccount'), resourceId('Microsoft.Storage/storageAccounts', parameters('existingStorageAccountName')), resourceId('Microsoft.Storage/storageAccounts', parameters('name')))]"
            },
            "primaryEndpoints": {
              "type": "object",
              "value": "[if(variables('useExistingStorageAccount'), reference('existingStorageAccount').primaryEndpoints, reference('storage').primaryEndpoints)]"
            },
            "containerNames": {
              "type": "array",
              "copy": {
                "count": "[length(parameters('containers'))]",
                "input": "[if(variables('useExistingStorageAccount'), null(), createObject('name', parameters('containers')[copyIndex()], 'url', if(variables('useExistingStorageAccount'), format('{0}/{1}', reference('existingStorageAccount').primaryEndpoints.blob, parameters('containers')[copyIndex()]), format('{0}/{1}', reference('storage').primaryEndpoints.blob, parameters('containers')[copyIndex()]))))]"
              }
            },
            "privateEndpointBlobName": {
              "type": "string",
              "value": "[parameters('privateEndpointBlobName')]"
            },
            "privateEndpointTableName": {
              "type": "string",
              "value": "[parameters('privateEndpointTableName')]"
            },
            "privateEndpointQueueName": {
              "type": "string",
              "value": "[parameters('privateEndpointQueueName')]"
            },
            "storageAccountConnectionStringSecretName": {
              "type": "string",
              "value": "[variables('storageAccountConnectionStringSecretName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('vnet{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('app-identity{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "identityName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.userAssignedIdentityName.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "11253221076614030938"
            }
          },
          "parameters": {
            "identityName": {
              "type": "string",
              "defaultValue": ""
            },
            "existingIdentityName": {
              "type": "string",
              "defaultValue": ""
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "variables": {
            "useExistingIdentity": "[not(empty(parameters('existingIdentityName')))]"
          },
          "resources": [
            {
              "condition": "[not(variables('useExistingIdentity'))]",
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-07-31-preview",
              "name": "[parameters('identityName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "managedIdentityId": {
              "type": "string",
              "value": "[if(variables('useExistingIdentity'), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('existingIdentityName')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')))]"
            },
            "managedIdentityName": {
              "type": "string",
              "value": "[if(variables('useExistingIdentity'), parameters('existingIdentityName'), parameters('identityName'))]"
            },
            "managedIdentityClientId": {
              "type": "string",
              "value": "[if(variables('useExistingIdentity'), reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('existingIdentityName')), '2023-07-31-preview').clientId, reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')), '2023-07-31-preview').clientId)]"
            },
            "managedIdentityPrincipalId": {
              "type": "string",
              "value": "[if(variables('useExistingIdentity'), reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('existingIdentityName')), '2023-07-31-preview').principalId, reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')), '2023-07-31-preview').principalId)]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('addRoleAssignments')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('identity-access{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "identityPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('app-identity{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.managedIdentityPrincipalId.value]"
          },
          "principalType": {
            "value": "ServicePrincipal"
          },
          "registryName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('containerregistry{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "aiSearchName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('search{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "aiServicesName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('openai{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "cosmosName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('cosmos{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "4003898173191536613"
            }
          },
          "parameters": {
            "identityPrincipalId": {
              "type": "string"
            },
            "principalType": {
              "type": "string",
              "defaultValue": "ServicePrincipal",
              "allowedValues": [
                "ServicePrincipal",
                "User"
              ]
            },
            "registryName": {
              "type": "string",
              "defaultValue": ""
            },
            "storageAccountName": {
              "type": "string",
              "defaultValue": ""
            },
            "aiSearchName": {
              "type": "string",
              "defaultValue": ""
            },
            "aiServicesName": {
              "type": "string",
              "defaultValue": ""
            },
            "cosmosName": {
              "type": "string",
              "defaultValue": ""
            },
            "keyVaultName": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "variables": {
            "$fxv#0": {
              "source": {
                "url": "https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles"
              },
              "cosmos": {
                "dataContributorRoleId": "00000000-0000-0000-0000-000000000002"
              },
              "storage": {
                "blobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
                "blobDataOwnerRoleId": "b7e6dc6d-f1e8-4753-8033-0f276bb0955b",
                "storageAccountContributorRoleId": "17d1049b-9a84-46fb-8f53-869881c3d3ab",
                "queueDataContributorRoleId": "974c5e8b-45b9-4653-ba55-5f855dd0fb88",
                "tableContributorRoleId": "0a9a7e1f-b9d0-4cc4-a60d-0319b160aaa3",
                "storageQueueDataMessageSender": "c6a89b2d-59bc-44d0-9896-0f6e12d7b80a"
              },
              "search": {
                "indexDataContributorRoleId": "8ebe5a00-799e-43f5-93ac-243d3dce84a7",
                "indexDataReaderRoleId": "1407120a-92aa-4202-b7e9-c0e197c71c8f",
                "serviceContributorRoleId": "7ca78c08-252a-4471-8644-bb5ff32d4ba0"
              },
              "openai": {
                "cognitiveServicesOpenAIContributorRoleId": "a001fd3d-188f-4b5d-821b-7da978bf7442",
                "cognitiveServicesOpenAIUserRoleId": "5e0bd9bd-7b93-4f28-af87-19fc36ad61bd",
                "cognitiveServicesUserRoleId": "a97b65f3-24c7-4388-baec-2e87135dc908",
                "cognitiveServicesContributorRoleId": "25fbc0a9-bd7c-42a3-aa1a-3b75d497ee68"
              },
              "ml": {
                "dataScientistRole": "f6c7c914-8db3-469d-8ca1-694a8f32e121"
              },
              "containerregistry": {
                "acrPullRoleId": "7f951dda-4ed3-4680-a7ca-43fe172d538d"
              },
              "keyvault": {
                "secretsUserRoleId": "4633458b-17de-408a-b874-0445c86b69e6",
                "secretsOfficerRoleId": "b86a8fe4-44ce-4948-aee5-eccb2c155cd7"
              }
            },
            "roleDefinitions": "[variables('$fxv#0')]",
            "addRegistryRoles": "[not(empty(parameters('registryName')))]",
            "addStorageRoles": "[not(empty(parameters('storageAccountName')))]",
            "addSearchRoles": "[not(empty(parameters('aiSearchName')))]",
            "addCogServicesRoles": "[not(empty(parameters('aiServicesName')))]",
            "addCosmosRoles": "[not(empty(parameters('cosmosName')))]",
            "addKeyVaultRoles": "[not(empty(parameters('keyVaultName')))]"
          },
          "resources": [
            {
              "condition": "[variables('addRegistryRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('registryName'))]",
              "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('registryName')), parameters('identityPrincipalId'), variables('roleDefinitions').containerregistry.acrPullRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "principalType": "[parameters('principalType')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').containerregistry.acrPullRoleId)]",
                "description": "[format('Permission for {0} {1} to pull images from the registry {2}', parameters('principalType'), parameters('identityPrincipalId'), parameters('registryName'))]"
              }
            },
            {
              "condition": "[variables('addStorageRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('identityPrincipalId'), variables('roleDefinitions').storage.blobDataContributorRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "principalType": "[parameters('principalType')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').storage.blobDataContributorRoleId)]",
                "description": "[format('Permission for {0} {1} to write to the storage account {2} Blob', parameters('principalType'), parameters('identityPrincipalId'), parameters('storageAccountName'))]"
              }
            },
            {
              "condition": "[variables('addStorageRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('identityPrincipalId'), variables('roleDefinitions').storage.tableContributorRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "principalType": "[parameters('principalType')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').storage.tableContributorRoleId)]",
                "description": "[format('Permission for {0} {1} to write to the storage account {2} Table', parameters('principalType'), parameters('identityPrincipalId'), parameters('storageAccountName'))]"
              }
            },
            {
              "condition": "[variables('addStorageRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('identityPrincipalId'), variables('roleDefinitions').storage.queueDataContributorRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "principalType": "[parameters('principalType')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').storage.queueDataContributorRoleId)]",
                "description": "[format('Permission for {0} {1} to write to the storage account {2} Queue', parameters('principalType'), parameters('identityPrincipalId'), parameters('storageAccountName'))]"
              }
            },
            {
              "condition": "[variables('addCogServicesRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('aiServicesName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), parameters('identityPrincipalId'), variables('roleDefinitions').openai.cognitiveServicesOpenAIUserRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "principalType": "[parameters('principalType')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').openai.cognitiveServicesOpenAIUserRoleId)]",
                "description": "[format('Permission for {0} {1} to be OpenAI User', parameters('principalType'), parameters('identityPrincipalId'))]"
              }
            },
            {
              "condition": "[variables('addCogServicesRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('aiServicesName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), parameters('identityPrincipalId'), variables('roleDefinitions').openai.cognitiveServicesOpenAIContributorRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "principalType": "[parameters('principalType')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').openai.cognitiveServicesOpenAIContributorRoleId)]",
                "description": "[format('Permission for {0} {1} to be OpenAI Contributor', parameters('principalType'), parameters('identityPrincipalId'))]"
              }
            },
            {
              "condition": "[variables('addCogServicesRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('aiServicesName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), parameters('identityPrincipalId'), variables('roleDefinitions').openai.cognitiveServicesUserRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "principalType": "[parameters('principalType')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').openai.cognitiveServicesUserRoleId)]",
                "description": "[format('Permission for {0} {1} to be a Cognitive Services User', parameters('principalType'), parameters('identityPrincipalId'))]"
              }
            },
            {
              "condition": "[variables('addCogServicesRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('aiServicesName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), parameters('identityPrincipalId'), variables('roleDefinitions').openai.cognitiveServicesContributorRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "principalType": "[parameters('principalType')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').openai.cognitiveServicesContributorRoleId)]",
                "description": "[format('Permission for {0} {1} to be a Cognitive Services Contributor', parameters('principalType'), parameters('identityPrincipalId'))]"
              }
            },
            {
              "condition": "[variables('addSearchRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), parameters('identityPrincipalId'), variables('roleDefinitions').search.indexDataContributorRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').search.indexDataContributorRoleId)]",
                "principalType": "[parameters('principalType')]",
                "description": "[format('Permission for {0} {1} to use the modify search service indexes', parameters('principalType'), parameters('identityPrincipalId'))]"
              }
            },
            {
              "condition": "[variables('addSearchRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), parameters('identityPrincipalId'), variables('roleDefinitions').search.indexDataReaderRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').search.indexDataReaderRoleId)]",
                "principalType": "[parameters('principalType')]",
                "description": "[format('Permission for {0} {1} to use the read search service indexes', parameters('principalType'), parameters('identityPrincipalId'))]"
              }
            },
            {
              "condition": "[variables('addSearchRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), parameters('identityPrincipalId'), variables('roleDefinitions').search.serviceContributorRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').search.serviceContributorRoleId)]",
                "principalType": "[parameters('principalType')]",
                "description": "[format('Permission for {0} {1} to be a search service contributor', parameters('principalType'), parameters('identityPrincipalId'))]"
              }
            },
            {
              "condition": "[variables('addCosmosRoles')]",
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
              "apiVersion": "2024-08-15",
              "name": "[format('{0}/{1}', parameters('cosmosName'), guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosName')), parameters('identityPrincipalId'), variables('roleDefinitions').cosmos.dataContributorRoleId))]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "roleDefinitionId": "[format('{0}/providers/Microsoft.DocumentDB/databaseAccounts/{1}/sqlRoleDefinitions/{2}', resourceGroup().id, parameters('cosmosName'), variables('roleDefinitions').cosmos.dataContributorRoleId)]",
                "scope": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosName'))]"
              }
            },
            {
              "condition": "[variables('addKeyVaultRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('identityPrincipalId'), variables('roleDefinitions').keyvault.secretsOfficerRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').keyvault.secretsOfficerRoleId)]",
                "principalType": "[parameters('principalType')]",
                "description": "[format('Permission for {0} {1} to be a Key Vault Secrets Officer', parameters('principalType'), parameters('identityPrincipalId'))]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('containerregistry{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('cosmos{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('app-identity{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('openai{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('search{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "condition": "[and(parameters('addRoleAssignments'), not(empty(parameters('principalId'))))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('user-access{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "identityPrincipalId": {
            "value": "[parameters('principalId')]"
          },
          "principalType": {
            "value": "User"
          },
          "registryName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('containerregistry{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "aiSearchName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('search{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "aiServicesName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('openai{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "cosmosName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('cosmos{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "4003898173191536613"
            }
          },
          "parameters": {
            "identityPrincipalId": {
              "type": "string"
            },
            "principalType": {
              "type": "string",
              "defaultValue": "ServicePrincipal",
              "allowedValues": [
                "ServicePrincipal",
                "User"
              ]
            },
            "registryName": {
              "type": "string",
              "defaultValue": ""
            },
            "storageAccountName": {
              "type": "string",
              "defaultValue": ""
            },
            "aiSearchName": {
              "type": "string",
              "defaultValue": ""
            },
            "aiServicesName": {
              "type": "string",
              "defaultValue": ""
            },
            "cosmosName": {
              "type": "string",
              "defaultValue": ""
            },
            "keyVaultName": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "variables": {
            "$fxv#0": {
              "source": {
                "url": "https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles"
              },
              "cosmos": {
                "dataContributorRoleId": "00000000-0000-0000-0000-000000000002"
              },
              "storage": {
                "blobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
                "blobDataOwnerRoleId": "b7e6dc6d-f1e8-4753-8033-0f276bb0955b",
                "storageAccountContributorRoleId": "17d1049b-9a84-46fb-8f53-869881c3d3ab",
                "queueDataContributorRoleId": "974c5e8b-45b9-4653-ba55-5f855dd0fb88",
                "tableContributorRoleId": "0a9a7e1f-b9d0-4cc4-a60d-0319b160aaa3",
                "storageQueueDataMessageSender": "c6a89b2d-59bc-44d0-9896-0f6e12d7b80a"
              },
              "search": {
                "indexDataContributorRoleId": "8ebe5a00-799e-43f5-93ac-243d3dce84a7",
                "indexDataReaderRoleId": "1407120a-92aa-4202-b7e9-c0e197c71c8f",
                "serviceContributorRoleId": "7ca78c08-252a-4471-8644-bb5ff32d4ba0"
              },
              "openai": {
                "cognitiveServicesOpenAIContributorRoleId": "a001fd3d-188f-4b5d-821b-7da978bf7442",
                "cognitiveServicesOpenAIUserRoleId": "5e0bd9bd-7b93-4f28-af87-19fc36ad61bd",
                "cognitiveServicesUserRoleId": "a97b65f3-24c7-4388-baec-2e87135dc908",
                "cognitiveServicesContributorRoleId": "25fbc0a9-bd7c-42a3-aa1a-3b75d497ee68"
              },
              "ml": {
                "dataScientistRole": "f6c7c914-8db3-469d-8ca1-694a8f32e121"
              },
              "containerregistry": {
                "acrPullRoleId": "7f951dda-4ed3-4680-a7ca-43fe172d538d"
              },
              "keyvault": {
                "secretsUserRoleId": "4633458b-17de-408a-b874-0445c86b69e6",
                "secretsOfficerRoleId": "b86a8fe4-44ce-4948-aee5-eccb2c155cd7"
              }
            },
            "roleDefinitions": "[variables('$fxv#0')]",
            "addRegistryRoles": "[not(empty(parameters('registryName')))]",
            "addStorageRoles": "[not(empty(parameters('storageAccountName')))]",
            "addSearchRoles": "[not(empty(parameters('aiSearchName')))]",
            "addCogServicesRoles": "[not(empty(parameters('aiServicesName')))]",
            "addCosmosRoles": "[not(empty(parameters('cosmosName')))]",
            "addKeyVaultRoles": "[not(empty(parameters('keyVaultName')))]"
          },
          "resources": [
            {
              "condition": "[variables('addRegistryRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('registryName'))]",
              "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('registryName')), parameters('identityPrincipalId'), variables('roleDefinitions').containerregistry.acrPullRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "principalType": "[parameters('principalType')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').containerregistry.acrPullRoleId)]",
                "description": "[format('Permission for {0} {1} to pull images from the registry {2}', parameters('principalType'), parameters('identityPrincipalId'), parameters('registryName'))]"
              }
            },
            {
              "condition": "[variables('addStorageRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('identityPrincipalId'), variables('roleDefinitions').storage.blobDataContributorRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "principalType": "[parameters('principalType')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').storage.blobDataContributorRoleId)]",
                "description": "[format('Permission for {0} {1} to write to the storage account {2} Blob', parameters('principalType'), parameters('identityPrincipalId'), parameters('storageAccountName'))]"
              }
            },
            {
              "condition": "[variables('addStorageRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('identityPrincipalId'), variables('roleDefinitions').storage.tableContributorRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "principalType": "[parameters('principalType')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').storage.tableContributorRoleId)]",
                "description": "[format('Permission for {0} {1} to write to the storage account {2} Table', parameters('principalType'), parameters('identityPrincipalId'), parameters('storageAccountName'))]"
              }
            },
            {
              "condition": "[variables('addStorageRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('identityPrincipalId'), variables('roleDefinitions').storage.queueDataContributorRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "principalType": "[parameters('principalType')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').storage.queueDataContributorRoleId)]",
                "description": "[format('Permission for {0} {1} to write to the storage account {2} Queue', parameters('principalType'), parameters('identityPrincipalId'), parameters('storageAccountName'))]"
              }
            },
            {
              "condition": "[variables('addCogServicesRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('aiServicesName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), parameters('identityPrincipalId'), variables('roleDefinitions').openai.cognitiveServicesOpenAIUserRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "principalType": "[parameters('principalType')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').openai.cognitiveServicesOpenAIUserRoleId)]",
                "description": "[format('Permission for {0} {1} to be OpenAI User', parameters('principalType'), parameters('identityPrincipalId'))]"
              }
            },
            {
              "condition": "[variables('addCogServicesRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('aiServicesName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), parameters('identityPrincipalId'), variables('roleDefinitions').openai.cognitiveServicesOpenAIContributorRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "principalType": "[parameters('principalType')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').openai.cognitiveServicesOpenAIContributorRoleId)]",
                "description": "[format('Permission for {0} {1} to be OpenAI Contributor', parameters('principalType'), parameters('identityPrincipalId'))]"
              }
            },
            {
              "condition": "[variables('addCogServicesRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('aiServicesName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), parameters('identityPrincipalId'), variables('roleDefinitions').openai.cognitiveServicesUserRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "principalType": "[parameters('principalType')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').openai.cognitiveServicesUserRoleId)]",
                "description": "[format('Permission for {0} {1} to be a Cognitive Services User', parameters('principalType'), parameters('identityPrincipalId'))]"
              }
            },
            {
              "condition": "[variables('addCogServicesRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('aiServicesName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), parameters('identityPrincipalId'), variables('roleDefinitions').openai.cognitiveServicesContributorRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "principalType": "[parameters('principalType')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').openai.cognitiveServicesContributorRoleId)]",
                "description": "[format('Permission for {0} {1} to be a Cognitive Services Contributor', parameters('principalType'), parameters('identityPrincipalId'))]"
              }
            },
            {
              "condition": "[variables('addSearchRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), parameters('identityPrincipalId'), variables('roleDefinitions').search.indexDataContributorRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').search.indexDataContributorRoleId)]",
                "principalType": "[parameters('principalType')]",
                "description": "[format('Permission for {0} {1} to use the modify search service indexes', parameters('principalType'), parameters('identityPrincipalId'))]"
              }
            },
            {
              "condition": "[variables('addSearchRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), parameters('identityPrincipalId'), variables('roleDefinitions').search.indexDataReaderRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').search.indexDataReaderRoleId)]",
                "principalType": "[parameters('principalType')]",
                "description": "[format('Permission for {0} {1} to use the read search service indexes', parameters('principalType'), parameters('identityPrincipalId'))]"
              }
            },
            {
              "condition": "[variables('addSearchRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('aiSearchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('aiSearchName')), parameters('identityPrincipalId'), variables('roleDefinitions').search.serviceContributorRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').search.serviceContributorRoleId)]",
                "principalType": "[parameters('principalType')]",
                "description": "[format('Permission for {0} {1} to be a search service contributor', parameters('principalType'), parameters('identityPrincipalId'))]"
              }
            },
            {
              "condition": "[variables('addCosmosRoles')]",
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
              "apiVersion": "2024-08-15",
              "name": "[format('{0}/{1}', parameters('cosmosName'), guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosName')), parameters('identityPrincipalId'), variables('roleDefinitions').cosmos.dataContributorRoleId))]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "roleDefinitionId": "[format('{0}/providers/Microsoft.DocumentDB/databaseAccounts/{1}/sqlRoleDefinitions/{2}', resourceGroup().id, parameters('cosmosName'), variables('roleDefinitions').cosmos.dataContributorRoleId)]",
                "scope": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosName'))]"
              }
            },
            {
              "condition": "[variables('addKeyVaultRoles')]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('identityPrincipalId'), variables('roleDefinitions').keyvault.secretsOfficerRoleId)]",
              "properties": {
                "principalId": "[parameters('identityPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').keyvault.secretsOfficerRoleId)]",
                "principalType": "[parameters('principalType')]",
                "description": "[format('Permission for {0} {1} to be a Key Vault Secrets Officer', parameters('principalType'), parameters('identityPrincipalId'))]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('containerregistry{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('cosmos{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('openai{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('search{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('keyvault{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "commonTags": {
            "value": "[variables('tags')]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.keyVaultName.value]"
          },
          "keyVaultOwnerUserId": {
            "value": "[parameters('principalId')]"
          },
          "adminUserObjectIds": {
            "value": [
              "[reference(resourceId('Microsoft.Resources/deployments', format('app-identity{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.managedIdentityPrincipalId.value]"
            ]
          },
          "publicNetworkAccess": "[if(parameters('publicAccessEnabled'), createObject('value', 'Enabled'), createObject('value', 'Disabled'))]",
          "keyVaultOwnerIpAddress": {
            "value": "[parameters('myIpAddress')]"
          },
          "createUserAssignedIdentity": {
            "value": false
          },
          "privateEndpointName": {
            "value": "[format('pe-{0}', reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.keyVaultName.value)]"
          },
          "privateEndpointSubnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('vnet{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.subnetAppGwResourceID.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "2087449899996998266"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string",
              "defaultValue": ""
            },
            "existingKeyVaultName": {
              "type": "string",
              "defaultValue": ""
            },
            "existingKeyVaultResourceGroupName": {
              "type": "string",
              "defaultValue": ""
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "commonTags": {
              "type": "object",
              "defaultValue": {}
            },
            "adminUserObjectIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Administrators that should have access to administer key vault"
              }
            },
            "applicationUserObjectIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Application that should have access to read key vault secrets"
              }
            },
            "keyVaultOwnerUserId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Administrator UserId that should have access to administer key vault"
              }
            },
            "keyVaultOwnerIpAddress": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Ip Address of the KV owner so they can read the vault, such as 254.254.254.254/32"
              }
            },
            "enabledForDeployment": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Determines if Azure can deploy certificates from this Key Vault."
              }
            },
            "enabledForTemplateDeployment": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Determines if templates can reference secrets from this Key Vault."
              }
            },
            "enabledForDiskEncryption": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Determines if this Key Vault can be used for Azure Disk Encryption."
              }
            },
            "enableSoftDelete": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Determine if soft delete is enabled on this Key Vault."
              }
            },
            "enablePurgeProtection": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Determine if purge protection is enabled on this Key Vault."
              }
            },
            "softDeleteRetentionInDays": {
              "type": "int",
              "defaultValue": 7,
              "metadata": {
                "description": "The number of days to retain soft deleted vaults and vault objects."
              }
            },
            "useRBAC": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Determines if access to the objects granted using RBAC. When true, access policies are ignored."
              }
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": "Enabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ]
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "privateEndpointName": {
              "type": "string",
              "defaultValue": ""
            },
            "createUserAssignedIdentity": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Create a user assigned identity that can be used to verify and update secrets in future steps"
              }
            },
            "userAssignedIdentityName": {
              "type": "string",
              "defaultValue": "[format('{0}-cicd', parameters('keyVaultName'))]",
              "metadata": {
                "description": "Override the default user assigned identity user name if you need to"
              }
            },
            "createDaprIdentity": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Create a user assigned identity that DAPR can use to read secrets"
              }
            },
            "daprIdentityName": {
              "type": "string",
              "defaultValue": "[format('{0}-dapr', parameters('keyVaultName'))]",
              "metadata": {
                "description": "Override the default DAPR identity user name if you need to"
              }
            },
            "workspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "strongType": "Microsoft.OperationalInsights/workspaces",
                "example": "/subscriptions/<subscription_id>/resourceGroups/<resource_group>/providers/Microsoft.OperationalInsights/workspaces/<workspace_name>",
                "description": "The workspace to store audit logs."
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "adminAccessPolicies",
                "count": "[length(parameters('adminUserObjectIds'))]",
                "input": {
                  "objectId": "[parameters('adminUserObjectIds')[copyIndex('adminAccessPolicies')]]",
                  "tenantId": "[variables('subTenantId')]",
                  "permissions": {
                    "certificates": [
                      "all"
                    ],
                    "secrets": [
                      "all"
                    ],
                    "keys": [
                      "all"
                    ]
                  }
                }
              },
              {
                "name": "applicationUserPolicies",
                "count": "[length(parameters('applicationUserObjectIds'))]",
                "input": {
                  "objectId": "[parameters('applicationUserObjectIds')[copyIndex('applicationUserPolicies')]]",
                  "tenantId": "[variables('subTenantId')]",
                  "permissions": {
                    "secrets": [
                      "get"
                    ],
                    "keys": [
                      "get",
                      "wrapKey",
                      "unwrapKey"
                    ]
                  }
                }
              }
            ],
            "useExistingVault": "[not(empty(parameters('existingKeyVaultName')))]",
            "templateTag": {
              "TemplateFile": "~keyvault.bicep"
            },
            "tags": "[union(parameters('commonTags'), variables('templateTag'))]",
            "skuName": "standard",
            "subTenantId": "[subscription().tenantId]",
            "ownerAccessPolicy": "[if(equals(parameters('keyVaultOwnerUserId'), ''), createArray(), createArray(createObject('objectId', parameters('keyVaultOwnerUserId'), 'tenantId', variables('subTenantId'), 'permissions', createObject('certificates', createArray('all'), 'secrets', createArray('all'), 'keys', createArray('all')))))]",
            "accessPolicies": "[union(variables('ownerAccessPolicy'), variables('adminAccessPolicies'), variables('applicationUserPolicies'))]",
            "kvIpRules": "[if(equals(parameters('keyVaultOwnerIpAddress'), ''), createArray(), createArray(createObject('value', parameters('keyVaultOwnerIpAddress'))))]"
          },
          "resources": [
            {
              "condition": "[not(variables('useExistingVault'))]",
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2021-11-01-preview",
              "name": "[parameters('keyVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[variables('tags')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "[variables('skuName')]"
                },
                "tenantId": "[variables('subTenantId')]",
                "enableRbacAuthorization": "[parameters('useRBAC')]",
                "accessPolicies": "[if(parameters('useRBAC'), createArray(), variables('accessPolicies'))]",
                "enabledForDeployment": "[parameters('enabledForDeployment')]",
                "enabledForDiskEncryption": "[parameters('enabledForDiskEncryption')]",
                "enabledForTemplateDeployment": "[parameters('enabledForTemplateDeployment')]",
                "enableSoftDelete": "[parameters('enableSoftDelete')]",
                "enablePurgeProtection": "[parameters('enablePurgeProtection')]",
                "createMode": "default",
                "softDeleteRetentionInDays": "[parameters('softDeleteRetentionInDays')]",
                "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                "networkAcls": {
                  "defaultAction": "[if(equals(parameters('publicNetworkAccess'), 'Enabled'), 'Allow', 'Deny')]",
                  "bypass": "AzureServices",
                  "ipRules": "[variables('kvIpRules')]",
                  "virtualNetworkRules": []
                }
              }
            },
            {
              "condition": "[and(not(variables('useExistingVault')), parameters('createUserAssignedIdentity'))]",
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2022-01-31-preview",
              "name": "[parameters('userAssignedIdentityName')]",
              "location": "[parameters('location')]"
            },
            {
              "condition": "[and(not(variables('useExistingVault')), parameters('createDaprIdentity'))]",
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2022-01-31-preview",
              "name": "[parameters('daprIdentityName')]",
              "location": "[parameters('location')]"
            },
            {
              "condition": "[and(not(variables('useExistingVault')), or(parameters('createUserAssignedIdentity'), parameters('createDaprIdentity')))]",
              "type": "Microsoft.KeyVault/vaults/accessPolicies",
              "apiVersion": "2022-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'add')]",
              "properties": {
                "accessPolicies": "[union(if(not(parameters('createUserAssignedIdentity')), createArray(), createArray(createObject('tenantId', reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName')), '2022-01-31-preview').tenantId, 'objectId', reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName')), '2022-01-31-preview').principalId, 'permissions', createObject('secrets', createArray('get', 'list', 'set'))))), if(not(parameters('createDaprIdentity')), createArray(), createArray(createObject('tenantId', reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('daprIdentityName')), '2022-01-31-preview').tenantId, 'objectId', reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('daprIdentityName')), '2022-01-31-preview').principalId, 'permissions', createObject('secrets', createArray('get', 'list'))))))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('daprIdentityName'))]",
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName'))]"
              ]
            },
            {
              "condition": "[and(not(variables('useExistingVault')), not(equals(parameters('workspaceId'), '')))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[format('{0}-auditlogs', parameters('keyVaultName'))]",
              "properties": {
                "workspaceId": "[parameters('workspaceId')]",
                "logs": [
                  {
                    "category": "AuditEvent",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "condition": "[and(not(variables('useExistingVault')), not(equals(parameters('workspaceId'), '')))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[format('{0}-metrics', parameters('keyVaultName'))]",
              "properties": {
                "workspaceId": "[parameters('workspaceId')]",
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "condition": "[and(not(variables('useExistingVault')), not(empty(parameters('privateEndpointSubnetId'))))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-private-endpoint', parameters('keyVaultName'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "privateEndpointName": {
                    "value": "[parameters('privateEndpointName')]"
                  },
                  "groupIds": {
                    "value": [
                      "vault"
                    ]
                  },
                  "targetResourceId": {
                    "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                  },
                  "subnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "6191151302122753297"
                    }
                  },
                  "parameters": {
                    "privateEndpointName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the private endpoint to create"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "The region where the private endpoint will be created"
                      }
                    },
                    "subnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "The ID of the subnet where the private endpoint will be created"
                      }
                    },
                    "targetResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The ID of the resource to which the private endpoint will be connected"
                      }
                    },
                    "groupIds": {
                      "type": "array",
                      "metadata": {
                        "description": "An array of group IDs of the service type that they private endpoint will be connect to"
                      }
                    },
                    "dnsZoneId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "The resource ID of the private DNS zone for this resource"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "The tags to associate with the private endpoint"
                      }
                    }
                  },
                  "variables": {
                    "nicName": "[format('{0}-nic', parameters('privateEndpointName'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('privateEndpointName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "customNetworkInterfaceName": "[variables('nicName')]",
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[parameters('privateEndpointName')]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('targetResourceId')]",
                              "groupIds": "[parameters('groupIds')]"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "condition": "[not(equals(parameters('dnsZoneId'), ''))]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2023-06-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointName'), format('{0}-dns-group', parameters('privateEndpointName')))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "default",
                            "properties": {
                              "privateDnsZoneId": "[parameters('dnsZoneId')]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateEndpointId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                    },
                    "privateEndpointName": {
                      "type": "string",
                      "value": "[parameters('privateEndpointName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[if(variables('useExistingVault'), parameters('existingKeyVaultName'), parameters('keyVaultName'))]"
            },
            "resourceGroupName": {
              "type": "string",
              "value": "[if(variables('useExistingVault'), parameters('existingKeyVaultResourceGroupName'), resourceGroup().name)]"
            },
            "id": {
              "type": "string",
              "value": "[if(variables('useExistingVault'), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingKeyVaultResourceGroupName')), 'Microsoft.KeyVault/vaults', parameters('existingKeyVaultName')), resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')))]"
            },
            "userManagedIdentityId": {
              "type": "string",
              "value": "[if(variables('useExistingVault'), '', if(parameters('createUserAssignedIdentity'), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName')), ''))]"
            },
            "endpoint": {
              "type": "string",
              "value": "[if(variables('useExistingVault'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingKeyVaultResourceGroupName')), 'Microsoft.KeyVault/vaults', parameters('existingKeyVaultName')), '2021-11-01-preview').vaultUri, reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2021-11-01-preview').vaultUri)]"
            },
            "privateEndpointName": {
              "type": "string",
              "value": "[if(variables('useExistingVault'), '', parameters('privateEndpointName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('app-identity{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('vnet{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "condition": "[variables('deduplicateKVSecrets')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('keyVault-Secret-List-Names{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('keyvault{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "userManagedIdentityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('app-identity{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.managedIdentityId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "13465588566702516129"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string",
              "defaultValue": "myKeyVault"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "utcValue": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            },
            "userManagedIdentityId": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2023-08-01",
              "name": "getKeyVaultSecretNameList",
              "location": "[parameters('location')]",
              "kind": "AzurePowerShell",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('userManagedIdentityId'))]": {}
                }
              },
              "properties": {
                "azPowerShellVersion": "8.1",
                "forceUpdateTag": "[parameters('utcValue')]",
                "retentionInterval": "PT1H",
                "timeout": "PT5M",
                "cleanupPreference": "Always",
                "arguments": "[format(' -KeyVaultName {0}', parameters('keyVaultName'))]",
                "scriptContent": "      Param ([string] $KeyVaultName)\r\n      $startDate = Get-Date\r\n      $startTime = [System.Diagnostics.Stopwatch]::StartNew()\r\n      $message = \"\"\r\n      $message = \"Getting names of secrets in vault: $($KeyVaultName)...\"\r\n      $secretList = Get-AzKeyVaultSecret -VaultName $KeyVaultName | Select Name\r\n      $secretListFull = \";\" + ((-split $secretList) -join \";\") + \";\"\r\n      $secretListString = $secretListFull.replace(\"@{Name=\", \"\").replace(\"}\", \"\")\r\n      $endDate = Get-Date\r\n      $endTime = $startTime.Elapsed;\r\n      $elapsedTime = \"Script Elapsed Time: {0:HH:mm:ss}\" -f ([datetime]$endTime.Ticks)\r\n      $elapsedTime += \"; Start: {0:HH:mm:ss}\" -f ([datetime]$startDate)\r\n      $elapsedTime += \"; End: {0:HH:mm:ss}\" -f ([datetime]$endDate)\r\n      Write-Output $message\r\n      Write-Output $secretListString\r\n      Write-Output $elapsedTime\r\n      $DeploymentScriptOutputs = @{}\r\n      $DeploymentScriptOutputs['message'] = $message\r\n      $DeploymentScriptOutputs['secretList'] = $secretListString\r\n      $DeploymentScriptOutputs['elapsed'] = $elapsedTime\r\n      "
              }
            }
          ],
          "outputs": {
            "message": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', 'getKeyVaultSecretNameList'), '2023-08-01').outputs.message]"
            },
            "secretNameList": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', 'getKeyVaultSecretNameList'), '2023-08-01').outputs.secretList]"
            },
            "elapsed": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', 'getKeyVaultSecretNameList'), '2023-08-01').outputs.elapsed]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('app-identity{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('keyvault{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('secret-api-key{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('keyvault{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "secretName": {
            "value": "api-key"
          },
          "existingSecretNames": "[if(variables('deduplicateKVSecrets'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', format('keyVault-Secret-List-Names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.secretNameList.value), createObject('value', ''))]",
          "secretValue": {
            "value": "[variables('apiKeyValue')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "13404705537968214730"
            },
            "description": "Creates or updates a secret in an Azure Key Vault."
          },
          "parameters": {
            "keyVaultName": {
              "type": "string"
            },
            "secretName": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "contentType": {
              "type": "string",
              "defaultValue": "string"
            },
            "secretValue": {
              "type": "securestring",
              "metadata": {
                "description": "The value of the secret. Provide only derived values like blob storage access, but do not hard code any secrets in your templates"
              }
            },
            "existingSecretNames": {
              "type": "string",
              "defaultValue": ""
            },
            "forceSecretCreation": {
              "type": "bool",
              "defaultValue": false
            },
            "enabled": {
              "type": "bool",
              "defaultValue": true
            },
            "enabledDate": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            },
            "expirationDate": {
              "type": "string",
              "defaultValue": "[dateTimeAdd(utcNow(), 'P2Y')]"
            }
          },
          "variables": {
            "secretExists": "[contains(toLower(parameters('existingSecretNames')), format(';{0};', toLower(trim(parameters('secretName')))))]",
            "createMessage": "[if(variables('secretExists'), format('Secret {0} already exists!', parameters('secretName')), format('Added secret {0}!', parameters('secretName')))]"
          },
          "resources": [
            {
              "condition": "[or(not(variables('secretExists')), parameters('forceSecretCreation'))]",
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretName'))]",
              "tags": "[parameters('tags')]",
              "properties": {
                "attributes": {
                  "enabled": "[parameters('enabled')]",
                  "exp": "[dateTimeToEpoch(parameters('expirationDate'))]",
                  "nbf": "[dateTimeToEpoch(parameters('enabledDate'))]"
                },
                "contentType": "[parameters('contentType')]",
                "value": "[parameters('secretValue')]"
              }
            }
          ],
          "outputs": {
            "message": {
              "type": "string",
              "value": "[if(and(variables('secretExists'), parameters('forceSecretCreation')), format('Secret {0} already exists but was recreated!', parameters('secretName')), variables('createMessage'))]"
            },
            "secretCreated": {
              "type": "bool",
              "value": "[not(variables('secretExists'))]"
            },
            "secretUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('secretName')), '2023-07-01').secretUri]"
            },
            "secretName": {
              "type": "string",
              "value": "[parameters('secretName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('keyvault{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('keyVault-Secret-List-Names{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('secret-cosmos{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('keyvault{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "secretName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('cosmos{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.keyVaultSecretName.value]"
          },
          "cosmosAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('cosmos{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "existingSecretNames": "[if(variables('deduplicateKVSecrets'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', format('keyVault-Secret-List-Names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.secretNameList.value), createObject('value', ''))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "620680939554377236"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string"
            },
            "secretName": {
              "type": "string"
            },
            "cosmosAccountName": {
              "type": "string"
            },
            "cosmosAccountResourceGroup": {
              "type": "string",
              "defaultValue": "[resourceGroup().name]"
            },
            "enabledDate": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            },
            "expirationDate": {
              "type": "string",
              "defaultValue": "[dateTimeAdd(utcNow(), 'P2Y')]"
            },
            "existingSecretNames": {
              "type": "string",
              "defaultValue": ""
            },
            "forceSecretCreation": {
              "type": "bool",
              "defaultValue": false
            }
          },
          "variables": {
            "secretExists": "[contains(toLower(parameters('existingSecretNames')), format(';{0};', toLower(trim(parameters('secretName')))))]",
            "createMessage": "[if(variables('secretExists'), format('Secret {0} already exists!', parameters('secretName')), format('Added secret {0}!', parameters('secretName')))]"
          },
          "resources": [
            {
              "condition": "[or(not(variables('secretExists')), parameters('forceSecretCreation'))]",
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretName'))]",
              "properties": {
                "value": "[listKeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('cosmosAccountResourceGroup')), 'Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName')), '2024-11-15').primaryMasterKey]",
                "attributes": {
                  "exp": "[dateTimeToEpoch(parameters('expirationDate'))]",
                  "nbf": "[dateTimeToEpoch(parameters('enabledDate'))]"
                }
              }
            }
          ],
          "outputs": {
            "message": {
              "type": "string",
              "value": "[if(and(variables('secretExists'), parameters('forceSecretCreation')), format('Secret {0} already exists but was recreated!', parameters('secretName')), variables('createMessage'))]"
            },
            "secretCreated": {
              "type": "bool",
              "value": "[not(variables('secretExists'))]"
            },
            "secretUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('secretName')), '2023-07-01').secretUri]"
            },
            "secretName": {
              "type": "string",
              "value": "[parameters('secretName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('cosmos{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('keyvault{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('keyVault-Secret-List-Names{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('secret-storage{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('keyvault{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "secretName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.storageAccountConnectionStringSecretName.value]"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "existingSecretNames": "[if(variables('deduplicateKVSecrets'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', format('keyVault-Secret-List-Names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.secretNameList.value), createObject('value', ''))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "14905888075316194352"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string"
            },
            "secretName": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "storageAccountResourceGroup": {
              "type": "string",
              "defaultValue": "[resourceGroup().name]"
            },
            "enabledDate": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            },
            "expirationDate": {
              "type": "string",
              "defaultValue": "[dateTimeAdd(utcNow(), 'P2Y')]"
            },
            "existingSecretNames": {
              "type": "string",
              "defaultValue": ""
            },
            "forceSecretCreation": {
              "type": "bool",
              "defaultValue": false
            }
          },
          "variables": {
            "secretExists": "[contains(toLower(parameters('existingSecretNames')), format(';{0};', toLower(trim(parameters('secretName')))))]",
            "createMessage": "[if(variables('secretExists'), format('Secret {0} already exists!', parameters('secretName')), format('Added secret {0}!', parameters('secretName')))]"
          },
          "resources": [
            {
              "condition": "[or(not(variables('secretExists')), parameters('forceSecretCreation'))]",
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-04-01-preview",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretName'))]",
              "properties": {
                "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', parameters('storageAccountName'), environment().suffixes.storage, listKeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('storageAccountResourceGroup')), 'Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2021-04-01').keys[0].value)]",
                "attributes": {
                  "exp": "[dateTimeToEpoch(parameters('expirationDate'))]",
                  "nbf": "[dateTimeToEpoch(parameters('enabledDate'))]"
                }
              }
            }
          ],
          "outputs": {
            "message": {
              "type": "string",
              "value": "[if(and(variables('secretExists'), parameters('forceSecretCreation')), format('Secret {0} already exists but was recreated!', parameters('secretName')), variables('createMessage'))]"
            },
            "secretCreated": {
              "type": "bool",
              "value": "[not(variables('secretExists'))]"
            },
            "secretUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('secretName')), '2021-04-01-preview').secretUri]"
            },
            "secretName": {
              "type": "string",
              "value": "[parameters('secretName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('keyvault{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('keyVault-Secret-List-Names{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('secret-openai{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('keyvault{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "secretName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('openai{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.cognitiveServicesKeySecretName.value]"
          },
          "cognitiveServiceName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('openai{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "cognitiveServiceResourceGroup": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('openai{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.resourceGroupName.value]"
          },
          "existingSecretNames": "[if(variables('deduplicateKVSecrets'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', format('keyVault-Secret-List-Names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.secretNameList.value), createObject('value', ''))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "16919905391426073500"
            },
            "description": "Creates or updates a secret in an Azure Key Vault."
          },
          "parameters": {
            "keyVaultName": {
              "type": "string"
            },
            "secretName": {
              "type": "string"
            },
            "cognitiveServiceName": {
              "type": "string"
            },
            "cognitiveServiceResourceGroup": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "contentType": {
              "type": "string",
              "defaultValue": "string"
            },
            "enabledDate": {
              "type": "string",
              "defaultValue": "[utcNow()]",
              "metadata": {
                "description": "The value of the secret. Provide only derived values like blob storage access, but do not hard code any secrets in your templates"
              }
            },
            "expirationDate": {
              "type": "string",
              "defaultValue": "[dateTimeAdd(utcNow(), 'P2Y')]"
            },
            "existingSecretNames": {
              "type": "string",
              "defaultValue": ""
            },
            "forceSecretCreation": {
              "type": "bool",
              "defaultValue": false
            },
            "enabled": {
              "type": "bool",
              "defaultValue": true
            }
          },
          "variables": {
            "secretExists": "[contains(toLower(parameters('existingSecretNames')), format(';{0};', toLower(trim(parameters('secretName')))))]",
            "createMessage": "[if(variables('secretExists'), format('Secret {0} already exists!', parameters('secretName')), format('Added secret {0}!', parameters('secretName')))]"
          },
          "resources": [
            {
              "condition": "[or(not(variables('secretExists')), parameters('forceSecretCreation'))]",
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretName'))]",
              "tags": "[parameters('tags')]",
              "properties": {
                "attributes": {
                  "enabled": "[parameters('enabled')]",
                  "exp": "[dateTimeToEpoch(parameters('expirationDate'))]",
                  "nbf": "[dateTimeToEpoch(parameters('enabledDate'))]"
                },
                "contentType": "[parameters('contentType')]",
                "value": "[listKeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('cognitiveServiceResourceGroup')), 'Microsoft.CognitiveServices/accounts', parameters('cognitiveServiceName')), '2024-10-01').key1]"
              }
            }
          ],
          "outputs": {
            "message": {
              "type": "string",
              "value": "[if(and(variables('secretExists'), parameters('forceSecretCreation')), format('Secret {0} already exists but was recreated!', parameters('secretName')), variables('createMessage'))]"
            },
            "secretCreated": {
              "type": "bool",
              "value": "[not(variables('secretExists'))]"
            },
            "secretUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('secretName')), '2023-07-01').secretUri]"
            },
            "secretName": {
              "type": "string",
              "value": "[parameters('secretName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('keyvault{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('keyVault-Secret-List-Names{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('openai{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('secret-doc-intelligence{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('keyvault{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "secretName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('doc-intelligence{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.keyVaultSecretName.value]"
          },
          "cognitiveServiceName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('doc-intelligence{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "cognitiveServiceResourceGroup": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('doc-intelligence{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.resourceGroupName.value]"
          },
          "existingSecretNames": "[if(variables('deduplicateKVSecrets'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', format('keyVault-Secret-List-Names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.secretNameList.value), createObject('value', ''))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "16919905391426073500"
            },
            "description": "Creates or updates a secret in an Azure Key Vault."
          },
          "parameters": {
            "keyVaultName": {
              "type": "string"
            },
            "secretName": {
              "type": "string"
            },
            "cognitiveServiceName": {
              "type": "string"
            },
            "cognitiveServiceResourceGroup": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "contentType": {
              "type": "string",
              "defaultValue": "string"
            },
            "enabledDate": {
              "type": "string",
              "defaultValue": "[utcNow()]",
              "metadata": {
                "description": "The value of the secret. Provide only derived values like blob storage access, but do not hard code any secrets in your templates"
              }
            },
            "expirationDate": {
              "type": "string",
              "defaultValue": "[dateTimeAdd(utcNow(), 'P2Y')]"
            },
            "existingSecretNames": {
              "type": "string",
              "defaultValue": ""
            },
            "forceSecretCreation": {
              "type": "bool",
              "defaultValue": false
            },
            "enabled": {
              "type": "bool",
              "defaultValue": true
            }
          },
          "variables": {
            "secretExists": "[contains(toLower(parameters('existingSecretNames')), format(';{0};', toLower(trim(parameters('secretName')))))]",
            "createMessage": "[if(variables('secretExists'), format('Secret {0} already exists!', parameters('secretName')), format('Added secret {0}!', parameters('secretName')))]"
          },
          "resources": [
            {
              "condition": "[or(not(variables('secretExists')), parameters('forceSecretCreation'))]",
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretName'))]",
              "tags": "[parameters('tags')]",
              "properties": {
                "attributes": {
                  "enabled": "[parameters('enabled')]",
                  "exp": "[dateTimeToEpoch(parameters('expirationDate'))]",
                  "nbf": "[dateTimeToEpoch(parameters('enabledDate'))]"
                },
                "contentType": "[parameters('contentType')]",
                "value": "[listKeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('cognitiveServiceResourceGroup')), 'Microsoft.CognitiveServices/accounts', parameters('cognitiveServiceName')), '2024-10-01').key1]"
              }
            }
          ],
          "outputs": {
            "message": {
              "type": "string",
              "value": "[if(and(variables('secretExists'), parameters('forceSecretCreation')), format('Secret {0} already exists but was recreated!', parameters('secretName')), variables('createMessage'))]"
            },
            "secretCreated": {
              "type": "bool",
              "value": "[not(variables('secretExists'))]"
            },
            "secretUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('secretName')), '2023-07-01').secretUri]"
            },
            "secretName": {
              "type": "string",
              "value": "[parameters('secretName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('doc-intelligence{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('keyvault{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('keyVault-Secret-List-Names{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('secret-search{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('keyvault{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "secretName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('search{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.keyVaultSecretName.value]"
          },
          "searchServiceName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('search{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "searchServiceResourceGroup": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('search{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.resourceGroupName.value]"
          },
          "existingSecretNames": "[if(variables('deduplicateKVSecrets'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', format('keyVault-Secret-List-Names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.secretNameList.value), createObject('value', ''))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "3094857296601877057"
            },
            "description": "Creates or updates a secret in an Azure Key Vault."
          },
          "parameters": {
            "keyVaultName": {
              "type": "string"
            },
            "secretName": {
              "type": "string"
            },
            "searchServiceName": {
              "type": "string"
            },
            "searchServiceResourceGroup": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "contentType": {
              "type": "string",
              "defaultValue": "string"
            },
            "enabledDate": {
              "type": "string",
              "defaultValue": "[utcNow()]"
            },
            "expirationDate": {
              "type": "string",
              "defaultValue": "[dateTimeAdd(utcNow(), 'P2Y')]"
            },
            "existingSecretNames": {
              "type": "string",
              "defaultValue": ""
            },
            "forceSecretCreation": {
              "type": "bool",
              "defaultValue": false
            },
            "enabled": {
              "type": "bool",
              "defaultValue": true
            }
          },
          "variables": {
            "secretExists": "[contains(toLower(parameters('existingSecretNames')), format(';{0};', toLower(trim(parameters('secretName')))))]",
            "createMessage": "[if(variables('secretExists'), format('Secret {0} already exists!', parameters('secretName')), format('Added secret {0}!', parameters('secretName')))]"
          },
          "resources": [
            {
              "condition": "[or(not(variables('secretExists')), parameters('forceSecretCreation'))]",
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('secretName'))]",
              "tags": "[parameters('tags')]",
              "properties": {
                "attributes": {
                  "enabled": "[parameters('enabled')]",
                  "exp": "[dateTimeToEpoch(parameters('expirationDate'))]",
                  "nbf": "[dateTimeToEpoch(parameters('enabledDate'))]"
                },
                "contentType": "[parameters('contentType')]",
                "value": "[listAdminKeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('searchServiceResourceGroup')), 'Microsoft.Search/searchServices', parameters('searchServiceName')), '2023-11-01').primaryKey]"
              }
            }
          ],
          "outputs": {
            "message": {
              "type": "string",
              "value": "[if(and(variables('secretExists'), parameters('forceSecretCreation')), format('Secret {0} already exists but was recreated!', parameters('secretName')), variables('createMessage'))]"
            },
            "secretCreated": {
              "type": "bool",
              "value": "[not(variables('secretExists'))]"
            },
            "secretUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('secretName')), '2023-07-01').secretUri]"
            },
            "secretName": {
              "type": "string",
              "value": "[parameters('secretName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('keyvault{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('keyVault-Secret-List-Names{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('search{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('cosmos{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "accountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.cosmosName.value]"
          },
          "existingAccountName": {
            "value": "[parameters('existing_Cosmos_Name')]"
          },
          "existingCosmosResourceGroupName": {
            "value": "[parameters('existing_Cosmos_ResourceGroupName')]"
          },
          "databaseName": {
            "value": "[variables('uiDatabaseName')]"
          },
          "containerArray": {
            "value": "[variables('cosmosContainerArray')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "privateEndpointSubnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('vnet{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.subnetAppSeResourceID.value]"
          },
          "privateEndpointName": {
            "value": "[format('pe-{0}', reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.cosmosName.value)]"
          },
          "managedIdentityPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('app-identity{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.managedIdentityPrincipalId.value]"
          },
          "userPrincipalId": {
            "value": "[parameters('principalId')]"
          },
          "publicNetworkAccess": "[if(parameters('publicAccessEnabled'), createObject('value', 'enabled'), createObject('value', 'disabled'))]",
          "myIpAddress": {
            "value": "[parameters('myIpAddress')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "12698681736181423066"
            }
          },
          "parameters": {
            "accountName": {
              "type": "string",
              "defaultValue": "[format('sql-{0}', uniqueString(resourceGroup().id))]",
              "metadata": {
                "description": "Cosmos DB account name"
              }
            },
            "existingAccountName": {
              "type": "string",
              "defaultValue": ""
            },
            "existingCosmosResourceGroupName": {
              "type": "string",
              "defaultValue": "[resourceGroup().name]"
            },
            "databaseName": {
              "type": "string",
              "metadata": {
                "description": "The name for the SQL database"
              }
            },
            "containerArray": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "The collection of containers to create"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the Cosmos DB account."
              }
            },
            "myIpAddress": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Provide the IP address to allow access to the Azure Container Registry"
              }
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": ""
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "privateEndpointName": {
              "type": "string",
              "defaultValue": ""
            },
            "managedIdentityPrincipalId": {
              "type": "string",
              "defaultValue": ""
            },
            "userPrincipalId": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "variables": {
            "$fxv#0": {
              "source": {
                "url": "https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles"
              },
              "cosmos": {
                "dataContributorRoleId": "00000000-0000-0000-0000-000000000002"
              },
              "storage": {
                "blobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
                "blobDataOwnerRoleId": "b7e6dc6d-f1e8-4753-8033-0f276bb0955b",
                "storageAccountContributorRoleId": "17d1049b-9a84-46fb-8f53-869881c3d3ab",
                "queueDataContributorRoleId": "974c5e8b-45b9-4653-ba55-5f855dd0fb88",
                "tableContributorRoleId": "0a9a7e1f-b9d0-4cc4-a60d-0319b160aaa3",
                "storageQueueDataMessageSender": "c6a89b2d-59bc-44d0-9896-0f6e12d7b80a"
              },
              "search": {
                "indexDataContributorRoleId": "8ebe5a00-799e-43f5-93ac-243d3dce84a7",
                "indexDataReaderRoleId": "1407120a-92aa-4202-b7e9-c0e197c71c8f",
                "serviceContributorRoleId": "7ca78c08-252a-4471-8644-bb5ff32d4ba0"
              },
              "openai": {
                "cognitiveServicesOpenAIContributorRoleId": "a001fd3d-188f-4b5d-821b-7da978bf7442",
                "cognitiveServicesOpenAIUserRoleId": "5e0bd9bd-7b93-4f28-af87-19fc36ad61bd",
                "cognitiveServicesUserRoleId": "a97b65f3-24c7-4388-baec-2e87135dc908",
                "cognitiveServicesContributorRoleId": "25fbc0a9-bd7c-42a3-aa1a-3b75d497ee68"
              },
              "ml": {
                "dataScientistRole": "f6c7c914-8db3-469d-8ca1-694a8f32e121"
              },
              "containerregistry": {
                "acrPullRoleId": "7f951dda-4ed3-4680-a7ca-43fe172d538d"
              },
              "keyvault": {
                "secretsUserRoleId": "4633458b-17de-408a-b874-0445c86b69e6",
                "secretsOfficerRoleId": "b86a8fe4-44ce-4948-aee5-eccb2c155cd7"
              }
            },
            "connectionStringSecretName": "azure-cosmos-connection-string",
            "useExistingAccount": "[not(empty(parameters('existingAccountName')))]",
            "roleDefinitions": "[variables('$fxv#0')]"
          },
          "resources": [
            {
              "condition": "[not(variables('useExistingAccount'))]",
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2024-08-15",
              "name": "[toLower(parameters('accountName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "GlobalDocumentDB",
              "properties": {
                "enableAutomaticFailover": false,
                "enableMultipleWriteLocations": false,
                "isVirtualNetworkFilterEnabled": false,
                "virtualNetworkRules": [],
                "disableKeyBasedMetadataWriteAccess": false,
                "disableLocalAuth": false,
                "enableFreeTier": false,
                "enableAnalyticalStorage": false,
                "createMode": "Default",
                "databaseAccountOfferType": "Standard",
                "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                "networkAclBypass": "AzureServices",
                "consistencyPolicy": {
                  "defaultConsistencyLevel": "Session",
                  "maxIntervalInSeconds": 5,
                  "maxStalenessPrefix": 100
                },
                "locations": [
                  {
                    "locationName": "[parameters('location')]",
                    "failoverPriority": 0,
                    "isZoneRedundant": false
                  }
                ],
                "cors": [],
                "capabilities": [
                  {
                    "name": "EnableServerless"
                  }
                ],
                "ipRules": "[if(empty(parameters('myIpAddress')), createArray(), createArray(createObject('ipAddressOrRange', parameters('myIpAddress'))))]"
              }
            },
            {
              "condition": "[not(variables('useExistingAccount'))]",
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
              "apiVersion": "2024-08-15",
              "name": "[format('{0}/{1}', toLower(parameters('accountName')), parameters('databaseName'))]",
              "tags": "[parameters('tags')]",
              "properties": {
                "resource": {
                  "id": "[parameters('databaseName')]"
                },
                "options": {}
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('accountName')))]"
              ]
            },
            {
              "copy": {
                "name": "chatContainer",
                "count": "[length(parameters('containerArray'))]"
              },
              "condition": "[not(variables('useExistingAccount'))]",
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2024-08-15",
              "name": "[format('{0}/{1}/{2}', toLower(parameters('accountName')), parameters('databaseName'), parameters('containerArray')[copyIndex()].Name)]",
              "tags": "[parameters('tags')]",
              "properties": {
                "resource": {
                  "id": "[parameters('containerArray')[copyIndex()].name]",
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "automatic": true,
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ],
                    "excludedPaths": [
                      {
                        "path": "/\"_etag\"/?"
                      }
                    ]
                  },
                  "partitionKey": {
                    "paths": [
                      "[parameters('containerArray')[copyIndex()].partitionKey]"
                    ],
                    "kind": "Hash"
                  },
                  "conflictResolutionPolicy": {
                    "mode": "LastWriterWins",
                    "conflictResolutionPath": "/_ts"
                  }
                },
                "options": {}
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', toLower(parameters('accountName')), parameters('databaseName'))]"
              ]
            },
            {
              "condition": "[not(variables('useExistingAccount'))]",
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
              "apiVersion": "2024-08-15",
              "name": "[format('{0}/{1}', toLower(parameters('accountName')), guid(resourceGroup().id, parameters('managedIdentityPrincipalId'), variables('roleDefinitions').cosmos.dataContributorRoleId, resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('accountName')))))]",
              "properties": {
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "roleDefinitionId": "[format('{0}/providers/Microsoft.DocumentDB/databaseAccounts/{1}/sqlRoleDefinitions/{2}', resourceGroup().id, parameters('databaseName'), variables('roleDefinitions').cosmos.dataContributorRoleId)]",
                "scope": "[resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('accountName')))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('accountName')))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', toLower(parameters('accountName')), parameters('databaseName'))]"
              ]
            },
            {
              "condition": "[and(not(variables('useExistingAccount')), not(equals(parameters('userPrincipalId'), '')))]",
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
              "apiVersion": "2024-08-15",
              "name": "[format('{0}/{1}', toLower(parameters('accountName')), guid(resourceGroup().id, parameters('userPrincipalId'), variables('roleDefinitions').cosmos.dataContributorRoleId, resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('accountName')))))]",
              "properties": {
                "principalId": "[parameters('userPrincipalId')]",
                "roleDefinitionId": "[format('{0}/providers/Microsoft.DocumentDB/databaseAccounts/{1}/sqlRoleDefinitions/{2}', resourceGroup().id, parameters('databaseName'), variables('roleDefinitions').cosmos.dataContributorRoleId)]",
                "scope": "[resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('accountName')))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('accountName')))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', toLower(parameters('accountName')), parameters('databaseName'))]"
              ]
            },
            {
              "condition": "[and(not(variables('useExistingAccount')), not(empty(parameters('privateEndpointSubnetId'))))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-private-endpoint', parameters('accountName'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "privateEndpointName": {
                    "value": "[parameters('privateEndpointName')]"
                  },
                  "groupIds": {
                    "value": [
                      "Sql"
                    ]
                  },
                  "targetResourceId": {
                    "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('accountName')))]"
                  },
                  "subnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "6191151302122753297"
                    }
                  },
                  "parameters": {
                    "privateEndpointName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the private endpoint to create"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "The region where the private endpoint will be created"
                      }
                    },
                    "subnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "The ID of the subnet where the private endpoint will be created"
                      }
                    },
                    "targetResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The ID of the resource to which the private endpoint will be connected"
                      }
                    },
                    "groupIds": {
                      "type": "array",
                      "metadata": {
                        "description": "An array of group IDs of the service type that they private endpoint will be connect to"
                      }
                    },
                    "dnsZoneId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "The resource ID of the private DNS zone for this resource"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "The tags to associate with the private endpoint"
                      }
                    }
                  },
                  "variables": {
                    "nicName": "[format('{0}-nic', parameters('privateEndpointName'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('privateEndpointName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "customNetworkInterfaceName": "[variables('nicName')]",
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[parameters('privateEndpointName')]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('targetResourceId')]",
                              "groupIds": "[parameters('groupIds')]"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "condition": "[not(equals(parameters('dnsZoneId'), ''))]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2023-06-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointName'), format('{0}-dns-group', parameters('privateEndpointName')))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "default",
                            "properties": {
                              "privateDnsZoneId": "[parameters('dnsZoneId')]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateEndpointId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                    },
                    "privateEndpointName": {
                      "type": "string",
                      "value": "[parameters('privateEndpointName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('accountName')))]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[if(variables('useExistingAccount'), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingCosmosResourceGroupName')), 'Microsoft.DocumentDB/databaseAccounts', parameters('existingAccountName')), resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('accountName'))))]"
            },
            "name": {
              "type": "string",
              "value": "[if(variables('useExistingAccount'), parameters('existingAccountName'), toLower(parameters('accountName')))]"
            },
            "resourceGroupName": {
              "type": "string",
              "value": "[if(variables('useExistingAccount'), parameters('existingCosmosResourceGroupName'), resourceGroup().name)]"
            },
            "endpoint": {
              "type": "string",
              "value": "[if(variables('useExistingAccount'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingCosmosResourceGroupName')), 'Microsoft.DocumentDB/databaseAccounts', parameters('existingAccountName')), '2024-08-15').documentEndpoint, reference(resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('accountName'))), '2024-08-15').documentEndpoint)]"
            },
            "keyVaultSecretName": {
              "type": "string",
              "value": "[variables('connectionStringSecretName')]"
            },
            "privateEndpointName": {
              "type": "string",
              "value": "[parameters('privateEndpointName')]"
            },
            "databaseName": {
              "type": "string",
              "value": "[parameters('databaseName')]"
            },
            "connectionStringSecretName": {
              "type": "string",
              "value": "[variables('connectionStringSecretName')]"
            },
            "containerNames": {
              "type": "array",
              "copy": {
                "count": "[length(parameters('containerArray'))]",
                "input": {
                  "name": "[parameters('containerArray')[copyIndex()]]"
                }
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('app-identity{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('vnet{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('search{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "name": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.searchServiceName.value]"
          },
          "existingSearchServiceName": {
            "value": "[parameters('existing_SearchService_Name')]"
          },
          "existingSearchServiceResourceGroupName": {
            "value": "[parameters('existing_SearchService_ResourceGroupName')]"
          },
          "publicNetworkAccess": "[if(parameters('publicAccessEnabled'), createObject('value', 'enabled'), createObject('value', 'disabled'))]",
          "myIpAddress": {
            "value": "[parameters('myIpAddress')]"
          },
          "privateEndpointSubnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('vnet{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.subnetAppSeResourceID.value]"
          },
          "privateEndpointName": {
            "value": "[format('pe-{0}', reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.searchServiceName.value)]"
          },
          "managedIdentityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('app-identity{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.managedIdentityId.value]"
          },
          "sku": {
            "value": {
              "name": "basic"
            }
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "5126111516943164437"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "defaultValue": ""
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "existingSearchServiceName": {
              "type": "string",
              "defaultValue": ""
            },
            "existingSearchServiceResourceGroupName": {
              "type": "string",
              "defaultValue": "[resourceGroup().name]"
            },
            "sku": {
              "type": "object",
              "defaultValue": {
                "name": "standard"
              }
            },
            "myIpAddress": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Ip Address to allow access to the Azure Search Service"
              }
            },
            "partitionCount": {
              "type": "int",
              "defaultValue": 1
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": "disabled",
              "allowedValues": [
                "enabled",
                "disabled"
              ]
            },
            "replicaCount": {
              "type": "int",
              "defaultValue": 1
            },
            "semanticSearch": {
              "type": "string",
              "defaultValue": "standard",
              "allowedValues": [
                "disabled",
                "free",
                "standard"
              ],
              "metadata": {
                "description": "Optional. Sets options that control the availability of semantic search. This configuration is only possible for certain search SKUs in certain locations. Free Sku = disabled"
              }
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "privateEndpointName": {
              "type": "string",
              "defaultValue": ""
            },
            "managedIdentityId": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "variables": {
            "useExistingSearchService": "[not(empty(parameters('existingSearchServiceName')))]",
            "resourceGroupName": "[resourceGroup().name]",
            "searchKeySecretName": "search-key"
          },
          "resources": [
            {
              "condition": "[not(variables('useExistingSearchService'))]",
              "type": "Microsoft.Search/searchServices",
              "apiVersion": "2024-06-01-preview",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "networkRuleSet": "[if(equals(parameters('publicNetworkAccess'), 'enabled'), createObject(), createObject('bypass', 'AzurePortal', 'ipRules', if(empty(parameters('myIpAddress')), createArray(), createArray(createObject('value', parameters('myIpAddress'))))))]",
                "partitionCount": "[parameters('partitionCount')]",
                "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                "replicaCount": "[parameters('replicaCount')]",
                "semanticSearch": "[parameters('semanticSearch')]",
                "authOptions": {
                  "aadOrApiKey": {
                    "aadAuthFailureMode": "http401WithBearerChallenge"
                  }
                }
              },
              "sku": "[parameters('sku')]"
            },
            {
              "condition": "[and(not(variables('useExistingSearchService')), not(empty(parameters('privateEndpointSubnetId'))))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-private-endpoint', parameters('name'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "privateEndpointName": {
                    "value": "[parameters('privateEndpointName')]"
                  },
                  "groupIds": {
                    "value": [
                      "searchService"
                    ]
                  },
                  "targetResourceId": {
                    "value": "[resourceId('Microsoft.Search/searchServices', parameters('name'))]"
                  },
                  "subnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "6191151302122753297"
                    }
                  },
                  "parameters": {
                    "privateEndpointName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the private endpoint to create"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "The region where the private endpoint will be created"
                      }
                    },
                    "subnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "The ID of the subnet where the private endpoint will be created"
                      }
                    },
                    "targetResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The ID of the resource to which the private endpoint will be connected"
                      }
                    },
                    "groupIds": {
                      "type": "array",
                      "metadata": {
                        "description": "An array of group IDs of the service type that they private endpoint will be connect to"
                      }
                    },
                    "dnsZoneId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "The resource ID of the private DNS zone for this resource"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "The tags to associate with the private endpoint"
                      }
                    }
                  },
                  "variables": {
                    "nicName": "[format('{0}-nic', parameters('privateEndpointName'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('privateEndpointName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "customNetworkInterfaceName": "[variables('nicName')]",
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[parameters('privateEndpointName')]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('targetResourceId')]",
                              "groupIds": "[parameters('groupIds')]"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "condition": "[not(equals(parameters('dnsZoneId'), ''))]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2023-06-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointName'), format('{0}-dns-group', parameters('privateEndpointName')))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "default",
                            "properties": {
                              "privateDnsZoneId": "[parameters('dnsZoneId')]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateEndpointId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                    },
                    "privateEndpointName": {
                      "type": "string",
                      "value": "[parameters('privateEndpointName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Search/searchServices', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[if(variables('useExistingSearchService'), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingSearchServiceResourceGroupName')), 'Microsoft.Search/searchServices', parameters('existingSearchServiceName')), resourceId('Microsoft.Search/searchServices', parameters('name')))]"
            },
            "resourceGroupName": {
              "type": "string",
              "value": "[if(variables('useExistingSearchService'), parameters('existingSearchServiceResourceGroupName'), variables('resourceGroupName'))]"
            },
            "name": {
              "type": "string",
              "value": "[if(variables('useExistingSearchService'), parameters('existingSearchServiceName'), parameters('name'))]"
            },
            "endpoint": {
              "type": "string",
              "value": "[if(variables('useExistingSearchService'), format('https://{0}.search.windows.net/', parameters('existingSearchServiceName')), format('https://{0}.search.windows.net/', parameters('name')))]"
            },
            "searchKeySecretName": {
              "type": "string",
              "value": "[variables('searchKeySecretName')]"
            },
            "keyVaultSecretName": {
              "type": "string",
              "value": "[variables('searchKeySecretName')]"
            },
            "privateEndpointId": {
              "type": "string",
              "value": "[if(empty(parameters('privateEndpointSubnetId')), '', if(variables('useExistingSearchService'), resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName')), reference(resourceId('Microsoft.Resources/deployments', format('{0}-private-endpoint', parameters('name'))), '2022-09-01').outputs.privateEndpointId.value))]"
            },
            "privateEndpointName": {
              "type": "string",
              "value": "[parameters('privateEndpointName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('app-identity{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('vnet{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('openai{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "managedIdentityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('app-identity{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.managedIdentityId.value]"
          },
          "existing_CogServices_Name": {
            "value": "[parameters('existing_CogServices_Name')]"
          },
          "name": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.cogServiceName.value]"
          },
          "location": {
            "value": "[parameters('openAI_deploy_location')]"
          },
          "pe_location": {
            "value": "[parameters('location')]"
          },
          "appInsightsName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('law{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.applicationInsightsName.value]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "textEmbeddings": {
            "value": [
              {
                "name": "text-embedding",
                "model": {
                  "format": "OpenAI",
                  "name": "text-embedding-ada-002",
                  "version": "2"
                }
              }
            ]
          },
          "chatGpt_Standard": {
            "value": {
              "DeploymentName": "gpt-35-turbo",
              "ModelName": "gpt-35-turbo",
              "ModelVersion": "0125",
              "DeploymentCapacity": 10
            }
          },
          "chatGpt_Premium": {
            "value": {
              "DeploymentName": "gpt-4o",
              "ModelName": "gpt-4o",
              "ModelVersion": "2024-08-06",
              "DeploymentCapacity": 10
            }
          },
          "publicNetworkAccess": "[if(parameters('publicAccessEnabled'), createObject('value', 'enabled'), createObject('value', 'disabled'))]",
          "privateEndpointSubnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('vnet{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.subnetAppSeResourceID.value]"
          },
          "privateEndpointName": {
            "value": "[format('pe-{0}', reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.cogServiceName.value)]"
          },
          "myIpAddress": {
            "value": "[parameters('myIpAddress')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "6397190155542535101"
            }
          },
          "parameters": {
            "existing_CogServices_Name": {
              "type": "string",
              "defaultValue": ""
            },
            "existing_CogServices_RG_Name": {
              "type": "string",
              "defaultValue": ""
            },
            "name": {
              "type": "string",
              "defaultValue": ""
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "pe_location": {
              "type": "string",
              "defaultValue": "[parameters('location')]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "appInsightsName": {
              "type": "string"
            },
            "kind": {
              "type": "string",
              "defaultValue": "AIServices",
              "allowedValues": [
                "OpenAI",
                "AIServices"
              ],
              "metadata": {
                "description": "The Kind of AI Service, can be \"OpenAI\" or \"AIServices\""
              }
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": ""
            },
            "sku": {
              "type": "object",
              "defaultValue": {
                "name": "S0"
              }
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "privateEndpointName": {
              "type": "string",
              "defaultValue": ""
            },
            "myIpAddress": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Provide the IP address to allow access to the Azure Container Registry"
              }
            },
            "managedIdentityId": {
              "type": "string"
            },
            "textEmbeddings": {
              "type": "array",
              "defaultValue": []
            },
            "chatGpt_Standard": {
              "type": "object",
              "defaultValue": {}
            },
            "chatGpt_Premium": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "variables": {
            "resourceGroupName": "[resourceGroup().name]",
            "useExistingService": "[not(empty(parameters('existing_CogServices_Name')))]",
            "cognitiveServicesKeySecretName": "cognitive-services-key",
            "deployments": "[union(parameters('textEmbeddings'), createArray(createObject('name', parameters('chatGpt_Standard').DeploymentName, 'model', createObject('format', 'OpenAI', 'name', parameters('chatGpt_Standard').ModelName, 'version', parameters('chatGpt_Standard').ModelVersion), 'sku', coalesce(tryGet(parameters('chatGpt_Standard'), 'sku'), createObject('name', 'Standard', 'capacity', parameters('chatGpt_Standard').DeploymentCapacity))), createObject('name', parameters('chatGpt_Premium').DeploymentName, 'model', createObject('format', 'OpenAI', 'name', parameters('chatGpt_Premium').ModelName, 'version', parameters('chatGpt_Premium').ModelVersion), 'sku', coalesce(tryGet(parameters('chatGpt_Premium'), 'sku'), createObject('name', 'Standard', 'capacity', parameters('chatGpt_Premium').DeploymentCapacity)))))]"
          },
          "resources": [
            {
              "condition": "[not(variables('useExistingService'))]",
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2025-04-01-preview",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "[parameters('kind')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "allowProjectManagement": true,
                "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                "networkAcls": {
                  "bypass": "AzureServices",
                  "defaultAction": "[if(empty(parameters('myIpAddress')), 'Allow', 'Deny')]",
                  "ipRules": "[if(empty(parameters('myIpAddress')), createArray(), createArray(createObject('value', parameters('myIpAddress'))))]"
                },
                "customSubDomainName": "[toLower(format('{0}', parameters('name')))]"
              },
              "sku": "[parameters('sku')]"
            },
            {
              "copy": {
                "name": "deployment",
                "count": "[length(variables('deployments'))]",
                "mode": "serial",
                "batchSize": 1
              },
              "condition": "[not(variables('useExistingService'))]",
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('name'), variables('deployments')[copyIndex()].name)]",
              "properties": {
                "model": "[variables('deployments')[copyIndex()].model]"
              },
              "sku": "[coalesce(tryGet(variables('deployments')[copyIndex()], 'sku'), createObject('name', 'Standard', 'capacity', 20))]",
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/connections",
              "apiVersion": "2025-04-01-preview",
              "name": "[format('{0}/{1}', parameters('name'), 'applicationInsights')]",
              "properties": {
                "category": "AppInsights",
                "target": "[resourceId('Microsoft.Insights/components', parameters('appInsightsName'))]",
                "authType": "ApiKey",
                "isSharedToAll": true,
                "credentials": {
                  "key": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').InstrumentationKey]"
                },
                "metadata": {
                  "ApiType": "Azure",
                  "ResourceId": "[resourceId('Microsoft.Insights/components', parameters('appInsightsName'))]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            },
            {
              "condition": "[and(empty(parameters('existing_CogServices_Name')), not(empty(parameters('privateEndpointSubnetId'))))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-private-endpoint', parameters('name'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "location": {
                    "value": "[parameters('pe_location')]"
                  },
                  "privateEndpointName": {
                    "value": "[parameters('privateEndpointName')]"
                  },
                  "groupIds": {
                    "value": [
                      "account"
                    ]
                  },
                  "targetResourceId": {
                    "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
                  },
                  "subnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "6191151302122753297"
                    }
                  },
                  "parameters": {
                    "privateEndpointName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the private endpoint to create"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "The region where the private endpoint will be created"
                      }
                    },
                    "subnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "The ID of the subnet where the private endpoint will be created"
                      }
                    },
                    "targetResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The ID of the resource to which the private endpoint will be connected"
                      }
                    },
                    "groupIds": {
                      "type": "array",
                      "metadata": {
                        "description": "An array of group IDs of the service type that they private endpoint will be connect to"
                      }
                    },
                    "dnsZoneId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "The resource ID of the private DNS zone for this resource"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "The tags to associate with the private endpoint"
                      }
                    }
                  },
                  "variables": {
                    "nicName": "[format('{0}-nic', parameters('privateEndpointName'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('privateEndpointName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "customNetworkInterfaceName": "[variables('nicName')]",
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[parameters('privateEndpointName')]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('targetResourceId')]",
                              "groupIds": "[parameters('groupIds')]"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "condition": "[not(equals(parameters('dnsZoneId'), ''))]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2023-06-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointName'), format('{0}-dns-group', parameters('privateEndpointName')))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "default",
                            "properties": {
                              "privateDnsZoneId": "[parameters('dnsZoneId')]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateEndpointId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                    },
                    "privateEndpointName": {
                      "type": "string",
                      "value": "[parameters('privateEndpointName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            },
            {
              "condition": "[and(empty(parameters('existing_CogServices_Name')), not(empty(parameters('privateEndpointSubnetId'))))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-openai-private-endpoint', parameters('name'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "location": {
                    "value": "[parameters('pe_location')]"
                  },
                  "privateEndpointName": {
                    "value": "[format('{0}-openAi-private-link-service-connection', parameters('name'))]"
                  },
                  "groupIds": {
                    "value": [
                      "account"
                    ]
                  },
                  "targetResourceId": {
                    "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
                  },
                  "subnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "6191151302122753297"
                    }
                  },
                  "parameters": {
                    "privateEndpointName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the private endpoint to create"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "The region where the private endpoint will be created"
                      }
                    },
                    "subnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "The ID of the subnet where the private endpoint will be created"
                      }
                    },
                    "targetResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The ID of the resource to which the private endpoint will be connected"
                      }
                    },
                    "groupIds": {
                      "type": "array",
                      "metadata": {
                        "description": "An array of group IDs of the service type that they private endpoint will be connect to"
                      }
                    },
                    "dnsZoneId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "The resource ID of the private DNS zone for this resource"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "The tags to associate with the private endpoint"
                      }
                    }
                  },
                  "variables": {
                    "nicName": "[format('{0}-nic', parameters('privateEndpointName'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('privateEndpointName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "customNetworkInterfaceName": "[variables('nicName')]",
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[parameters('privateEndpointName')]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('targetResourceId')]",
                              "groupIds": "[parameters('groupIds')]"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "condition": "[not(equals(parameters('dnsZoneId'), ''))]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2023-06-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointName'), format('{0}-dns-group', parameters('privateEndpointName')))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "default",
                            "properties": {
                              "privateDnsZoneId": "[parameters('dnsZoneId')]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateEndpointId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                    },
                    "privateEndpointName": {
                      "type": "string",
                      "value": "[parameters('privateEndpointName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[if(not(empty(parameters('existing_CogServices_Name'))), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existing_CogServices_RG_Name')), 'Microsoft.CognitiveServices/accounts', parameters('existing_CogServices_Name')), resourceId('Microsoft.CognitiveServices/accounts', parameters('name')))]"
            },
            "name": {
              "type": "string",
              "value": "[if(not(empty(parameters('existing_CogServices_Name'))), parameters('existing_CogServices_Name'), parameters('name'))]"
            },
            "endpoint": {
              "type": "string",
              "value": "[if(not(empty(parameters('existing_CogServices_Name'))), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existing_CogServices_RG_Name')), 'Microsoft.CognitiveServices/accounts', parameters('existing_CogServices_Name')), '2025-04-01-preview').endpoint, reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('name')), '2025-04-01-preview').endpoint)]"
            },
            "resourceGroupName": {
              "type": "string",
              "value": "[if(not(empty(parameters('existing_CogServices_Name'))), parameters('existing_CogServices_RG_Name'), variables('resourceGroupName'))]"
            },
            "cognitiveServicesKeySecretName": {
              "type": "string",
              "value": "[variables('cognitiveServicesKeySecretName')]"
            },
            "textEmbeddings": {
              "type": "array",
              "value": "[parameters('textEmbeddings')]"
            },
            "chatGpt_Standard": {
              "type": "object",
              "value": "[parameters('chatGpt_Standard')]"
            },
            "kind": {
              "type": "string",
              "value": "[parameters('kind')]"
            },
            "privateEndpointName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-private-endpoint', parameters('name'))), '2022-09-01').outputs.privateEndpointName.value]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('app-identity{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('law{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('search{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('vnet{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('doc-intelligence{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "existing_CogServices_Name": {
            "value": ""
          },
          "name": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.documentIntelligenceName.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "publicNetworkAccess": "[if(parameters('publicAccessEnabled'), createObject('value', 'enabled'), createObject('value', 'disabled'))]",
          "privateEndpointSubnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('vnet{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.subnetAppSeResourceID.value]"
          },
          "privateEndpointName": {
            "value": "[format('pe-{0}', reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.documentIntelligenceName.value)]"
          },
          "myIpAddress": {
            "value": "[parameters('myIpAddress')]"
          },
          "managedIdentityId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('app-identity{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.managedIdentityId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "15333664082905152669"
            }
          },
          "parameters": {
            "existing_CogServices_Name": {
              "type": "string",
              "defaultValue": ""
            },
            "existing_CogServices_RG_Name": {
              "type": "string",
              "defaultValue": ""
            },
            "name": {
              "type": "string",
              "defaultValue": ""
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "pe_location": {
              "type": "string",
              "defaultValue": "[parameters('location')]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "kind": {
              "type": "string",
              "defaultValue": "FormRecognizer"
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": "Disabled"
            },
            "sku": {
              "type": "object",
              "defaultValue": {
                "name": "S0"
              }
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "privateEndpointName": {
              "type": "string",
              "defaultValue": ""
            },
            "myIpAddress": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Provide the IP address to allow access to the Azure Container Registry"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "variables": {
            "useExistingService": "[not(empty(parameters('existing_CogServices_Name')))]",
            "resourceGroupName": "[resourceGroup().name]",
            "cognitiveServicesKeySecretName": "form-recognizer-services-key"
          },
          "resources": [
            {
              "condition": "[not(variables('useExistingService'))]",
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2023-05-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "[parameters('kind')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                "networkAcls": {
                  "defaultAction": "[if(equals(parameters('publicNetworkAccess'), 'Enabled'), 'Allow', 'Deny')]",
                  "ipRules": "[if(empty(parameters('myIpAddress')), createArray(), createArray(createObject('value', parameters('myIpAddress'))))]"
                },
                "customSubDomainName": "[parameters('name')]"
              },
              "sku": "[parameters('sku')]"
            },
            {
              "condition": "[and(not(variables('useExistingService')), not(empty(parameters('privateEndpointSubnetId'))))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-private-endpoint', parameters('name'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('pe_location')]"
                  },
                  "privateEndpointName": {
                    "value": "[parameters('privateEndpointName')]"
                  },
                  "groupIds": {
                    "value": [
                      "account"
                    ]
                  },
                  "targetResourceId": {
                    "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
                  },
                  "subnetId": {
                    "value": "[parameters('privateEndpointSubnetId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "6191151302122753297"
                    }
                  },
                  "parameters": {
                    "privateEndpointName": {
                      "type": "string",
                      "metadata": {
                        "description": "The name of the private endpoint to create"
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "The region where the private endpoint will be created"
                      }
                    },
                    "subnetId": {
                      "type": "string",
                      "metadata": {
                        "description": "The ID of the subnet where the private endpoint will be created"
                      }
                    },
                    "targetResourceId": {
                      "type": "string",
                      "metadata": {
                        "description": "The ID of the resource to which the private endpoint will be connected"
                      }
                    },
                    "groupIds": {
                      "type": "array",
                      "metadata": {
                        "description": "An array of group IDs of the service type that they private endpoint will be connect to"
                      }
                    },
                    "dnsZoneId": {
                      "type": "string",
                      "defaultValue": "",
                      "metadata": {
                        "description": "The resource ID of the private DNS zone for this resource"
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "The tags to associate with the private endpoint"
                      }
                    }
                  },
                  "variables": {
                    "nicName": "[format('{0}-nic', parameters('privateEndpointName'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('privateEndpointName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "customNetworkInterfaceName": "[variables('nicName')]",
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[parameters('privateEndpointName')]",
                            "properties": {
                              "privateLinkServiceId": "[parameters('targetResourceId')]",
                              "groupIds": "[parameters('groupIds')]"
                            }
                          }
                        ]
                      }
                    },
                    {
                      "condition": "[not(equals(parameters('dnsZoneId'), ''))]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2023-06-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointName'), format('{0}-dns-group', parameters('privateEndpointName')))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "default",
                            "properties": {
                              "privateDnsZoneId": "[parameters('dnsZoneId')]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "privateEndpointId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
                    },
                    "privateEndpointName": {
                      "type": "string",
                      "value": "[parameters('privateEndpointName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[if(variables('useExistingService'), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existing_CogServices_RG_Name')), 'Microsoft.CognitiveServices/accounts', parameters('existing_CogServices_Name')), resourceId('Microsoft.CognitiveServices/accounts', parameters('name')))]"
            },
            "name": {
              "type": "string",
              "value": "[if(variables('useExistingService'), parameters('existing_CogServices_Name'), parameters('name'))]"
            },
            "endpoint": {
              "type": "string",
              "value": "[if(variables('useExistingService'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existing_CogServices_RG_Name')), 'Microsoft.CognitiveServices/accounts', parameters('existing_CogServices_Name')), '2023-05-01').endpoint, reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('name')), '2023-05-01').endpoint)]"
            },
            "resourceGroupName": {
              "type": "string",
              "value": "[if(variables('useExistingService'), parameters('existing_CogServices_RG_Name'), variables('resourceGroupName'))]"
            },
            "keyVaultSecretName": {
              "type": "string",
              "value": "[variables('cognitiveServicesKeySecretName')]"
            },
            "privateEndpointName": {
              "type": "string",
              "value": "[parameters('privateEndpointName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('app-identity{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('search{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('vnet{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deployAIHub')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('aiHub{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aiHubName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.aiHubName.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "aiServicesId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('openai{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.id.value]"
          },
          "aiServicesTarget": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('openai{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.endpoint.value]"
          },
          "aiSearchName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('search{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "applicationInsightsId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('law{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.applicationInsightsId.value]"
          },
          "containerRegistryId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('containerregistry{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.id.value]"
          },
          "keyVaultId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('keyvault{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.id.value]"
          },
          "storageAccountId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.id.value]"
          },
          "addRoleAssignments": {
            "value": "[parameters('addRoleAssignments')]"
          },
          "userObjectId": {
            "value": "[parameters('principalId')]"
          },
          "userObjectType": {
            "value": "User"
          },
          "managedIdentityPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('app-identity{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.managedIdentityPrincipalId.value]"
          },
          "managedIdentityType": {
            "value": "ServicePrincipal"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "1219112543837723635"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region used for the deployment of the Azure AI Hub."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Set of tags to apply to the Azure AI Hub."
              }
            },
            "aiHubName": {
              "type": "string",
              "metadata": {
                "description": "Name for the Azure AI Hub resource."
              }
            },
            "aiHubFriendlyName": {
              "type": "string",
              "defaultValue": "[parameters('aiHubName')]",
              "metadata": {
                "description": "Friendly name for your Azure AI Hub resource, displayed in the Studio UI."
              }
            },
            "aiHubDescription": {
              "type": "string",
              "defaultValue": "This is an AI Foundry for use with the Smart-Flow application.",
              "metadata": {
                "description": "Description of your Azure AI Hub resource, displayed in the Studio UI."
              }
            },
            "applicationInsightsId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Azure Application Insights resource for storing diagnostics logs."
              }
            },
            "containerRegistryId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Azure Container Registry resource for storing Docker images for models."
              }
            },
            "keyVaultId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Azure Key Vault resource for storing connection strings."
              }
            },
            "storageAccountId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Azure Storage Account resource for storing workspace data."
              }
            },
            "aiServicesId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Azure AI Services resource for connecting AI capabilities."
              }
            },
            "aiServicesTarget": {
              "type": "string",
              "metadata": {
                "description": "Target endpoint for the Azure AI Services resource to link to the Azure AI Hub."
              }
            },
            "addRoleAssignments": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Flag to determine if role assignments should be added to the Azure AI Hub."
              }
            },
            "userObjectId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The object ID of a Microsoft Entra ID users to be granted necessary role assignments to access the Azure AI Hub."
              }
            },
            "userObjectType": {
              "type": "string",
              "defaultValue": "User"
            },
            "managedIdentityPrincipalId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The principal ID of the application identity to be granted necessary role assignments to access the Azure AI Hub."
              }
            },
            "managedIdentityType": {
              "type": "string",
              "defaultValue": "ServicePrincipal"
            },
            "aiSearchName": {
              "type": "string",
              "metadata": {
                "description": "Name AI Search resource"
              }
            },
            "aiSearchResourceGroupName": {
              "type": "string",
              "defaultValue": "[resourceGroup().name]"
            }
          },
          "variables": {
            "$fxv#0": {
              "source": {
                "url": "https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles"
              },
              "cosmos": {
                "dataContributorRoleId": "00000000-0000-0000-0000-000000000002"
              },
              "storage": {
                "blobDataContributorRoleId": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
                "blobDataOwnerRoleId": "b7e6dc6d-f1e8-4753-8033-0f276bb0955b",
                "storageAccountContributorRoleId": "17d1049b-9a84-46fb-8f53-869881c3d3ab",
                "queueDataContributorRoleId": "974c5e8b-45b9-4653-ba55-5f855dd0fb88",
                "tableContributorRoleId": "0a9a7e1f-b9d0-4cc4-a60d-0319b160aaa3",
                "storageQueueDataMessageSender": "c6a89b2d-59bc-44d0-9896-0f6e12d7b80a"
              },
              "search": {
                "indexDataContributorRoleId": "8ebe5a00-799e-43f5-93ac-243d3dce84a7",
                "indexDataReaderRoleId": "1407120a-92aa-4202-b7e9-c0e197c71c8f",
                "serviceContributorRoleId": "7ca78c08-252a-4471-8644-bb5ff32d4ba0"
              },
              "openai": {
                "cognitiveServicesOpenAIContributorRoleId": "a001fd3d-188f-4b5d-821b-7da978bf7442",
                "cognitiveServicesOpenAIUserRoleId": "5e0bd9bd-7b93-4f28-af87-19fc36ad61bd",
                "cognitiveServicesUserRoleId": "a97b65f3-24c7-4388-baec-2e87135dc908",
                "cognitiveServicesContributorRoleId": "25fbc0a9-bd7c-42a3-aa1a-3b75d497ee68"
              },
              "ml": {
                "dataScientistRole": "f6c7c914-8db3-469d-8ca1-694a8f32e121"
              },
              "containerregistry": {
                "acrPullRoleId": "7f951dda-4ed3-4680-a7ca-43fe172d538d"
              },
              "keyvault": {
                "secretsUserRoleId": "4633458b-17de-408a-b874-0445c86b69e6",
                "secretsOfficerRoleId": "b86a8fe4-44ce-4948-aee5-eccb2c155cd7"
              }
            },
            "aiServiceConnectionName": "[format('{0}-connection-AIService', parameters('aiHubName'))]",
            "searchConnectionName": "[format('{0}-connection-AISearch', parameters('aiHubName'))]",
            "roleDefinitions": "[variables('$fxv#0')]"
          },
          "resources": [
            {
              "type": "Microsoft.MachineLearningServices/workspaces/connections",
              "apiVersion": "2024-10-01",
              "name": "[format('{0}/{1}', parameters('aiHubName'), variables('aiServiceConnectionName'))]",
              "properties": {
                "category": "AzureOpenAI",
                "target": "[parameters('aiServicesTarget')]",
                "isSharedToAll": true,
                "authType": "AAD",
                "metadata": {
                  "ApiType": "Azure",
                  "ResourceId": "[parameters('aiServicesId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiHubName'))]"
              ]
            },
            {
              "type": "Microsoft.MachineLearningServices/workspaces/connections",
              "apiVersion": "2024-07-01-preview",
              "name": "[format('{0}/{1}', parameters('aiHubName'), variables('searchConnectionName'))]",
              "properties": {
                "category": "CognitiveSearch",
                "target": "[format('https://{0}.search.windows.net', parameters('aiSearchName'))]",
                "isSharedToAll": true,
                "authType": "AAD",
                "metadata": {
                  "ApiType": "Azure",
                  "ResourceId": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('aiSearchResourceGroupName')), 'Microsoft.Search/searchServices', parameters('aiSearchName'))]",
                  "location": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('aiSearchResourceGroupName')), 'Microsoft.Search/searchServices', parameters('aiSearchName')), '2020-03-13', 'full').location]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiHubName'))]"
              ]
            },
            {
              "type": "Microsoft.MachineLearningServices/workspaces",
              "apiVersion": "2024-10-01",
              "name": "[parameters('aiHubName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "Hub",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "friendlyName": "[parameters('aiHubFriendlyName')]",
                "description": "[parameters('aiHubDescription')]",
                "keyVault": "[parameters('keyVaultId')]",
                "storageAccount": "[parameters('storageAccountId')]",
                "applicationInsights": "[parameters('applicationInsightsId')]",
                "containerRegistry": "[parameters('containerRegistryId')]"
              }
            },
            {
              "condition": "[and(parameters('addRoleAssignments'), not(equals(parameters('userObjectId'), '')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.MachineLearningServices/workspaces/{0}', parameters('aiHubName'))]",
              "name": "[guid(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiHubName')), parameters('userObjectId'), 'dataScientistRole')]",
              "properties": {
                "principalId": "[parameters('userObjectId')]",
                "principalType": "[parameters('userObjectType')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').ml.dataScientistRole)]",
                "description": "[format('Permission for admin {0} to use {1}', parameters('userObjectId'), parameters('aiHubName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiHubName'))]"
              ]
            },
            {
              "condition": "[and(parameters('addRoleAssignments'), not(equals(parameters('managedIdentityPrincipalId'), '')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.MachineLearningServices/workspaces/{0}', parameters('aiHubName'))]",
              "name": "[guid(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiHubName')), parameters('managedIdentityPrincipalId'), 'dataScientistRole')]",
              "properties": {
                "principalId": "[parameters('managedIdentityPrincipalId')]",
                "principalType": "[parameters('managedIdentityType')]",
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roleDefinitions').ml.dataScientistRole)]",
                "description": "[format('Permission for application {0} to use {1}', parameters('managedIdentityPrincipalId'), parameters('aiHubName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiHubName'))]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiHubName'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('aiHubName')]"
            },
            "aiServiceConnectionName": {
              "type": "string",
              "value": "[variables('aiServiceConnectionName')]"
            },
            "searchConnectionName": {
              "type": "string",
              "value": "[variables('searchConnectionName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('containerregistry{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('app-identity{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('keyvault{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('law{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('openai{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('search{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deployAIHub')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('aiProject{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aiProjectName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.aiHubProjectName.value]"
          },
          "aiProjectFriendlyName": {
            "value": "[parameters('aiProjectFriendlyName')]"
          },
          "aiProjectDescription": {
            "value": "[parameters('aiProjectDescription')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "aiHubId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('aiHub{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.id.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "5320699842791612783"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region of the deployment"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags to add to the resources"
              }
            },
            "aiProjectName": {
              "type": "string",
              "metadata": {
                "description": "AI Project name"
              }
            },
            "aiProjectFriendlyName": {
              "type": "string",
              "defaultValue": "[parameters('aiProjectName')]",
              "metadata": {
                "description": "AI Project display name"
              }
            },
            "aiProjectDescription": {
              "type": "string",
              "metadata": {
                "description": "AI Project description"
              }
            },
            "aiHubId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the AI Hub resource"
              }
            }
          },
          "variables": {
            "subscriptionId": "[subscription().subscriptionId]",
            "resourceGroupName": "[resourceGroup().name]",
            "projectConnectionString": "[format('{0}.api.azureml.ms;{1};{2};{3}', parameters('location'), variables('subscriptionId'), variables('resourceGroupName'), parameters('aiProjectName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.MachineLearningServices/workspaces",
              "apiVersion": "2023-08-01-preview",
              "name": "[parameters('aiProjectName')]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject('ProjectConnectionString', variables('projectConnectionString')))]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "friendlyName": "[parameters('aiProjectFriendlyName')]",
                "description": "[parameters('aiProjectDescription')]",
                "hubResourceId": "[parameters('aiHubId')]"
              },
              "kind": "project"
            },
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2023-08-01",
              "name": "WaitForProjectDeployment",
              "location": "[parameters('location')]",
              "kind": "AzurePowerShell",
              "properties": {
                "azPowerShellVersion": "10.0",
                "scriptContent": "      Write-Output \"Starting wait script...\"\r\n      Start-Sleep -Seconds 120  # Wait for 2 minutes\r\n      Write-Output \"Wait completed. Proceeding with deployment...\"\r\n    ",
                "retentionInterval": "PT1H",
                "cleanupPreference": "OnSuccess"
              },
              "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiProjectName'))]"
              ]
            }
          ],
          "outputs": {
            "aiProjectName": {
              "type": "string",
              "value": "[parameters('aiProjectName')]"
            },
            "aiProjectResourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiProjectName'))]"
            },
            "aiProjectPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiProjectName')), '2023-08-01-preview', 'full').identity.principalId]"
            },
            "aiProjectWorkspaceId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiProjectName')), '2023-08-01-preview').workspaceId]"
            },
            "projectConnectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiProjectName')), '2023-08-01-preview', 'full').tags.ProjectConnectionString]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('aiHub{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('createDnsZones')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('all-dns-zones{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "tags": {
            "value": "[variables('tags')]"
          },
          "vnetResourceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('vnet{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.vnetResourceId.value]"
          },
          "keyVaultPrivateEndpointName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('keyvault{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.privateEndpointName.value]"
          },
          "acrPrivateEndpointName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('containerregistry{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.privateEndpointName.value]"
          },
          "openAiPrivateEndpointName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('openai{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.privateEndpointName.value]"
          },
          "aiSearchPrivateEndpointName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('search{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.privateEndpointName.value]"
          },
          "documentIntelligencePrivateEndpointName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('doc-intelligence{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.privateEndpointName.value]"
          },
          "cosmosPrivateEndpointName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('cosmos{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.privateEndpointName.value]"
          },
          "storageBlobPrivateEndpointName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.privateEndpointBlobName.value]"
          },
          "storageQueuePrivateEndpointName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.privateEndpointQueueName.value]"
          },
          "storageTablePrivateEndpointName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.privateEndpointTableName.value]"
          },
          "defaultAcaDomain": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('caenv{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.defaultDomain.value]"
          },
          "acaStaticIp": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('caenv{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.staticIp.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "8860230313462661147"
            }
          },
          "parameters": {
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "vnetResourceId": {
              "type": "string"
            },
            "keyVaultPrivateEndpointName": {
              "type": "string"
            },
            "acrPrivateEndpointName": {
              "type": "string"
            },
            "openAiPrivateEndpointName": {
              "type": "string"
            },
            "documentIntelligencePrivateEndpointName": {
              "type": "string"
            },
            "aiSearchPrivateEndpointName": {
              "type": "string"
            },
            "cosmosPrivateEndpointName": {
              "type": "string"
            },
            "storageBlobPrivateEndpointName": {
              "type": "string"
            },
            "storageQueuePrivateEndpointName": {
              "type": "string"
            },
            "storageTablePrivateEndpointName": {
              "type": "string"
            },
            "defaultAcaDomain": {
              "type": "string",
              "defaultValue": ""
            },
            "acaStaticIp": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "resources": [
            {
              "condition": "[not(empty(parameters('defaultAcaDomain')))]",
              "type": "Microsoft.Network/privateDnsZones/A",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', parameters('defaultAcaDomain'), '*')]",
              "properties": {
                "ttl": 3600,
                "aRecords": [
                  {
                    "ipv4Address": "[parameters('acaStaticIp')]"
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', parameters('defaultAcaDomain'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('defaultAcaDomain')))]",
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "[parameters('defaultAcaDomain')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {}
            },
            {
              "condition": "[not(empty(parameters('defaultAcaDomain')))]",
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', parameters('defaultAcaDomain'), uniqueString(resourceId('Microsoft.Network/privateDnsZones', parameters('defaultAcaDomain'))))]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('vnetResourceId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', parameters('defaultAcaDomain'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "kvZone",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "zoneName": {
                    "value": "privatelink.vaultcore.azure.net"
                  },
                  "vnetResourceId": {
                    "value": "[parameters('vnetResourceId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "privateEndpointNames": {
                    "value": [
                      "[parameters('keyVaultPrivateEndpointName')]"
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.0",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "11382683741560521055"
                    }
                  },
                  "parameters": {
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "vnetResourceId": {
                      "type": "string"
                    },
                    "zoneName": {
                      "type": "string"
                    },
                    "privateEndpointNames": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  },
                  "resources": {
                    "pe": {
                      "copy": {
                        "name": "pe",
                        "count": "[length(parameters('privateEndpointNames'))]"
                      },
                      "existing": true,
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('privateEndpointNames')[copyIndex()]]"
                    },
                    "privateEndpointDnsGroupname": {
                      "copy": {
                        "name": "privateEndpointDnsGroupname",
                        "count": "[length(parameters('privateEndpointNames'))]"
                      },
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2022-07-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointNames')[copyIndex()], format('{0}-dnsgroup', parameters('privateEndpointNames')[copyIndex()]))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "[format('config for {0}', parameters('privateEndpointNames')[copyIndex()])]",
                            "properties": {
                              "privateDnsZoneId": "[reference('zone').outputs.id.value]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "zone"
                      ]
                    },
                    "zone": {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('{0}-zone', parameters('zoneName'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "zoneName": {
                            "value": "[parameters('zoneName')]"
                          },
                          "vnetResourceId": {
                            "value": "[parameters('vnetResourceId')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.34.44.8038",
                              "templateHash": "13747392950348581503"
                            }
                          },
                          "parameters": {
                            "zoneName": {
                              "type": "string"
                            },
                            "vnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object",
                              "defaultValue": {}
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/privateDnsZones",
                              "apiVersion": "2020-06-01",
                              "name": "[parameters('zoneName')]",
                              "location": "global",
                              "tags": "[parameters('tags')]",
                              "properties": {}
                            },
                            {
                              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                              "apiVersion": "2020-06-01",
                              "name": "[format('{0}/{1}', parameters('zoneName'), uniqueString(resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))))]",
                              "location": "global",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "registrationEnabled": false,
                                "virtualNetwork": {
                                  "id": "[parameters('vnetResourceId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "id": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                            },
                            "zoneName": {
                              "type": "string",
                              "value": "[parameters('zoneName')]"
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "acrZone",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "zoneName": {
                    "value": "privatelink.azurecr.io"
                  },
                  "vnetResourceId": {
                    "value": "[parameters('vnetResourceId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "privateEndpointNames": {
                    "value": [
                      "[parameters('acrPrivateEndpointName')]"
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.0",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "11382683741560521055"
                    }
                  },
                  "parameters": {
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "vnetResourceId": {
                      "type": "string"
                    },
                    "zoneName": {
                      "type": "string"
                    },
                    "privateEndpointNames": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  },
                  "resources": {
                    "pe": {
                      "copy": {
                        "name": "pe",
                        "count": "[length(parameters('privateEndpointNames'))]"
                      },
                      "existing": true,
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('privateEndpointNames')[copyIndex()]]"
                    },
                    "privateEndpointDnsGroupname": {
                      "copy": {
                        "name": "privateEndpointDnsGroupname",
                        "count": "[length(parameters('privateEndpointNames'))]"
                      },
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2022-07-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointNames')[copyIndex()], format('{0}-dnsgroup', parameters('privateEndpointNames')[copyIndex()]))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "[format('config for {0}', parameters('privateEndpointNames')[copyIndex()])]",
                            "properties": {
                              "privateDnsZoneId": "[reference('zone').outputs.id.value]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "zone"
                      ]
                    },
                    "zone": {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('{0}-zone', parameters('zoneName'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "zoneName": {
                            "value": "[parameters('zoneName')]"
                          },
                          "vnetResourceId": {
                            "value": "[parameters('vnetResourceId')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.34.44.8038",
                              "templateHash": "13747392950348581503"
                            }
                          },
                          "parameters": {
                            "zoneName": {
                              "type": "string"
                            },
                            "vnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object",
                              "defaultValue": {}
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/privateDnsZones",
                              "apiVersion": "2020-06-01",
                              "name": "[parameters('zoneName')]",
                              "location": "global",
                              "tags": "[parameters('tags')]",
                              "properties": {}
                            },
                            {
                              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                              "apiVersion": "2020-06-01",
                              "name": "[format('{0}/{1}', parameters('zoneName'), uniqueString(resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))))]",
                              "location": "global",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "registrationEnabled": false,
                                "virtualNetwork": {
                                  "id": "[parameters('vnetResourceId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "id": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                            },
                            "zoneName": {
                              "type": "string",
                              "value": "[parameters('zoneName')]"
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "openAiZone",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "zoneName": {
                    "value": "privatelink.openai.azure.com"
                  },
                  "vnetResourceId": {
                    "value": "[parameters('vnetResourceId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "privateEndpointNames": {
                    "value": [
                      "[parameters('openAiPrivateEndpointName')]"
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.0",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "11382683741560521055"
                    }
                  },
                  "parameters": {
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "vnetResourceId": {
                      "type": "string"
                    },
                    "zoneName": {
                      "type": "string"
                    },
                    "privateEndpointNames": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  },
                  "resources": {
                    "pe": {
                      "copy": {
                        "name": "pe",
                        "count": "[length(parameters('privateEndpointNames'))]"
                      },
                      "existing": true,
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('privateEndpointNames')[copyIndex()]]"
                    },
                    "privateEndpointDnsGroupname": {
                      "copy": {
                        "name": "privateEndpointDnsGroupname",
                        "count": "[length(parameters('privateEndpointNames'))]"
                      },
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2022-07-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointNames')[copyIndex()], format('{0}-dnsgroup', parameters('privateEndpointNames')[copyIndex()]))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "[format('config for {0}', parameters('privateEndpointNames')[copyIndex()])]",
                            "properties": {
                              "privateDnsZoneId": "[reference('zone').outputs.id.value]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "zone"
                      ]
                    },
                    "zone": {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('{0}-zone', parameters('zoneName'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "zoneName": {
                            "value": "[parameters('zoneName')]"
                          },
                          "vnetResourceId": {
                            "value": "[parameters('vnetResourceId')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.34.44.8038",
                              "templateHash": "13747392950348581503"
                            }
                          },
                          "parameters": {
                            "zoneName": {
                              "type": "string"
                            },
                            "vnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object",
                              "defaultValue": {}
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/privateDnsZones",
                              "apiVersion": "2020-06-01",
                              "name": "[parameters('zoneName')]",
                              "location": "global",
                              "tags": "[parameters('tags')]",
                              "properties": {}
                            },
                            {
                              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                              "apiVersion": "2020-06-01",
                              "name": "[format('{0}/{1}', parameters('zoneName'), uniqueString(resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))))]",
                              "location": "global",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "registrationEnabled": false,
                                "virtualNetwork": {
                                  "id": "[parameters('vnetResourceId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "id": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                            },
                            "zoneName": {
                              "type": "string",
                              "value": "[parameters('zoneName')]"
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "docInteliZone",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "zoneName": {
                    "value": "privatelink.cognitiveservices.azure.com"
                  },
                  "vnetResourceId": {
                    "value": "[parameters('vnetResourceId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "privateEndpointNames": {
                    "value": [
                      "[parameters('documentIntelligencePrivateEndpointName')]"
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.0",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "11382683741560521055"
                    }
                  },
                  "parameters": {
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "vnetResourceId": {
                      "type": "string"
                    },
                    "zoneName": {
                      "type": "string"
                    },
                    "privateEndpointNames": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  },
                  "resources": {
                    "pe": {
                      "copy": {
                        "name": "pe",
                        "count": "[length(parameters('privateEndpointNames'))]"
                      },
                      "existing": true,
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('privateEndpointNames')[copyIndex()]]"
                    },
                    "privateEndpointDnsGroupname": {
                      "copy": {
                        "name": "privateEndpointDnsGroupname",
                        "count": "[length(parameters('privateEndpointNames'))]"
                      },
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2022-07-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointNames')[copyIndex()], format('{0}-dnsgroup', parameters('privateEndpointNames')[copyIndex()]))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "[format('config for {0}', parameters('privateEndpointNames')[copyIndex()])]",
                            "properties": {
                              "privateDnsZoneId": "[reference('zone').outputs.id.value]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "zone"
                      ]
                    },
                    "zone": {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('{0}-zone', parameters('zoneName'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "zoneName": {
                            "value": "[parameters('zoneName')]"
                          },
                          "vnetResourceId": {
                            "value": "[parameters('vnetResourceId')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.34.44.8038",
                              "templateHash": "13747392950348581503"
                            }
                          },
                          "parameters": {
                            "zoneName": {
                              "type": "string"
                            },
                            "vnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object",
                              "defaultValue": {}
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/privateDnsZones",
                              "apiVersion": "2020-06-01",
                              "name": "[parameters('zoneName')]",
                              "location": "global",
                              "tags": "[parameters('tags')]",
                              "properties": {}
                            },
                            {
                              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                              "apiVersion": "2020-06-01",
                              "name": "[format('{0}/{1}', parameters('zoneName'), uniqueString(resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))))]",
                              "location": "global",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "registrationEnabled": false,
                                "virtualNetwork": {
                                  "id": "[parameters('vnetResourceId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "id": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                            },
                            "zoneName": {
                              "type": "string",
                              "value": "[parameters('zoneName')]"
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "aiSearchZone",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "zoneName": {
                    "value": "privatelink.search.windows.net"
                  },
                  "vnetResourceId": {
                    "value": "[parameters('vnetResourceId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "privateEndpointNames": {
                    "value": [
                      "[parameters('aiSearchPrivateEndpointName')]"
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.0",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "11382683741560521055"
                    }
                  },
                  "parameters": {
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "vnetResourceId": {
                      "type": "string"
                    },
                    "zoneName": {
                      "type": "string"
                    },
                    "privateEndpointNames": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  },
                  "resources": {
                    "pe": {
                      "copy": {
                        "name": "pe",
                        "count": "[length(parameters('privateEndpointNames'))]"
                      },
                      "existing": true,
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('privateEndpointNames')[copyIndex()]]"
                    },
                    "privateEndpointDnsGroupname": {
                      "copy": {
                        "name": "privateEndpointDnsGroupname",
                        "count": "[length(parameters('privateEndpointNames'))]"
                      },
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2022-07-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointNames')[copyIndex()], format('{0}-dnsgroup', parameters('privateEndpointNames')[copyIndex()]))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "[format('config for {0}', parameters('privateEndpointNames')[copyIndex()])]",
                            "properties": {
                              "privateDnsZoneId": "[reference('zone').outputs.id.value]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "zone"
                      ]
                    },
                    "zone": {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('{0}-zone', parameters('zoneName'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "zoneName": {
                            "value": "[parameters('zoneName')]"
                          },
                          "vnetResourceId": {
                            "value": "[parameters('vnetResourceId')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.34.44.8038",
                              "templateHash": "13747392950348581503"
                            }
                          },
                          "parameters": {
                            "zoneName": {
                              "type": "string"
                            },
                            "vnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object",
                              "defaultValue": {}
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/privateDnsZones",
                              "apiVersion": "2020-06-01",
                              "name": "[parameters('zoneName')]",
                              "location": "global",
                              "tags": "[parameters('tags')]",
                              "properties": {}
                            },
                            {
                              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                              "apiVersion": "2020-06-01",
                              "name": "[format('{0}/{1}', parameters('zoneName'), uniqueString(resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))))]",
                              "location": "global",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "registrationEnabled": false,
                                "virtualNetwork": {
                                  "id": "[parameters('vnetResourceId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "id": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                            },
                            "zoneName": {
                              "type": "string",
                              "value": "[parameters('zoneName')]"
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "cosmosZone",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "zoneName": {
                    "value": "privatelink.documents.azure.com"
                  },
                  "vnetResourceId": {
                    "value": "[parameters('vnetResourceId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "privateEndpointNames": {
                    "value": [
                      "[parameters('cosmosPrivateEndpointName')]"
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.0",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "11382683741560521055"
                    }
                  },
                  "parameters": {
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "vnetResourceId": {
                      "type": "string"
                    },
                    "zoneName": {
                      "type": "string"
                    },
                    "privateEndpointNames": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  },
                  "resources": {
                    "pe": {
                      "copy": {
                        "name": "pe",
                        "count": "[length(parameters('privateEndpointNames'))]"
                      },
                      "existing": true,
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('privateEndpointNames')[copyIndex()]]"
                    },
                    "privateEndpointDnsGroupname": {
                      "copy": {
                        "name": "privateEndpointDnsGroupname",
                        "count": "[length(parameters('privateEndpointNames'))]"
                      },
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2022-07-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointNames')[copyIndex()], format('{0}-dnsgroup', parameters('privateEndpointNames')[copyIndex()]))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "[format('config for {0}', parameters('privateEndpointNames')[copyIndex()])]",
                            "properties": {
                              "privateDnsZoneId": "[reference('zone').outputs.id.value]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "zone"
                      ]
                    },
                    "zone": {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('{0}-zone', parameters('zoneName'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "zoneName": {
                            "value": "[parameters('zoneName')]"
                          },
                          "vnetResourceId": {
                            "value": "[parameters('vnetResourceId')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.34.44.8038",
                              "templateHash": "13747392950348581503"
                            }
                          },
                          "parameters": {
                            "zoneName": {
                              "type": "string"
                            },
                            "vnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object",
                              "defaultValue": {}
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/privateDnsZones",
                              "apiVersion": "2020-06-01",
                              "name": "[parameters('zoneName')]",
                              "location": "global",
                              "tags": "[parameters('tags')]",
                              "properties": {}
                            },
                            {
                              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                              "apiVersion": "2020-06-01",
                              "name": "[format('{0}/{1}', parameters('zoneName'), uniqueString(resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))))]",
                              "location": "global",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "registrationEnabled": false,
                                "virtualNetwork": {
                                  "id": "[parameters('vnetResourceId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "id": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                            },
                            "zoneName": {
                              "type": "string",
                              "value": "[parameters('zoneName')]"
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "storageBlobZone",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "zoneName": {
                    "value": "[format('privatelink.blob.{0}', environment().suffixes.storage)]"
                  },
                  "vnetResourceId": {
                    "value": "[parameters('vnetResourceId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "privateEndpointNames": {
                    "value": [
                      "[parameters('storageBlobPrivateEndpointName')]"
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.0",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "11382683741560521055"
                    }
                  },
                  "parameters": {
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "vnetResourceId": {
                      "type": "string"
                    },
                    "zoneName": {
                      "type": "string"
                    },
                    "privateEndpointNames": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  },
                  "resources": {
                    "pe": {
                      "copy": {
                        "name": "pe",
                        "count": "[length(parameters('privateEndpointNames'))]"
                      },
                      "existing": true,
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('privateEndpointNames')[copyIndex()]]"
                    },
                    "privateEndpointDnsGroupname": {
                      "copy": {
                        "name": "privateEndpointDnsGroupname",
                        "count": "[length(parameters('privateEndpointNames'))]"
                      },
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2022-07-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointNames')[copyIndex()], format('{0}-dnsgroup', parameters('privateEndpointNames')[copyIndex()]))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "[format('config for {0}', parameters('privateEndpointNames')[copyIndex()])]",
                            "properties": {
                              "privateDnsZoneId": "[reference('zone').outputs.id.value]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "zone"
                      ]
                    },
                    "zone": {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('{0}-zone', parameters('zoneName'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "zoneName": {
                            "value": "[parameters('zoneName')]"
                          },
                          "vnetResourceId": {
                            "value": "[parameters('vnetResourceId')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.34.44.8038",
                              "templateHash": "13747392950348581503"
                            }
                          },
                          "parameters": {
                            "zoneName": {
                              "type": "string"
                            },
                            "vnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object",
                              "defaultValue": {}
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/privateDnsZones",
                              "apiVersion": "2020-06-01",
                              "name": "[parameters('zoneName')]",
                              "location": "global",
                              "tags": "[parameters('tags')]",
                              "properties": {}
                            },
                            {
                              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                              "apiVersion": "2020-06-01",
                              "name": "[format('{0}/{1}', parameters('zoneName'), uniqueString(resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))))]",
                              "location": "global",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "registrationEnabled": false,
                                "virtualNetwork": {
                                  "id": "[parameters('vnetResourceId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "id": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                            },
                            "zoneName": {
                              "type": "string",
                              "value": "[parameters('zoneName')]"
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "storageTableZone",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "zoneName": {
                    "value": "[format('privatelink.table.{0}', environment().suffixes.storage)]"
                  },
                  "vnetResourceId": {
                    "value": "[parameters('vnetResourceId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "privateEndpointNames": {
                    "value": [
                      "[parameters('storageTablePrivateEndpointName')]"
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.0",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "11382683741560521055"
                    }
                  },
                  "parameters": {
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "vnetResourceId": {
                      "type": "string"
                    },
                    "zoneName": {
                      "type": "string"
                    },
                    "privateEndpointNames": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  },
                  "resources": {
                    "pe": {
                      "copy": {
                        "name": "pe",
                        "count": "[length(parameters('privateEndpointNames'))]"
                      },
                      "existing": true,
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('privateEndpointNames')[copyIndex()]]"
                    },
                    "privateEndpointDnsGroupname": {
                      "copy": {
                        "name": "privateEndpointDnsGroupname",
                        "count": "[length(parameters('privateEndpointNames'))]"
                      },
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2022-07-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointNames')[copyIndex()], format('{0}-dnsgroup', parameters('privateEndpointNames')[copyIndex()]))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "[format('config for {0}', parameters('privateEndpointNames')[copyIndex()])]",
                            "properties": {
                              "privateDnsZoneId": "[reference('zone').outputs.id.value]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "zone"
                      ]
                    },
                    "zone": {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('{0}-zone', parameters('zoneName'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "zoneName": {
                            "value": "[parameters('zoneName')]"
                          },
                          "vnetResourceId": {
                            "value": "[parameters('vnetResourceId')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.34.44.8038",
                              "templateHash": "13747392950348581503"
                            }
                          },
                          "parameters": {
                            "zoneName": {
                              "type": "string"
                            },
                            "vnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object",
                              "defaultValue": {}
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/privateDnsZones",
                              "apiVersion": "2020-06-01",
                              "name": "[parameters('zoneName')]",
                              "location": "global",
                              "tags": "[parameters('tags')]",
                              "properties": {}
                            },
                            {
                              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                              "apiVersion": "2020-06-01",
                              "name": "[format('{0}/{1}', parameters('zoneName'), uniqueString(resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))))]",
                              "location": "global",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "registrationEnabled": false,
                                "virtualNetwork": {
                                  "id": "[parameters('vnetResourceId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "id": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                            },
                            "zoneName": {
                              "type": "string",
                              "value": "[parameters('zoneName')]"
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "storageQueueZone",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "zoneName": {
                    "value": "[format('privatelink.queue.{0}', environment().suffixes.storage)]"
                  },
                  "vnetResourceId": {
                    "value": "[parameters('vnetResourceId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "privateEndpointNames": {
                    "value": [
                      "[parameters('storageQueuePrivateEndpointName')]"
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.0",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "11382683741560521055"
                    }
                  },
                  "parameters": {
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "vnetResourceId": {
                      "type": "string"
                    },
                    "zoneName": {
                      "type": "string"
                    },
                    "privateEndpointNames": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  },
                  "resources": {
                    "pe": {
                      "copy": {
                        "name": "pe",
                        "count": "[length(parameters('privateEndpointNames'))]"
                      },
                      "existing": true,
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2023-06-01",
                      "name": "[parameters('privateEndpointNames')[copyIndex()]]"
                    },
                    "privateEndpointDnsGroupname": {
                      "copy": {
                        "name": "privateEndpointDnsGroupname",
                        "count": "[length(parameters('privateEndpointNames'))]"
                      },
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2022-07-01",
                      "name": "[format('{0}/{1}', parameters('privateEndpointNames')[copyIndex()], format('{0}-dnsgroup', parameters('privateEndpointNames')[copyIndex()]))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "[format('config for {0}', parameters('privateEndpointNames')[copyIndex()])]",
                            "properties": {
                              "privateDnsZoneId": "[reference('zone').outputs.id.value]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "zone"
                      ]
                    },
                    "zone": {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('{0}-zone', parameters('zoneName'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "zoneName": {
                            "value": "[parameters('zoneName')]"
                          },
                          "vnetResourceId": {
                            "value": "[parameters('vnetResourceId')]"
                          },
                          "tags": {
                            "value": "[parameters('tags')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.34.44.8038",
                              "templateHash": "13747392950348581503"
                            }
                          },
                          "parameters": {
                            "zoneName": {
                              "type": "string"
                            },
                            "vnetResourceId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object",
                              "defaultValue": {}
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Network/privateDnsZones",
                              "apiVersion": "2020-06-01",
                              "name": "[parameters('zoneName')]",
                              "location": "global",
                              "tags": "[parameters('tags')]",
                              "properties": {}
                            },
                            {
                              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                              "apiVersion": "2020-06-01",
                              "name": "[format('{0}/{1}', parameters('zoneName'), uniqueString(resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))))]",
                              "location": "global",
                              "tags": "[parameters('tags')]",
                              "properties": {
                                "registrationEnabled": false,
                                "virtualNetwork": {
                                  "id": "[parameters('vnetResourceId')]"
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                              ]
                            }
                          ],
                          "outputs": {
                            "id": {
                              "type": "string",
                              "value": "[resourceId('Microsoft.Network/privateDnsZones', parameters('zoneName'))]"
                            },
                            "zoneName": {
                              "type": "string",
                              "value": "[parameters('zoneName')]"
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('containerregistry{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('cosmos{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('doc-intelligence{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('keyvault{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('caenv{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('openai{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('search{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('vnet{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('caenv{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "existingEnvironmentName": {
            "value": "[parameters('existing_managedAppEnv_Name')]"
          },
          "newEnvironmentName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.caManagedEnvName.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsWorkspaceName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('law{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.logAnalyticsWorkspaceName.value]"
          },
          "logAnalyticsRgName": {
            "value": "[variables('resourceGroupName')]"
          },
          "appSubnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('vnet{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.subnetAppSeResourceID.value]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "publicAccessEnabled": {
            "value": "[parameters('publicAccessEnabled')]"
          },
          "containerAppEnvironmentWorkloadProfiles": {
            "value": "[parameters('containerAppEnvironmentWorkloadProfiles')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "7411079828564667049"
            }
          },
          "parameters": {
            "newEnvironmentName": {
              "type": "string",
              "defaultValue": ""
            },
            "existingEnvironmentName": {
              "type": "string",
              "defaultValue": ""
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "logAnalyticsWorkspaceName": {
              "type": "string"
            },
            "logAnalyticsRgName": {
              "type": "string"
            },
            "appSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "publicAccessEnabled": {
              "type": "bool",
              "defaultValue": true
            },
            "containerAppEnvironmentWorkloadProfiles": {
              "type": "array"
            }
          },
          "variables": {
            "useExistingEnvironment": "[not(empty(parameters('existingEnvironmentName')))]",
            "cleanAppEnvName": "[replace(parameters('newEnvironmentName'), '_', '-')]",
            "resourceGroupName": "[resourceGroup().name]"
          },
          "resources": [
            {
              "condition": "[not(variables('useExistingEnvironment'))]",
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2024-03-01",
              "name": "[variables('cleanAppEnvName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('logAnalyticsRgName')), 'Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName')), '2023-09-01').customerId]",
                    "sharedKey": "[listKeys(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('logAnalyticsRgName')), 'Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName')), '2023-09-01').primarySharedKey]"
                  }
                },
                "vnetConfiguration": "[if(not(empty(parameters('appSubnetId'))), createObject('infrastructureSubnetId', parameters('appSubnetId'), 'internal', not(parameters('publicAccessEnabled'))), createObject())]",
                "workloadProfiles": "[parameters('containerAppEnvironmentWorkloadProfiles')]"
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[if(variables('useExistingEnvironment'), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.App/managedEnvironments', parameters('existingEnvironmentName')), resourceId('Microsoft.App/managedEnvironments', variables('cleanAppEnvName')))]"
            },
            "name": {
              "type": "string",
              "value": "[if(variables('useExistingEnvironment'), parameters('existingEnvironmentName'), variables('cleanAppEnvName'))]"
            },
            "resourceGroupName": {
              "type": "string",
              "value": "[variables('resourceGroupName')]"
            },
            "defaultDomain": {
              "type": "string",
              "value": "[if(variables('useExistingEnvironment'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.App/managedEnvironments', parameters('existingEnvironmentName')), '2024-03-01').defaultDomain, reference(resourceId('Microsoft.App/managedEnvironments', variables('cleanAppEnvName')), '2024-03-01').defaultDomain)]"
            },
            "staticIp": {
              "type": "string",
              "value": "[if(variables('useExistingEnvironment'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.App/managedEnvironments', parameters('existingEnvironmentName')), '2024-03-01').staticIp, reference(resourceId('Microsoft.App/managedEnvironments', variables('cleanAppEnvName')), '2024-03-01').staticIp)]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('law{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('vnet{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deployAPIApp')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('ca-api-stub{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.containerAppAPIName.value]"
          },
          "managedEnvironmentName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('caenv{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "managedEnvironmentRg": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('caenv{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.resourceGroupName.value]"
          },
          "workloadProfileName": {
            "value": "[parameters('appContainerAppEnvironmentWorkloadProfileName')]"
          },
          "registryName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.ACR_Name.value]"
          },
          "targetPort": {
            "value": "[variables('apiTargetPort')]"
          },
          "userAssignedIdentityName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('app-identity{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.managedIdentityName.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "imageName": {
            "value": "[parameters('apiImageName')]"
          },
          "tags": {
            "value": "[union(variables('tags'), createObject('azd-service-name', 'api'))]"
          },
          "deploymentSuffix": {
            "value": "[variables('deploymentSuffix')]"
          },
          "secrets": {
            "value": {
              "cosmos": "[reference(resourceId('Microsoft.Resources/deployments', format('secret-cosmos{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.secretUri.value]",
              "aikey": "[reference(resourceId('Microsoft.Resources/deployments', format('secret-openai{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.secretUri.value]",
              "docintellikey": "[reference(resourceId('Microsoft.Resources/deployments', format('secret-doc-intelligence{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.secretUri.value]",
              "searchkey": "[reference(resourceId('Microsoft.Resources/deployments', format('secret-search{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.secretUri.value]",
              "apikey": "[reference(resourceId('Microsoft.Resources/deployments', format('secret-api-key{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.secretUri.value]"
            }
          },
          "env": {
            "value": [
              {
                "name": "AnalysisApiEndpoint",
                "value": "[format('https://{0}.{1}', reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.containerAppAPIName.value, reference(resourceId('Microsoft.Resources/deployments', format('caenv{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.defaultDomain.value)]"
              },
              {
                "name": "AnalysisApiKey",
                "secretRef": "apikey"
              },
              {
                "name": "AOAIStandardServiceEndpoint",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', format('openai{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.endpoint.value]"
              },
              {
                "name": "AOAIStandardChatGptDeployment",
                "value": "gpt-4o"
              },
              {
                "name": "ApiKey",
                "secretRef": "apikey"
              },
              {
                "name": "PORT",
                "value": "[format('{0}', variables('apiTargetPort'))]"
              },
              {
                "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', format('law{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.appInsightsConnectionString.value]"
              },
              {
                "name": "AZURE_CLIENT_ID",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', format('app-identity{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.managedIdentityClientId.value]"
              },
              {
                "name": "AzureDocumentIntelligenceEndpoint",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', format('doc-intelligence{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.endpoint.value]"
              },
              {
                "name": "AzureAISearchEndpoint",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', format('search{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.endpoint.value]"
              },
              {
                "name": "ContentStorageContainer",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.containerNames.value[0].name]"
              },
              {
                "name": "CosmosDbEndpoint",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', format('cosmos{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.endpoint.value]"
              },
              {
                "name": "StorageAccountName",
                "value": "[reference(resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "16950922224624613512"
            }
          },
          "parameters": {
            "appName": {
              "type": "string",
              "maxLength": 32
            },
            "managedEnvironmentName": {
              "type": "string"
            },
            "managedEnvironmentRg": {
              "type": "string"
            },
            "imageName": {
              "type": "string",
              "defaultValue": ""
            },
            "registryName": {
              "type": "string"
            },
            "userAssignedIdentityName": {
              "type": "string"
            },
            "workloadProfileName": {
              "type": "string"
            },
            "targetPort": {
              "type": "int",
              "defaultValue": 80,
              "metadata": {
                "description": "The target port for the container"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "deploymentSuffix": {
              "type": "string",
              "defaultValue": ""
            },
            "secrets": {
              "type": "secureObject",
              "defaultValue": {},
              "metadata": {
                "description": "The secrets required for the container, with the key being the secret name and the value being the key vault URL"
              }
            },
            "env": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "The environment variables for the container"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[parameters('appName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName')))]": {}
                }
              },
              "properties": {
                "managedEnvironmentId": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('managedEnvironmentRg')), 'Microsoft.App/managedEnvironments', parameters('managedEnvironmentName'))]",
                "configuration": {
                  "copy": [
                    {
                      "name": "secrets",
                      "count": "[length(items(parameters('secrets')))]",
                      "input": {
                        "name": "[items(parameters('secrets'))[copyIndex('secrets')].key]",
                        "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName'))]",
                        "keyVaultUrl": "[items(parameters('secrets'))[copyIndex('secrets')].value]"
                      }
                    }
                  ],
                  "ingress": {
                    "external": true,
                    "targetPort": "[parameters('targetPort')]",
                    "transport": "auto"
                  },
                  "registries": [
                    {
                      "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName'))]",
                      "server": "[format('{0}.azurecr.io', parameters('registryName'))]"
                    }
                  ]
                },
                "template": {
                  "containers": [
                    {
                      "name": "[parameters('workloadProfileName')]",
                      "image": "[coalesce(tryGet(tryGet(tryGet(tryGet(reference(resourceId('Microsoft.Resources/deployments', format('app-fetch-image-{0}{1}', parameters('appName'), parameters('deploymentSuffix'))), '2022-09-01').outputs, 'containers'), 'value'), 0), 'image'), 'mcr.microsoft.com/azuredocs/containerapps-helloworld:latest')]",
                      "env": "[parameters('env')]",
                      "resources": {
                        "cpu": "[json('0.5')]",
                        "memory": "1.0Gi"
                      },
                      "probes": [
                        {
                          "type": "Liveness",
                          "httpGet": {
                            "path": "/healthz/live",
                            "port": "[parameters('targetPort')]"
                          }
                        },
                        {
                          "type": "Readiness",
                          "httpGet": {
                            "path": "/healthz/ready",
                            "port": "[parameters('targetPort')]"
                          }
                        },
                        {
                          "type": "Startup",
                          "httpGet": {
                            "path": "/healthz/startup",
                            "port": "[parameters('targetPort')]"
                          }
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": 1,
                    "maxReplicas": 10
                  }
                },
                "workloadProfileName": "[parameters('workloadProfileName')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('app-fetch-image-{0}{1}', parameters('appName'), parameters('deploymentSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('app-fetch-image-{0}{1}', parameters('appName'), parameters('deploymentSuffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "exists": {
                    "value": false
                  },
                  "name": {
                    "value": "[parameters('imageName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "3738304863567409488"
                    }
                  },
                  "parameters": {
                    "exists": {
                      "type": "bool"
                    },
                    "name": {
                      "type": "string"
                    }
                  },
                  "resources": [],
                  "outputs": {
                    "containers": {
                      "type": "array",
                      "value": "[if(parameters('exists'), reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2023-05-02-preview').template.containers, createArray())]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/containerApps', parameters('appName'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('appName')]"
            },
            "fqdn": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('appName')), '2024-03-01').configuration.ingress.fqdn]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('all-dns-zones{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('secret-api-key{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('containerregistry{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('cosmos{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('secret-cosmos{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('doc-intelligence{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('secret-doc-intelligence{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('app-identity{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('law{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('caenv{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('openai{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('secret-openai{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('secret-search{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('search{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix')))]"
      ]
    },
    {
      "condition": "[parameters('deployBatchApp')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('ca-batch-stub{0}', variables('deploymentSuffix'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.containerAppBatchName.value]"
          },
          "managedEnvironmentName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('caenv{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
          },
          "managedEnvironmentRg": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('caenv{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.resourceGroupName.value]"
          },
          "workloadProfileName": {
            "value": "[parameters('appContainerAppEnvironmentWorkloadProfileName')]"
          },
          "registryName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.ACR_Name.value]"
          },
          "targetPort": {
            "value": "[variables('batchTargetPort')]"
          },
          "userAssignedIdentityName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('app-identity{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.managedIdentityName.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "imageName": {
            "value": "[parameters('batchImageName')]"
          },
          "tags": {
            "value": "[union(variables('tags'), createObject('azd-service-name', 'batch'))]"
          },
          "deploymentSuffix": {
            "value": "[variables('deploymentSuffix')]"
          },
          "secrets": {
            "value": {
              "cosmos": "[reference(resourceId('Microsoft.Resources/deployments', format('secret-cosmos{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.secretUri.value]",
              "aikey": "[reference(resourceId('Microsoft.Resources/deployments', format('secret-openai{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.secretUri.value]",
              "docintellikey": "[reference(resourceId('Microsoft.Resources/deployments', format('secret-doc-intelligence{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.secretUri.value]",
              "searchkey": "[reference(resourceId('Microsoft.Resources/deployments', format('secret-search{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.secretUri.value]",
              "apikey": "[reference(resourceId('Microsoft.Resources/deployments', format('secret-api-key{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.secretUri.value]"
            }
          },
          "env": {
            "value": "[union(createArray(createObject('name', 'AnalysisApiEndpoint', 'value', format('https://{0}.{1}', reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.containerAppAPIName.value, reference(resourceId('Microsoft.Resources/deployments', format('caenv{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.defaultDomain.value)), createObject('name', 'AnalysisApiKey', 'secretRef', 'apikey'), createObject('name', 'AOAIStandardServiceEndpoint', 'value', reference(resourceId('Microsoft.Resources/deployments', format('openai{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.endpoint.value), createObject('name', 'AOAIStandardChatGptDeployment', 'value', 'gpt-4o'), createObject('name', 'ApiKey', 'secretRef', 'apikey'), createObject('name', 'PORT', 'value', format('{0}', variables('apiTargetPort'))), createObject('name', 'APPLICATIONINSIGHTS_CONNECTION_STRING', 'value', reference(resourceId('Microsoft.Resources/deployments', format('law{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.appInsightsConnectionString.value), createObject('name', 'AZURE_CLIENT_ID', 'value', reference(resourceId('Microsoft.Resources/deployments', format('app-identity{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.managedIdentityClientId.value), createObject('name', 'AzureDocumentIntelligenceEndpoint', 'value', reference(resourceId('Microsoft.Resources/deployments', format('doc-intelligence{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.endpoint.value), createObject('name', 'AzureAISearchEndpoint', 'value', reference(resourceId('Microsoft.Resources/deployments', format('search{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.endpoint.value), createObject('name', 'ContentStorageContainer', 'value', reference(resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.containerNames.value[0].name), createObject('name', 'CosmosDbEndpoint', 'value', reference(resourceId('Microsoft.Resources/deployments', format('cosmos{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.endpoint.value), createObject('name', 'StorageAccountName', 'value', reference(resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value)), createArray(createObject('name', 'FUNCTIONS_WORKER_RUNTIME', 'value', 'dotnet-isolated'), createObject('name', 'AzureWebJobsStorage__accountName', 'value', reference(resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value), createObject('name', 'AzureWebJobsStorage__credential', 'value', 'managedidentity'), createObject('name', 'AzureWebJobsStorage__clientId', 'value', reference(resourceId('Microsoft.Resources/deployments', format('app-identity{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.managedIdentityClientId.value), createObject('name', 'BatchAnalysisStorageAccountName', 'value', reference(resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value), createObject('name', 'BatchAnalysisStorageInputContainerName', 'value', reference(resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.containerNames.value[1].name), createObject('name', 'BatchAnalysisStorageOutputContainerName', 'value', reference(resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.containerNames.value[2].name), createObject('name', 'CosmosDbDatabaseName', 'value', reference(resourceId('Microsoft.Resources/deployments', format('cosmos{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.databaseName.value), createObject('name', 'CosmosDbContainerName', 'value', variables('uiChatContainerName')), createObject('name', 'MaxBatchSize', 'value', '10')))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "16950922224624613512"
            }
          },
          "parameters": {
            "appName": {
              "type": "string",
              "maxLength": 32
            },
            "managedEnvironmentName": {
              "type": "string"
            },
            "managedEnvironmentRg": {
              "type": "string"
            },
            "imageName": {
              "type": "string",
              "defaultValue": ""
            },
            "registryName": {
              "type": "string"
            },
            "userAssignedIdentityName": {
              "type": "string"
            },
            "workloadProfileName": {
              "type": "string"
            },
            "targetPort": {
              "type": "int",
              "defaultValue": 80,
              "metadata": {
                "description": "The target port for the container"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "deploymentSuffix": {
              "type": "string",
              "defaultValue": ""
            },
            "secrets": {
              "type": "secureObject",
              "defaultValue": {},
              "metadata": {
                "description": "The secrets required for the container, with the key being the secret name and the value being the key vault URL"
              }
            },
            "env": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "The environment variables for the container"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[parameters('appName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName')))]": {}
                }
              },
              "properties": {
                "managedEnvironmentId": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('managedEnvironmentRg')), 'Microsoft.App/managedEnvironments', parameters('managedEnvironmentName'))]",
                "configuration": {
                  "copy": [
                    {
                      "name": "secrets",
                      "count": "[length(items(parameters('secrets')))]",
                      "input": {
                        "name": "[items(parameters('secrets'))[copyIndex('secrets')].key]",
                        "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName'))]",
                        "keyVaultUrl": "[items(parameters('secrets'))[copyIndex('secrets')].value]"
                      }
                    }
                  ],
                  "ingress": {
                    "external": true,
                    "targetPort": "[parameters('targetPort')]",
                    "transport": "auto"
                  },
                  "registries": [
                    {
                      "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('userAssignedIdentityName'))]",
                      "server": "[format('{0}.azurecr.io', parameters('registryName'))]"
                    }
                  ]
                },
                "template": {
                  "containers": [
                    {
                      "name": "[parameters('workloadProfileName')]",
                      "image": "[coalesce(tryGet(tryGet(tryGet(tryGet(reference(resourceId('Microsoft.Resources/deployments', format('app-fetch-image-{0}{1}', parameters('appName'), parameters('deploymentSuffix'))), '2022-09-01').outputs, 'containers'), 'value'), 0), 'image'), 'mcr.microsoft.com/azuredocs/containerapps-helloworld:latest')]",
                      "env": "[parameters('env')]",
                      "resources": {
                        "cpu": "[json('0.5')]",
                        "memory": "1.0Gi"
                      },
                      "probes": [
                        {
                          "type": "Liveness",
                          "httpGet": {
                            "path": "/healthz/live",
                            "port": "[parameters('targetPort')]"
                          }
                        },
                        {
                          "type": "Readiness",
                          "httpGet": {
                            "path": "/healthz/ready",
                            "port": "[parameters('targetPort')]"
                          }
                        },
                        {
                          "type": "Startup",
                          "httpGet": {
                            "path": "/healthz/startup",
                            "port": "[parameters('targetPort')]"
                          }
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": 1,
                    "maxReplicas": 10
                  }
                },
                "workloadProfileName": "[parameters('workloadProfileName')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('app-fetch-image-{0}{1}', parameters('appName'), parameters('deploymentSuffix')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('app-fetch-image-{0}{1}', parameters('appName'), parameters('deploymentSuffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "exists": {
                    "value": false
                  },
                  "name": {
                    "value": "[parameters('imageName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "3738304863567409488"
                    }
                  },
                  "parameters": {
                    "exists": {
                      "type": "bool"
                    },
                    "name": {
                      "type": "string"
                    }
                  },
                  "resources": [],
                  "outputs": {
                    "containers": {
                      "type": "array",
                      "value": "[if(parameters('exists'), reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2023-05-02-preview').template.containers, createArray())]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/containerApps', parameters('appName'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('appName')]"
            },
            "fqdn": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('appName')), '2024-03-01').configuration.ingress.fqdn]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('all-dns-zones{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('secret-api-key{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('containerregistry{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('cosmos{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('secret-cosmos{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('doc-intelligence{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('secret-doc-intelligence{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('app-identity{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('law{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('caenv{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('openai{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('secret-openai{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('secret-search{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('search{0}', variables('deploymentSuffix')))]",
        "[resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix')))]"
      ]
    }
  ],
  "outputs": {
    "SUBSCRIPTION_ID": {
      "type": "string",
      "value": "[subscription().subscriptionId]"
    },
    "ACR_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('containerregistry{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
    },
    "ACR_URL": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('containerregistry{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.loginServer.value]"
    },
    "AI_ENDPOINT": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('openai{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.endpoint.value]"
    },
    "AI_HUB_ID": {
      "type": "string",
      "value": "[if(parameters('deployAIHub'), reference(resourceId('Microsoft.Resources/deployments', format('aiHub{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.id.value, '')]"
    },
    "AI_HUB_NAME": {
      "type": "string",
      "value": "[if(parameters('deployAIHub'), reference(resourceId('Microsoft.Resources/deployments', format('aiHub{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value, '')]"
    },
    "AI_PROJECT_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('resource-names{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.aiHubProjectName.value]"
    },
    "AI_SEARCH_ENDPOINT": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('search{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.endpoint.value]"
    },
    "API_CONTAINER_APP_FQDN": {
      "type": "string",
      "value": "[if(parameters('deployAPIApp'), reference(resourceId('Microsoft.Resources/deployments', format('ca-api-stub{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.fqdn.value, '')]"
    },
    "API_CONTAINER_APP_NAME": {
      "type": "string",
      "value": "[if(parameters('deployAPIApp'), reference(resourceId('Microsoft.Resources/deployments', format('ca-api-stub{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value, '')]"
    },
    "API_KEY": {
      "type": "string",
      "value": "[variables('apiKeyValue')]"
    },
    "AZURE_CONTAINER_ENVIRONMENT_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('caenv{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
    },
    "AZURE_CONTAINER_REGISTRY_ENDPOINT": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('containerregistry{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.loginServer.value]"
    },
    "AZURE_CONTAINER_REGISTRY_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('containerregistry{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
    },
    "AZURE_RESOURCE_GROUP": {
      "type": "string",
      "value": "[variables('resourceGroupName')]"
    },
    "COSMOS_CONTAINER_NAME": {
      "type": "string",
      "value": "[variables('uiChatContainerName')]"
    },
    "COSMOS_DATABASE_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('cosmos{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.databaseName.value]"
    },
    "COSMOS_ENDPOINT": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('cosmos{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.endpoint.value]"
    },
    "DOCUMENT_INTELLIGENCE_ENDPOINT": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('doc-intelligence{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.endpoint.value]"
    },
    "MANAGED_ENVIRONMENT_ID": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('caenv{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.id.value]"
    },
    "MANAGED_ENVIRONMENT_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('caenv{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
    },
    "RESOURCE_TOKEN": {
      "type": "string",
      "value": "[variables('resourceToken')]"
    },
    "STORAGE_ACCOUNT_BATCH_IN_CONTAINER": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.containerNames.value[1].name]"
    },
    "STORAGE_ACCOUNT_BATCH_OUT_CONTAINER": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.containerNames.value[2].name]"
    },
    "STORAGE_ACCOUNT_CONTAINER": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.containerNames.value[0].name]"
    },
    "STORAGE_ACCOUNT_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('storage{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.name.value]"
    },
    "VNET_CORE_ID": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('vnet{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.vnetResourceId.value]"
    },
    "VNET_CORE_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('vnet{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.vnetName.value]"
    },
    "VNET_CORE_PREFIX": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('vnet{0}', variables('deploymentSuffix'))), '2022-09-01').outputs.vnetAddressPrefix.value]"
    },
    "VM_ID": {
      "type": "string",
      "value": "[if(and(not(empty(parameters('admin_username'))), not(empty(parameters('vm_name')))), reference(resourceId('Microsoft.Resources/deployments', 'jumpboxVirtualMachineDeployment'), '2022-09-01').outputs.vm_id.value, '')]"
    },
    "VM_PRIVATE_IP": {
      "type": "string",
      "value": "[if(and(not(empty(parameters('admin_username'))), not(empty(parameters('vm_name')))), reference(resourceId('Microsoft.Resources/deployments', 'jumpboxVirtualMachineDeployment'), '2022-09-01').outputs.vm_private_ip.value, '')]"
    },
    "VM_PUBLIC_IP": {
      "type": "string",
      "value": "[if(and(not(empty(parameters('admin_username'))), not(empty(parameters('vm_name')))), reference(resourceId('Microsoft.Resources/deployments', 'jumpboxVirtualMachineDeployment'), '2022-09-01').outputs.vm_public_ip.value, '')]"
    }
  }
}